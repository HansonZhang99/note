<html>
<head>
  <title>1.简介</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="940"/>
<h1>1.简介</h1>

<div>
<span><div><span style="font-family: 宋体;">libevent库使用C语言编写，故使用此库需要一定c语言知识，同时，还需要了解和会使用C语言网络开发函数（socket,conect...)。</span></div><div><br/></div><div><br/></div><div><span style="font-family: 宋体; font-weight: bold;">异步阻塞io</span></div><div>       <span style="font-family: 宋体;"> 许多初学者往往都是使用阻塞式IO调用进行编程.当你调用一个同步IO的时候,除非操作系统已经完成了操作或者时间长到你的网络堆栈放弃的时候,否则系统是不会返回完成的.举个例子,当你调用&quot;connect&quot;做一个TCP连接的时候,你的操作系统必须排队处理来自发送到服务器的SYN包,除非等到SYN_ACK包从对面接收到,或者是超时,否则操作是不会返回给你的应用程序。</span></div><div><br/></div><div><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; font-size: 9pt; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">TCP</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; font-size: 9pt; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">三次握手</span></div><div><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; font-size: 9pt; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">  </span> <span style="font-size: 9pt; font-family: 宋体;">第一次握手:建立连接时,客户端发送syn包(syn=j)到服务器,并进入SYN_SENT状态,等待服务器确认;SYN:同步序列编号(Synchronize Sequence Numbers).第二次握手:服务器收到syn包,必须确认客户的SYN(ack=j+1),同时自己也发送一个SYN包(syn=k),即SYN+ACK包,此时服务器进入SYN_RECV状态;第三次握手:客户端收到服务器的SYN+ACK包,向服务器发送确认包ACK(ack=k+1),此包发送完毕,客户端和服务器进入ESTABLISHED(TCP连接成功)状态,完成三次握手.</span></div><div><span style="font-size: 9pt; font-family: 宋体;"><img src="1.简介_files/Image.png" type="image/png" data-filename="Image.png"/></span></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">这里有一个很简单的阻塞式网络调用的例子</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">它打开一个连接到<a href="https://www.baidu.com/" style="font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; color: rgb(0, 0, 0);">www.baidu.com</a></span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">发送它简单的</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">HTTP</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">请求</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">并打印输出到</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">stdout.</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 9pt;">/*  For sockaddr_in*/</font></div><div><font style="font-size: 9pt;">#include &lt;netinet/in.h&gt;</font></div><div><font style="font-size: 9pt;">/*  For socket functions*/</font></div><div><font style="font-size: 9pt;">#include &lt;sys/socket.h&gt;</font></div><div><font style="font-size: 9pt;">/*  For gethostbyname*/</font></div><div><font style="font-size: 9pt;">#include &lt;netdb.h&gt;</font></div><div><font style="font-size: 9pt;">#include &lt;unistd.h&gt;</font></div><div><font style="font-size: 9pt;">#include &lt;string.h&gt;</font></div><div><font style="font-size: 9pt;">#include &lt;stdio.h&gt;</font></div><div><font style="font-size: 9pt;">int main(int c, char** v)</font></div><div><font style="font-size: 9pt;">{</font></div><div><font style="font-size: 9pt;">    const char query[] =</font></div><div><font style="font-size: 9pt;">        &quot;GET / HTTP/1.0\r\n&quot;</font></div><div><font style="font-size: 9pt;">        &quot;Host: www.baidu.com\r\n&quot;</font></div><div><font style="font-size: 9pt;">        &quot;\r\n&quot;;</font></div><div><font style="font-size: 9pt;">   <font color="#FF0000"> const char hostname[] = &quot;www.baidu.com&quot;;//百度的域名</font></font></div><div><font style="font-size: 9pt;">    struct sockaddr_in sin;</font></div><div><font style="font-size: 9pt;">    struct hostent* h;</font></div><div><font style="font-size: 9pt;">    const char* cp;</font></div><div><font style="font-size: 9pt;">    int fd;</font></div><div><font style="font-size: 9pt;">    ssize_t n_written, remaining;</font></div><div><font style="font-size: 9pt;">    char buf[1024];</font></div><div><font style="font-size: 9pt;">    /*  Look up the IP address for the hostname. Watch out; this isn’t</font></div><div><font style="font-size: 9pt;">     *  threadsafe on most platforms.*/</font></div><div><font style="font-size: 9pt;">   <font color="#FF0000"> h = gethostbyname(hostname);//域名解析函数</font></font></div><div><font style="font-size: 9pt;">    if (!h) {</font></div><div><font style="font-size: 9pt;">        fprintf(stderr, &quot;Couldn’t lookup %s: %s&quot;, hostname,     hstrerror(h_errno));</font></div><div><font style="font-size: 9pt;">        return 1;</font></div><div><font style="font-size: 9pt;">    }</font></div><div><font style="font-size: 9pt;">    if (h-&gt;h_addrtype != AF_INET) {</font></div><div><font style="font-size: 9pt;">        fprintf(stderr, &quot;No ipv6 support, sorry.&quot;);</font></div><div><font style="font-size: 9pt;">        return 1;</font></div><div><font style="font-size: 9pt;">    }</font></div><div><font style="font-size: 9pt;">    /*  Allocate a new socket*/</font></div><div><font style="font-size: 9pt;">   <font color="#FF0000"> fd = socket(AF_INET, SOCK_STREAM, 0);</font></font></div><div><font style="font-size: 9pt;">    if (fd &lt; 0) {</font></div><div><font style="font-size: 9pt;">        perror(&quot;socket&quot;);</font></div><div><font style="font-size: 9pt;">        return 1;</font></div><div><font style="font-size: 9pt;">    }</font></div><div><font style="font-size: 9pt;">    /*  Connect to the remote host*/</font></div><div><font style="font-size: 9pt;">    <font color="#FF0000">sin.sin_family = AF_INET;//ipv4</font></font></div><div><font style="font-size: 9pt;">    <font color="#FF0000">sin.sin_port = htons(80);//http使用80端口</font></font></div><div><font style="font-size: 9pt;">   <font color="#FF0000"> sin.sin_addr = *(struct in_addr * )h-&gt;h_addr;//解析出百度的ip地址</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    if (connect(fd, (struct sockaddr * ) &amp;sin, sizeof(sin))) {</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">        perror(&quot;connect&quot;);</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">        close(fd);</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">        return 1;</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    }//建立连接</font></font></div><div><font style="font-size: 9pt;">    /*   Write the query.*/</font></div><div><font style="font-size: 9pt;">    /*  XXX Can send succeed partially?*/</font></div><div><font style="font-size: 9pt;">    cp = query;</font></div><div><font style="font-size: 9pt;">    remaining = strlen(query);</font></div><div><font style="font-size: 9pt;">    while (remaining) {</font></div><div><font style="font-size: 9pt;">       <font color="#FF0000"> n_written = send(fd, cp, remaining, 0);//发送网页请求到baidu服务器</font></font></div><div><font style="font-size: 9pt;">        if (n_written &lt;= 0) {</font></div><div><font style="font-size: 9pt;">            perror(&quot;send&quot;);</font></div><div><font style="font-size: 9pt;">            return 1;</font></div><div><font style="font-size: 9pt;">        }</font></div><div><font style="font-size: 9pt;">        remaining -= n_written;</font></div><div><font style="font-size: 9pt;">        cp += n_written;</font></div><div><font style="font-size: 9pt;">    }</font></div><div><font style="font-size: 9pt;">    /*  Get an answer back.*/</font></div><div><font style="font-size: 9pt;">    while (1) {</font></div><div><font style="font-size: 9pt;">      <font color="#FF0000">  ssize_t result = recv(fd, buf, sizeof(buf), 0);//接受服务器返回数据</font></font></div><div><font style="font-size: 9pt;">        if (result == 0) {</font></div><div><font style="font-size: 9pt;">            break;</font></div><div><font style="font-size: 9pt;">        } else if (result &lt; 0) {</font></div><div><font style="font-size: 9pt;">            perror(&quot;recv&quot;);</font></div><div><font style="font-size: 9pt;">            close(fd);</font></div><div><font style="font-size: 9pt;">            return 1;</font></div><div><font style="font-size: 9pt;">        }</font></div><div><font style="font-size: 9pt;">       <font color="#FF0000"> fwrite(buf, 1, result, stdout);//将数据答应到屏幕</font></font></div><div><font style="font-size: 9pt;">    }</font></div><div><font style="font-size: 9pt;">    close(fd);</font></div><div><font style="font-size: 9pt;">    return 0;</font></div><div><font style="font-size: 9pt;">}</font></div></div><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-family: 宋体;">以上看到的网络系统调用，均为阻塞调用，即调用没有获得获得结果时，就一直停在那里，不会返回。</span></span></div><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-family: 宋体;">调用gethostbyname的去解析www.baidu.com</span><span style="font-size: 9pt; font-family: 宋体;">的时候不等到它成功或者失败不会返回;调用connect的时候不等到它连接成功不会返回;调用recv的时候不等到它接受到数据或关连接关闭的时候不会返回;同样,调用send的时候至少等到待把输出区间待发送数据刷新到内核的写缓冲区之后才会返回.</span></span></div><div><span style="font-size: 9pt;"><br/></span></div><div><br/></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">现在看起来阻塞式</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">IO</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">还没有让人多厌烦</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">因为当你的程序在处理网络</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">IO</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">的同时不会处理其它业务</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">那么阻塞式</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">IO</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">能满足你的编程需求</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">但是想一下</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">当你想写一个程序支持多个连接</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">比如说需要同时从两个连接中读取数据</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">那么这个时候你就不知道到底先从哪个连接读取数据</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">.</span></font></div><div><br/></div><div><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">一个糟糕的例子</span></span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; font-size: 12pt; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 170); font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">:</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/* This won’t work.*/</div><div>char buf[1024];</div><div>int i, n;</div><div>while (i_still_want_to_read())</div><div>{</div><div>for (i=0; i&lt;n_sockets; ++i) {</div><div>n = recv(fd[i], buf, sizeof(buf), 0);</div><div>if (n==0)</div><div>handle_close(fd[i]);</div><div>else if (n&lt;0)</div><div>handle_error(fd[i], errno);</div><div>else</div><div>handle_input(fd[i], buf, n);</div><div>}</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div></div><div><br/></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">因为如果数据到达</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">fd[2]</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">首先</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">程序甚至不会尝试从</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">fd[2]</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">读取数据</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">直到读取</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">fd[0]</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">和</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">fd[1]</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">得到一些完成数据的读取。如果fd[0]和fd[1]的客户一直不发送数据，则fd[3]的数据永远也不能被服务端接收。</span></font></div><div><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word;"><br/></span></div><div><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word; font-family: 宋体;">有时候人们使用多线程或多进程服务来解决这个问题</span><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word; background-color: rgb(255, 255, 255); font-family: Calibri;">.</span><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word; background-color: rgb(255, 255, 255); font-family: 宋体;">最简单的方法就是让单独的每个进程或线程来处理它们各自的连接</span><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word; font-family: Calibri;">.</span><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word; font-family: 宋体;">由于每个连接都有自己的处理过程所以等待一个连接过程的阻塞</span><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word; background-color: rgb(255, 255, 255); font-family: Calibri;">IO</span><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word; font-family: 宋体;">方法的调用将不会影响到其它任何别的连接的处理过程</span><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word; font-family: Calibri;">.</span></div><div><span style="font-size: 9pt; outline: 0px; overflow-wrap: break-word;"><br/></span></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">这里有一个别的程序示例</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">.</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">这是一个很小的服务器</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">在端口</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">40713</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">上侦听</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">TCP</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">连接</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">每次一条一条地将数据读出来</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">当数据读出来的时候立刻进行</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">R13</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">加密</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">一条一条地写进输出缓冲区</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">在这个过程中它调用</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">Unix fork()</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">来创建一个新的过程来处理服务器接受到的连接</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">.</span></font></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 9pt;">* For sockaddr_in*/</font></div><div><font style="font-size: 9pt;">#include &lt;netinet/in.h&gt;</font></div><div><font style="font-size: 9pt;">/* For socket functions*/</font></div><div><font style="font-size: 9pt;">#include &lt;sys/socket.h&gt;</font></div><div><font style="font-size: 9pt;">#include &lt;unistd.h&gt;</font></div><div><font style="font-size: 9pt;">#include &lt;string.h&gt;</font></div><div><font style="font-size: 9pt;">#include &lt;stdio.h&gt;</font></div><div><font style="font-size: 9pt;">#include &lt;stdlib.h&gt;</font></div><div><font style="font-size: 9pt;">#define MAX_LINE 16384</font></div><div><font style="font-size: 9pt;"><br/></font></div><div><font style="font-size: 9pt;"><br/></font></div><div><font style="font-size: 9pt;">char rot13_char(char c)</font></div><div><font style="font-size: 9pt;">{</font></div><div><font style="font-size: 9pt;">    /* We don’t want to use isalpha here; setting the locale would</font></div><div><font style="font-size: 9pt;">change which characters are considered alphabetical.*/</font></div><div><font style="font-size: 9pt;">if ((c &gt;= ’a’ &amp;&amp; c &lt;= ’m’) || (c &gt;= ’A’ &amp;&amp; c &lt;= ’M’))</font></div><div><font style="font-size: 9pt;">return c + 13;</font></div><div><font style="font-size: 9pt;">else if ((c &gt;= ’n’ &amp;&amp; c &lt;= ’z’) || (c &gt;= ’N’ &amp;&amp; c &lt;= ’Z’))</font></div><div><font style="font-size: 9pt;">return c - 13;</font></div><div><font style="font-size: 9pt;">else</font></div><div><font style="font-size: 9pt;">return c;</font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;"><br/></font></div><div><font style="font-size: 9pt;"><br/></font></div><div><font style="font-size: 9pt;">void child(int fd)</font></div><div><font style="font-size: 9pt;">{</font></div><div><font style="font-size: 9pt;">char outbuf[MAX_LINE+1];</font></div><div><font style="font-size: 9pt;">size_t outbuf_used = 0;</font></div><div><font style="font-size: 9pt;">ssize_t result;</font></div><div><font style="font-size: 9pt;">while (1) {</font></div><div><font style="font-size: 9pt;">char ch;</font></div><div><font style="font-size: 9pt;">result = <font color="#FF0000">recv(fd, &amp;ch, 1, 0);</font></font></div><div><font style="font-size: 9pt;">if (result == 0) {</font></div><div><font style="font-size: 9pt;">break;</font></div><div><font style="font-size: 9pt;">} else if (result == -1) {</font></div><div><font style="font-size: 9pt;">perror(&quot;read&quot;);</font></div><div><font style="font-size: 9pt;">break;</font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;">/* We do this test to keep the user from overflowing the buffer.*/</font></div><div><font style="font-size: 9pt;">if (outbuf_used &lt; sizeof(outbuf)) {</font></div><div><font style="font-size: 9pt;"><font color="#FF0000">outbuf[outbuf_used++] = rot13_char(ch);</font></font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;">if (ch == ’\n’) {</font></div><div><font style="font-size: 9pt;"><font color="#FF0000">send(fd, outbuf, outbuf_used, 0);</font></font></div><div><font style="font-size: 9pt;">outbuf_used = 0;</font></div><div><font style="font-size: 9pt;">continue;</font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;">//从客户端获取数据，并加密，遇到换行符就将加密数据发送回去</font></div><div><font style="font-size: 9pt;"><br/></font></div><div><font style="font-size: 9pt;">void run(void)</font></div><div><font style="font-size: 9pt;">{</font></div><div><font style="font-size: 9pt;">int listener;</font></div><div><font style="font-size: 9pt;">struct sockaddr_in sin;</font></div><div><font style="font-size: 9pt;"><font color="#FF0000">sin.sin_family = AF_INET;</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">sin.sin_addr.s_addr = 0;</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">sin.sin_port = htons(40713);//监听本机所有ip地址的40713端口</font></font></div><div><font style="font-size: 9pt;">listener = <font color="#FF0000">socket(AF_INET, SOCK_STREAM, 0);</font></font></div><div><font style="font-size: 9pt;">#ifndef WIN32</font></div><div><font style="font-size: 9pt;">{</font></div><div><font style="font-size: 9pt;">    int one = 1;</font></div><div><font style="font-size: 9pt;">    setsockopt(listener, SOL_SOCKET, SO_REUSEADDR, &amp;one,    </font></div><div><font style="font-size: 9pt;">    sizeof(one));</font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;">#endif</font></div><div><font style="font-size: 9pt;">    if (<font color="#FF0000">bind(listener, (struct sockaddr * )&amp;sin, sizeof(sin))</font> &lt; 0) {</font></div><div><font style="font-size: 9pt;">    perror(&quot;bind&quot;);</font></div><div><font style="font-size: 9pt;">    return;</font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;">if (<font color="#FF0000">listen(listener, 16)</font>&lt;0)</font></div><div><font style="font-size: 9pt;">{</font></div><div><font style="font-size: 9pt;">    perror(&quot;listen&quot;);</font></div><div><font style="font-size: 9pt;">    return;</font></div><div><font style="font-size: 9pt;">}</font></div><div><font style="font-size: 9pt;"><font color="#FF0000">while (1)</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">{</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    struct sockaddr_storage ss;</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    socklen_t slen = sizeof(ss);</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    int fd = accept(listener, (struct sockaddr * )&amp;ss, &amp;slen);</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    if (fd &lt; 0)</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    {</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">        perror(&quot;accept&quot;);</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    }</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    else</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    {</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">        if (fork() == 0)</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">        {</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">            child(fd);</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">            exit(0);</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">        }</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">    }</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">}</font></font></div><div><font style="font-size: 9pt;"><font color="#FF0000">}//循环处理，每接受一个客户端的连接，开辟一个子进程，并在子进程中处理此客户的连接</font></font></div><div><font style="font-size: 9pt;">int main(int c, char** v)</font></div><div><font style="font-size: 9pt;">{</font></div><div><font style="font-size: 9pt;">run();</font></div><div><font style="font-size: 9pt;">return 0;</font></div><div><font style="font-size: 9pt;">}</font></div></div><div><br/></div><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-family: 宋体;">那么,我们有了一个完美的解决方案来处理多个即时连接？不完全是.首先,进程创建(甚至线程创建)的代价在一些平台上可能会非常昂贵.在实际中,你可能更想使用一个线程池,而不是创建新的进程.但更重要的是,线程在规模上并不尽如人意.如果您的程序同事需要处理成千上万的连接,可能会效率极低因为cpu同时运行的线程只有屈指可数的几个.</span></span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-family: 宋体;">但是如果连多线程都不能解决多个连接中的问题的话,那么还有什么别的方法？在Unix编程中,你就需要将你的socket设置成为非阻塞模式.Unix的调用方法如下:</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>fcntl(fd, F_SETFL, O_NONBLOCK);</div></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">这里</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">fd</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">代表的是</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">socket</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">的文件描述符</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">.</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">一旦你设置</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">fd(</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">套接字</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">)</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">为非阻塞模式</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">从那以后</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">无论什么时候</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">你调用</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">fd</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">函数都将立即完成操作或返回表示</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">&quot;</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">现在我无法取得任何进展</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">再试一次</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">&quot;</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">的错误码</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">.</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">所以我们的两个套接字的例子可能会天真地写成下面的代码</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">:</span></font></div><div><br/></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">糟糕的例子</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">:</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">忙查询所有套接字</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 9pt;">/* This will work, but the performance will be unforgivably bad.*/</font></div><div><font style="font-size: 9pt;">int i, n;</font></div><div><font style="font-size: 9pt;">char buf[1024];</font></div><div><font style="font-size: 9pt;">for (i=0; i &lt; n_sockets; ++i)</font></div><div><font style="font-size: 9pt;">    fcntl(fd[i], F_SETFL, O_NONBLOCK);</font></div><div><font style="font-size: 9pt;">while (i_still_want_to_read())</font></div><div><font style="font-size: 9pt;">{</font></div><div><font style="font-size: 9pt;">    for (i=0; i &lt; n_sockets; ++i)</font></div><div><font style="font-size: 9pt;">    {</font></div><div><font style="font-size: 9pt;">        n = recv(fd[i], buf, sizeof(buf), 0);</font></div><div><font style="font-size: 9pt;">        if (n == 0)</font></div><div><font style="font-size: 9pt;">        {</font></div><div><font style="font-size: 9pt;">            handle_close(fd[i]);</font></div><div><font style="font-size: 9pt;">        }</font></div><div><font style="font-size: 9pt;">        else if (n &lt; 0)</font></div><div><font style="font-size: 9pt;">        {</font></div><div><font style="font-size: 9pt;">            if (errno == EAGAIN)</font></div><div><font style="font-size: 9pt;">            ;</font></div><div><font style="font-size: 9pt;">        /* The kernel didn’t have any data for us to read.*/</font></div><div><font style="font-size: 9pt;">            else handle_error(fd[i], errno);</font></div><div><font style="font-size: 9pt;">        }</font></div><div><font style="font-size: 9pt;">        else</font></div><div><font style="font-size: 9pt;">        {</font></div><div><font style="font-size: 9pt;">            handle_input(fd[i], buf, n);</font></div><div><font style="font-size: 9pt;">        }</font></div><div><font style="font-size: 9pt;">    }</font></div><div><font style="font-size: 9pt;">}</font></div></div><div><br/></div><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-family: 宋体;">现在我们正在使用非阻塞套接字,上面的代码会有效,但只有很少.性能将会很糟糕,有两个原因:首先,当任何连接中都没有数据的时候,该循环将继续,并且消耗完你的CPU;其次,如果你想处理一个或两个以上连接,无论有没有数据你都需要为每个连接调用系统内核.所以我们需要一种方法告诉内核:你必须等到其中一个socket已经准备好给我数据才通知我,并且告诉我是哪一个socket.解决这个问题人们常用的是select()方法.Select()方法的调用需要三套fd(数组),一个作为写,一个作为读,一个作为异常.该函数等待socket集合,并且修改这个集合以知道哪些socket可以使用了.</span></span></div><div><span style="font-size: 9pt;"><br/></span></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">示例</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">:</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">使用</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">select()</span></font></div><div><br/></div><div style="font-size: 9pt;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font>/* If you only have a couple dozen fds, this version won’t be awful*/</font></div><div><font>fd_set readset;//声明一个位数组1024位</font></div><div><font>int i, n;</font></div><div><font>char buf[1024];</font></div><div><font>while (i_still_want_to_read())</font></div><div><font>{</font></div><div><font>    int maxfd = -1;</font></div><div><font>    FD_ZERO(&amp;readset);//清空位数组</font></div><div><font>    /* Add all of the interesting fds to readset</font></div><div><font>    */</font></div><div><font>    for (i=0; i &lt; n_sockets; ++i)</font></div><div><font>    {</font></div><div><font>        if (fd[i]&gt;maxfd) maxfd = fd[i];</font></div><div><font>        FD_SET(fd[i], &amp;readset);</font></div><div><font>    }//加入文件描述符到位数组集合，并将最大文件描述符数值记下来，每次select返回位数组将被改变，每次返回处理结束都要重新设置位数组</font></div><div><font>    /* Wait until one or more fds are ready to read*/</font></div><div><font>    select(maxfd+1, &amp;readset, NULL, NULL, NULL);//select系统调用阻塞到这里</font></div><div><font>    /* Process all of the fds that are still set in readset*/</font></div><div><font>    for (i=0; i &lt; n_sockets; ++i)//当select返回时，位数组中只有发生响应的文件描述符对应位为1，其他位被设置为0</font></div><div><font>    {</font></div><div><font>        if (FD_ISSET(fd[i], &amp;readset))</font></div><div><font>        {//遍历所有被监听的文件描述符，并与发生响应的文件描述符对比</font></div><div><font>            n = recv(fd[i], buf, sizeof(buf), 0);//读取数据</font></div><div><font>            if (n == 0)</font></div><div><font>            {</font></div><div><font>                handle_close(fd[i]);//读取失败则关闭此文件描述符</font></div><div><font>            }</font></div><div><font>            else if (n &lt; 0)</font></div><div><font>            {</font></div><div><font>                if (errno == EAGAIN)</font></div><div><font>                ;</font></div><div><font>/* The kernel didn’t have any data for us to read.*/</font></div><div><font>                else</font></div><div><font>                handle_error(fd[i], errno);</font></div><div><font>            }</font></div><div><font>            else</font></div><div><font>            {</font></div><div><font>                handle_input(fd[i], buf, n);</font></div><div><font>            }</font></div><div><font>        }</font></div><div><font>    }</font></div></div></div><div><font style="font-size: 9pt;"><br/></font></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">示例</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">:</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">基于</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">select()</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">的</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">ROT13</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">服务器</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font><font style="font-size: 9pt;">/* For sockaddr_in*/</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;netinet/in.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">/* For socket functions*/</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;sys/socket.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">/* For fcntl*/</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;fcntl.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">/* for select*/</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;sys/select.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;assert.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;unistd.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;string.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;stdlib.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;stdio.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">#include &lt;errno.h&gt;</font></font></div><div><font><font style="font-size: 9pt;">#define MAX_LINE 16384</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">char rot13_char(char c)</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    /* We don’t want to use isalpha here; setting the locale</font></font></div><div><font><font style="font-size: 9pt;">    change which characters are considered alphabetical.*/</font></font></div><div><font><font style="font-size: 9pt;">    if ((c &gt;= ’a’ &amp;&amp; c &lt;= ’m’) || (c &gt;= ’A’ &amp;&amp; c &lt;= ’M’))</font></font></div><div><font><font style="font-size: 9pt;">    return c + 13;</font></font></div><div><font><font style="font-size: 9pt;">    else if ((c &gt;= ’n’ &amp;&amp; c &lt;= ’z’) || (c &gt;= ’N’ &amp;&amp; c &lt;= ’Z’))</font></font></div><div><font><font style="font-size: 9pt;">    return c - 13;</font></font></div><div><font><font style="font-size: 9pt;">    else</font></font></div><div><font><font style="font-size: 9pt;">    return c;</font></font></div><div><font><font style="font-size: 9pt;">}</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">struct fd_state</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    char buffer[MAX_LINE];</font></font></div><div><font><font style="font-size: 9pt;">    size_t buffer_used;</font></font></div><div><font><font style="font-size: 9pt;">    int writing;</font></font></div><div><font><font style="font-size: 9pt;">    size_t n_written;</font></font></div><div><font><font style="font-size: 9pt;">    size_t write_upto;</font></font></div><div><font><font style="font-size: 9pt;">};</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">struct fd_state*alloc_fd_state(void)</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    struct fd_state</font></font></div><div><font><font style="font-size: 9pt;">    * state = malloc(sizeof(struct fd_state));</font></font></div><div><font><font style="font-size: 9pt;">    if (!state)</font></font></div><div><font><font style="font-size: 9pt;">    return NULL;</font></font></div><div><font><font style="font-size: 9pt;">    state-&gt;buffer_used = state-&gt;n_written = state-&gt;writing =</font></font></div><div><font><font style="font-size: 9pt;">    state-&gt;write_upto = 0;</font></font></div><div><font><font style="font-size: 9pt;">    return state;</font></font></div><div><font><font style="font-size: 9pt;">}</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">void free_fd_state(struct fd_state* state)</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    free(state);</font></font></div><div><font><font style="font-size: 9pt;">}</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">void make_nonblocking(int fd)</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    fcntl(fd, F_SETFL, O_NONBLOCK);</font></font></div><div><font><font style="font-size: 9pt;">}</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">int do_read(int fd, struct fd_state* state)</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    char buf[1024];</font></font></div><div><font><font style="font-size: 9pt;">    int i;</font></font></div><div><font><font style="font-size: 9pt;">    ssize_t result;</font></font></div><div><font><font style="font-size: 9pt;">    while (1)</font></font></div><div><font><font style="font-size: 9pt;">    {</font></font></div><div><font><font style="font-size: 9pt;">        <font color="#FF0000">result = recv(fd, buf, sizeof(buf), 0);//收取数据</font></font></font></div><div><font><font style="font-size: 9pt;">        if (result &lt;= 0)</font></font></div><div><font><font style="font-size: 9pt;">        break;</font></font></div><div><font><font style="font-size: 9pt;">        for (i=0; i &lt; result; ++i)</font></font></div><div><font><font style="font-size: 9pt;">        {</font></font></div><div><font><font style="font-size: 9pt;">            if (state-&gt;buffer_used &lt; sizeof(state-&gt;buffer))</font></font></div><div><font><font style="font-size: 9pt;">            <font color="#FF0000">state-&gt;buffer[state-&gt;buffer_used++] = rot13_char(buf[i]);//加密数据并保存到state-&gt;buffer</font></font></font></div><div><font><font style="font-size: 9pt;">            if (buf[i] == ’\n’)</font></font></div><div><font><font style="font-size: 9pt;">            {</font></font></div><div><font><font style="font-size: 9pt;">                <font color="#FF0000">state-&gt;writing = 1;//遇到换行符结束读取</font></font></font></div><div><font><font style="font-size: 9pt;">               <font color="#FF0000"> state-&gt;write_upto = state-&gt;buffer_used;</font></font></font></div><div><font><font style="font-size: 9pt;">            }</font></font></div><div><font><font style="font-size: 9pt;">        }</font></font></div><div><font><font style="font-size: 9pt;">    }</font></font></div><div><font><font style="font-size: 9pt;">    if (result == 0)</font></font></div><div><font><font style="font-size: 9pt;">    {</font></font></div><div><font><font style="font-size: 9pt;">        return 1;</font></font></div><div><font><font style="font-size: 9pt;">    }</font></font></div><div><font><font style="font-size: 9pt;">    else if (result &lt; 0)</font></font></div><div><font><font style="font-size: 9pt;">    {</font></font></div><div><font><font style="font-size: 9pt;">        if (errno == EAGAIN)</font></font></div><div><font><font style="font-size: 9pt;">            return 0;</font></font></div><div><font><font style="font-size: 9pt;">        return -1;</font></font></div><div><font><font style="font-size: 9pt;">    }</font></font></div><div><font><font style="font-size: 9pt;">    return 0;</font></font></div><div><font><font style="font-size: 9pt;">}</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">int do_write(int fd, struct fd_state * state)</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    while (state-&gt;n_written &lt; state-&gt;write_upto)</font></font></div><div><font><font style="font-size: 9pt;">    {</font></font></div><div><font><font style="font-size: 9pt;">        <font color="#FF0000">ssize_t result = send(fd, state-&gt;buffer + state-&gt;n_written,</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">        state-&gt;write_upto - state-&gt;n_written, 0);</font></font></font></div><div><font><font style="font-size: 9pt;">        if (result &lt; 0)</font></font></div><div><font><font style="font-size: 9pt;">        {</font></font></div><div><font><font style="font-size: 9pt;">            if (errno == EAGAIN)</font></font></div><div><font><font style="font-size: 9pt;">                return 0;</font></font></div><div><font><font style="font-size: 9pt;">            return -1;</font></font></div><div><font><font style="font-size: 9pt;">        }</font></font></div><div><font><font style="font-size: 9pt;">        assert(result != 0);</font></font></div><div><font><font style="font-size: 9pt;">        state-&gt;n_written += result;</font></font></div><div><font><font style="font-size: 9pt;">    }</font></font></div><div><font><font style="font-size: 9pt;">    if (state-&gt;n_written == state-&gt;buffer_used)</font></font></div><div><font><font style="font-size: 9pt;">    state-&gt;n_written = state-&gt;write_upto = state-&gt;buffer_used = 0;</font></font></div><div><font><font style="font-size: 9pt;">   <font color="#FF0000"> state-&gt;writing = 0;//重置</font></font></font></div><div><font><font style="font-size: 9pt;">    return 0;</font></font></div><div><font><font style="font-size: 9pt;">}</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">void run(void)</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    int listener;</font></font></div><div><font><font style="font-size: 9pt;">  <font color="#FF0000">  struct fd_state * state[FD_SETSIZE];</font></font></font></div><div><font><font style="font-size: 9pt;">    struct sockaddr_in sin;</font></font></div><div><font><font style="font-size: 9pt;">    int i, maxfd;</font></font></div><div><font><font style="font-size: 9pt;">    <font color="#FF0000">fd_set readset, writeset, exset;//设置三个位数组分别用来监听读写和退出</font></font></font></div><div><font><font style="font-size: 9pt;">    sin.sin_family = AF_INET;</font></font></div><div><font><font style="font-size: 9pt;">    sin.sin_addr.s_addr = 0;</font></font></div><div><font><font style="font-size: 9pt;">    sin.sin_port = htons(40713);</font></font></div><div><font><font style="font-size: 9pt;">   <font color="#FF0000"> for (i = 0; i &lt; FD_SETSIZE; ++i)</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">    state[i] = NULL;//初始化结构</font></font></font></div><div><font><font style="font-size: 9pt;">    listener = socket(AF_INET, SOCK_STREAM, 0);</font></font></div><div><font><font style="font-size: 9pt;">   <font color="#FF0000"> make_nonblocking(listener);</font></font></font></div><div><font><font style="font-size: 9pt;">#ifndef WIN32</font></font></div><div><font><font style="font-size: 9pt;">    {</font></font></div><div><font><font style="font-size: 9pt;">        int one = 1;</font></font></div><div><font><font style="font-size: 9pt;">        setsockopt(listener, SOL_SOCKET, SO_REUSEADDR, &amp;one, sizeof(one));</font></font></div><div><font><font style="font-size: 9pt;">    }</font></font></div><div><font><font style="font-size: 9pt;">#endif</font></font></div><div><font><font style="font-size: 9pt;">    if (bind(listener, (struct sockaddr * )&amp;sin, sizeof(sin)) &lt; 0) {</font></font></div><div><font><font style="font-size: 9pt;">        perror(&quot;bind&quot;);</font></font></div><div><font><font style="font-size: 9pt;">        return;</font></font></div><div><font><font style="font-size: 9pt;">    }</font></font></div><div><font><font style="font-size: 9pt;">    if (listen(listener, 16)&lt;0)</font></font></div><div><font><font style="font-size: 9pt;">    {</font></font></div><div><font><font style="font-size: 9pt;">        perror(&quot;listen&quot;);</font></font></div><div><font><font style="font-size: 9pt;">        return;</font></font></div><div><font><font style="font-size: 9pt;">    }</font></font></div><div><font><font style="font-size: 9pt;">    <font color="#FF0000">FD_ZERO(&amp;readset);</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">    FD_ZERO(&amp;writeset);</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">    FD_ZERO(&amp;exset);//初始化三个位数组</font></font></font></div><div><font><font style="font-size: 9pt;">    while (1)</font></font></div><div><font><font style="font-size: 9pt;">    {</font></font></div><div><font><font style="font-size: 9pt;">        <font color="#FF0000">maxfd = listener;//第一次只监听listener</font></font></font></div><div><font><font style="font-size: 9pt;">    <font color="#FF0000">    FD_ZERO(&amp;readset);</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">        FD_ZERO(&amp;writeset);</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">        FD_ZERO(&amp;exset);//每次select返回都要重新设置位数组</font></font></font></div><div><font><font style="font-size: 9pt;">        <font color="#FF0000">FD_SET(listener, &amp;readset);//加入listener到可读位数组</font></font></font></div><div><font><font style="font-size: 9pt;">        for (i=0; i &lt; FD_SETSIZE; ++i)</font></font></div><div><font><font style="font-size: 9pt;">        {</font></font></div><div><font><font style="font-size: 9pt;">            if (state[i])</font></font></div><div><font><font style="font-size: 9pt;">            {</font></font></div><div><font><font style="font-size: 9pt;">                if (i &gt; maxfd)</font></font></div><div><font><font style="font-size: 9pt;">                maxfd = i;</font></font></div><div><font><font style="font-size: 9pt;">                FD_SET(i, &amp;readset);</font></font></div><div><font><font style="font-size: 9pt;">             <font color="#FF0000">   if (state[i]-&gt;writing)</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">                    {</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">                        FD_SET(i, &amp;writeset);</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">                    }</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">           </font><font color="#000000">    </font><font color="#FF0000"> }//每当有连接建立时，会为此连接分配内存，当此内存中的buffer收到数据遇到换行符时结束读取，并置writing域为1，执行此循环</font></font></font></div><div><font><font style="font-size: 9pt;">        }//循环查看结构体数组state元素，并加入相应到位数组</font></font></div><div><font><font style="font-size: 9pt;">        </font></font></div><div><font><font style="font-size: 9pt;">        <font color="#FF0000">if (select(maxfd+1, &amp;readset, &amp;writeset, &amp;exset, NULL) &lt; 0)//阻塞调用</font></font></font></div><div><font><font style="font-size: 9pt;">        {</font></font></div><div><font><font style="font-size: 9pt;">            perror(&quot;select&quot;);</font></font></div><div><font><font style="font-size: 9pt;">            return;</font></font></div><div><font><font style="font-size: 9pt;">        }<font color="#FF0000">//执行下面代表调用返回</font></font></font></div><div><font><font style="font-size: 9pt;">        if (FD_ISSET(listener, &amp;readset))</font></font></div><div><font><font style="font-size: 9pt;">        {<font color="#FF0000">//如果是listener发生可读响应，证明有新的连接到来</font></font></font></div><div><font><font style="font-size: 9pt;">            struct sockaddr_storage ss;</font></font></div><div><font><font style="font-size: 9pt;">            socklen_t slen = sizeof(ss);</font></font></div><div><font><font style="font-size: 9pt;">            <font color="#FF0000">int fd = accept(listener, (struct sockaddr * )&amp;ss, &amp;slen);//接受连接</font></font></font></div><div><font><font style="font-size: 9pt;">            if (fd &lt; 0)</font></font></div><div><font><font style="font-size: 9pt;">            {</font></font></div><div><font><font style="font-size: 9pt;">                perror(&quot;accept&quot;);</font></font></div><div><font><font style="font-size: 9pt;">            }</font></font></div><div><font><font style="font-size: 9pt;">            else if (fd &gt; FD_SETSIZE)</font></font></div><div><font><font style="font-size: 9pt;">            {</font></font></div><div><font><font style="font-size: 9pt;">                close(fd);</font></font></div><div><font><font style="font-size: 9pt;">            }</font></font></div><div><font><font style="font-size: 9pt;">            else</font></font></div><div><font><font style="font-size: 9pt;">            {</font></font></div><div><font><font style="font-size: 9pt;">                <font color="#FF0000">make_nonblocking(fd);//设置此连接为非阻塞</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">                state[fd] = alloc_fd_state();//根据其fd大小，为其在state中分配内存</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">                assert(state[fd]);/* 分配出错退出*/</font></font></font></div><div><font><font style="font-size: 9pt;">            }</font></font></div><div><font><font style="font-size: 9pt;">        }</font></font></div><div><font><font style="font-size: 9pt;">        for (i=0; i &lt; maxfd+1; ++i)</font></font></div><div><font><font style="font-size: 9pt;">        {<font color="#FF0000">//如果不是listener发生响应，则响应为客户端发来数据</font></font></font></div><div><font><font style="font-size: 9pt;">            int r = 0;</font></font></div><div><font><font style="font-size: 9pt;">           <font color="#FF0000"> if (i == listener)</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">            continue;//排除掉listener</font></font></font></div><div><font><font style="font-size: 9pt;">           <font color="#FF0000"> if (FD_ISSET(i, &amp;readset))</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">            {</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">                r = do_read(i, state[i]);</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">            }//如果发生响应的文件描述符为可读，就调用read函数</font></font></font></div><div><font><font style="font-size: 9pt;">            <font color="#FF0000">if (r == 0 &amp;&amp; FD_ISSET(i, &amp;writeset))</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">            {</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">                r = do_write(i, state[i]);</font></font></font></div><div><font><font style="font-size: 9pt;"><font color="#FF0000">            }//发送state-&gt;buffer已经加密的数据给客户</font></font></font></div><div><font><font style="font-size: 9pt;">        <font color="#FF0000">    if (r)</font></font></font></div><div><font><font style="font-size: 9pt;">            {//write成功后执行此条件，释放堆内存，并置原static数组响应元素为NULL</font></font></div><div><font><font style="font-size: 9pt;">                free_fd_state(state[i]);</font></font></div><div><font><font style="font-size: 9pt;">                state[i] = NULL;</font></font></div><div><font><font style="font-size: 9pt;">                close(i);</font></font></div><div><font><font style="font-size: 9pt;">            }</font></font></div><div><font><font style="font-size: 9pt;">        }</font></font></div><div><font><font style="font-size: 9pt;">    }</font></font></div><div><font><font style="font-size: 9pt;">}</font></font></div><div><font><font style="font-size: 9pt;"><br/></font></font></div><div><font><font style="font-size: 9pt;">int main(int c, char** v)</font></font></div><div><font><font style="font-size: 9pt;">{</font></font></div><div><font><font style="font-size: 9pt;">    setvbuf(stdout, NULL, _IONBF, 0);</font></font></div><div><font><font style="font-size: 9pt;">    run();</font></font></div><div><font><font style="font-size: 9pt;">    return 0;</font></font></div><div><font><font style="font-size: 9pt;">}</font></font></div></div><div style="font-size: 9pt;"><br/></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">这还没完</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">因为生成和读</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">select()</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">的二进制流花费的时间与需要的最大</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">fd</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">成正比</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">而当</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">socket</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">的数量非常大的时候</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">,select()</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">的花费将会更恐怖</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">.</span></font></div><div><span style="font-size: 9pt; font-family: 宋体;">不同的操作系统提供了不同的替代select()功能的函数,例如poll()、eopll()、kqueqe()、evports和/dev/poll.这些都比select()具有更好的性能,除了poll()之外增加一个套接字、删除一个套接字以及通知套接字已经为IO准备好了这些动作的时间花费都是O(1).</span></div><div><span style="font-size: 9pt; font-family: 宋体;">不幸的是,这些都没有一个有效的接口统一标准.<span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">Linux有eopll(),BSD(包含Darwin)有kqueue(),Solaris有evports和/dev/poll,除此之外这些操作系统没有别的接口了.所以如果你想要写一个可移植的高效异步处理应用程序,你需要用抽象的方法封装这些所有的接口,并且提供其中最有效的方法.而libevent就是干这件事的。</span></span></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">这些都是</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">LibEvent</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">的</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">API</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">最底层工作的</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;"><span style="font-size: 9pt; background-color: rgb(255, 255, 255); font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">API</span>,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">提供了可代替</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">select()</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">的各种方法的统一接口</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">在运行的计算机上使用可用的最有效的版本</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">.</span></font></div><div><br/></div><div><font style="font-size: 12pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 12pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">而libevent是什么呢？</span></span></font></div><div><br/></div><div><font style="font-size: 9pt;"><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">LibEvent</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">是用于编写高速可移植的非阻塞</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">IO</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">库</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">,</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">它的目标是</span><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 9pt; font-family: Calibri; font-variant-caps: normal; font-variant-ligatures: normal;">:</span></font></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">可移植性</span>:使用LibEvent编写的程序应该在LibEvent支持跨越的所有平台上工作,即使没有更好的方法来处理非阻塞式IO:LibEvent也应该支持一般的方法使程序可以运行在某些限制的环境中.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">速度</span>:LibEvent试图在每一个平台实现最快的非阻塞式IO,而不会引入太多的额外开销.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">可扩展性</span>:LibEvent设计为即使在成千上万的socket情况下也能良好工作.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">方便</span>:无论在什么情况下,用LibEvent来编写程序最自然的方式都应该是稳定可靠的.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">LibEvent由下列组件构成:</span></span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">evutil</span>:用于抽象出不同平台网络实现的通用功能.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">event and event_base</span>:libevent的核心,为各种平台特定的、基于事件的非阻塞 IO后端提供抽象 API,让程序可以知道套接字何时已经准备好,可以读或者写,并且处理基本的超时功能,检测 OS信号.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">bufferevent</span>:为 libevent基于事件的核心提供使用更方便的封装.除了通知程序套接字已经准备好读写之外,还让程序可以请求缓冲的读写操作,可以知道何时 IO已经真正发生.(bufferevent接口有多个后端,可以采用系统能够提供的更快的非阻塞 IO方式 ,如 Windows中的 IOCP)</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">evbuffer</span>:在 bufferevent层之下实现了缓冲功能,并且提供了方便有效的访问函数.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">evhttp</span>:一个简单的 HTTP客户端/服务器实现.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">evdns</span>:一个简单的 DNS客户端/服务器实现.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;"><span style="font-size: 9pt; font-family: 宋体; font-weight: bold;">evrpc</span>:一个简单的 RPC实现.</span></div><div><span style="font-size: 9pt;"><br/></span></div><div><span style="font-size: 9pt; font-family: 宋体;">接下来将看到使用libevent编程实现的</span><span style="font-size: 9pt; box-sizing: border-box; outline: 0px; overflow-wrap: break-word; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: 宋体; font-variant-caps: normal; font-variant-ligatures: normal;">高速可移植的非阻塞的服务器。</span></div><div><br/></div><div><span style="font-size: 11pt;"><br/></span></div></span>
</div></body></html> 
<html>
<head>
  <title>阿里云C-SDK上报温度到物联网平台</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="527"/>
<h1>阿里云C-SDK上报温度到物联网平台</h1>

<div>
<span><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#include &quot;dev_sign_api.h&quot;</div><div>#include &quot;mqtt_api.h&quot;</div><div>#include &lt;cJSON.h&gt;</div><div>#include &lt;stdio.h&gt;</div><div>#include &lt;sys/types.h&gt;</div><div>#include &lt;sys/stat.h&gt;</div><div>#include &lt;fcntl.h&gt;</div><div>#include &lt;unistd.h&gt;</div><div>#include &lt;stdlib.h&gt;</div><div>#include &lt;string.h&gt;</div><div>#include &lt;sys/time.h&gt;</div><div>//#include &lt;linux/input.h&gt;</div><div>#include &lt;dirent.h&gt;</div><div>#include &lt;pthread.h&gt;</div><div>#include &lt;errno.h&gt;</div><div>#include &lt;stdbool.h&gt;</div><div><br/></div><div><br/></div><div><br/></div><div>#define EV_PRESS 1</div><div>#define MAC_FILE &quot;macfile&quot;</div><div>#define PATH_1 &quot;/dev/input/event0&quot;</div><div>#define PATH_2 &quot;/sys/devices/w1 bus master/&quot;</div><div><br/></div><div><br/></div><div>char DEMO_PRODUCT_KEY[IOTX_PRODUCT_KEY_LEN + 1] = {0};</div><div>char DEMO_DEVICE_NAME[IOTX_DEVICE_NAME_LEN + 1] = {0};</div><div>char DEMO_DEVICE_SECRET[IOTX_DEVICE_SECRET_LEN + 1] = {0};</div><div><br/></div><div><br/></div><div>void *HAL_Malloc(uint32_t size);</div><div>void HAL_Free(void *ptr);</div><div>void HAL_Printf(const char *fmt, ...);</div><div>int HAL_GetProductKey(char product_key[IOTX_PRODUCT_KEY_LEN + 1]);</div><div>int HAL_GetDeviceName(char device_name[IOTX_DEVICE_NAME_LEN + 1]);</div><div>int HAL_GetDeviceSecret(char device_secret[IOTX_DEVICE_SECRET_LEN]);</div><div>uint64_t HAL_UptimeMs(void);</div><div>int HAL_Snprintf(char *str, const int len, const char *fmt, ...);</div><div><br/></div><div><br/></div><div>#define EXAMPLE_TRACE(fmt, ...)  \</div><div>    do { \</div><div>        HAL_Printf(&quot;%s|%03d :: &quot;, __func__, __LINE__); \</div><div>        HAL_Printf(fmt, ##__VA_ARGS__); \</div><div>        HAL_Printf(&quot;%s&quot;, &quot;\r\n&quot;); \</div><div>    } while(0)</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>void example_message_arrive(void *pcontext, void *pclient, iotx_mqtt_event_msg_pt msg)</div><div>{</div><div>    iotx_mqtt_topic_info_t     *topic_info = (iotx_mqtt_topic_info_pt) msg-&gt;msg;</div><div><br/></div><div><br/></div><div>    switch (msg-&gt;event_type) {</div><div>        case IOTX_MQTT_EVENT_PUBLISH_RECEIVED:</div><div>            /* print topic name and topic message */</div><div>            EXAMPLE_TRACE(&quot;Message Arrived:&quot;);</div><div>            EXAMPLE_TRACE(&quot;Topic  : %.*s&quot;, topic_info-&gt;topic_len, topic_info-&gt;ptopic);</div><div>            EXAMPLE_TRACE(&quot;Payload: %.*s&quot;, topic_info-&gt;payload_len, topic_info-&gt;payload);</div><div>            EXAMPLE_TRACE(&quot;\n&quot;);</div><div>            break;</div><div>        default:</div><div>            break;</div><div>    }</div><div>}</div><div><br/></div><div><br/></div><div>int example_subscribe(void *handle)</div><div>{</div><div>    int res = 0;</div><div>    const char *fmt = &quot;/sys/%s/%s/thing/event/property/post&quot;;</div><div>    char *topic = NULL;</div><div>    int topic_len = 0;</div><div><br/></div><div><br/></div><div>    topic_len = strlen(fmt) + strlen(DEMO_PRODUCT_KEY) + strlen(DEMO_DEVICE_NAME) + 1;</div><div>    topic = HAL_Malloc(topic_len);</div><div>    if (topic == NULL) {</div><div>        EXAMPLE_TRACE(&quot;memory not enough&quot;);</div><div>        return -1;</div><div>    }</div><div>    memset(topic, 0, topic_len);</div><div>    HAL_Snprintf(topic, topic_len, fmt, DEMO_PRODUCT_KEY, DEMO_DEVICE_NAME);</div><div><br/></div><div><br/></div><div>    res = IOT_MQTT_Subscribe(handle, topic, IOTX_MQTT_QOS0, example_message_arrive, NULL);</div><div>    if (res &lt; 0) {</div><div>        EXAMPLE_TRACE(&quot;subscribe failed&quot;);</div><div>        HAL_Free(topic);</div><div>        return -1;</div><div>    }</div><div><br/></div><div><br/></div><div>    HAL_Free(topic);</div><div>    return 0;</div><div>}</div><div><br/></div><div><br/></div><div>int get_mac(char mac[])</div><div>{</div><div>    if(!mac)</div><div>        return -1;</div><div>    int fd;</div><div>    char *ptr=&quot;ifconfig eth0 &gt; &quot;;</div><div>    char buf[1024]={0};</div><div>    snprintf(buf,1024,&quot;%s %s&quot;,ptr,MAC_FILE);</div><div>    int val=system(buf);</div><div>    if((fd=open(MAC_FILE,O_RDWR))&lt;0)</div><div>    {</div><div>        printf(&quot;open failure\n&quot;);</div><div>        return -1;</div><div>    }</div><div>    lseek(fd,0,SEEK_SET);</div><div>    int rv=read(fd,buf,sizeof(buf));</div><div>    if(rv&lt;0)</div><div>    {</div><div>        printf(&quot;read failure\n&quot;);</div><div>        return -1;</div><div>    }</div><div>    char *str=strstr(buf,&quot;HWaddr&quot;);</div><div>    if(!str)</div><div>    {</div><div>        printf(&quot;no mac address\n&quot;);</div><div>        return -1;</div><div>    }</div><div>    str+=6;</div><div>    while((*str)==' ')</div><div>        str++;</div><div>    memcpy(mac,str,17);</div><div>    mac[17]='\0';</div><div>    return 0;</div><div>}</div><div><br/></div><div><br/></div><div>int get_temperature(char ch_temp[16])</div><div>{</div><div>    int fd_temp;</div><div>    int result=0;</div><div>    float temp;</div><div>    DIR *dirp=NULL;</div><div>    char *ptr=NULL;</div><div>    struct dirent *direntp;</div><div>    char path[128]=PATH_2;</div><div>    char data[128]={0};</div><div>    if((dirp=opendir(PATH_2))==NULL)</div><div>    {</div><div>        printf(&quot;open %s failure\n&quot;,PATH_2);</div><div>        return -1;</div><div>    }</div><div>    while((direntp=readdir(dirp))!=NULL)</div><div>    {</div><div>        if(strstr(direntp-&gt;d_name,&quot;28-&quot;))</div><div>        {</div><div>            strcat(path,direntp-&gt;d_name);</div><div>            result=1;</div><div>        }</div><div>    }</div><div>    if(!result)</div><div>    {</div><div>        printf(&quot;can not find ds18b20 in %s \n&quot;,PATH_2);</div><div>        return -1;</div><div>    }</div><div>    strncat(path,&quot;/w1_slave&quot;,sizeof(path));</div><div>    if((fd_temp=open(path,O_RDONLY))&lt;0)</div><div>    {</div><div>        printf(&quot;open %s failure\n&quot;,path);</div><div>        return -1;</div><div>    }</div><div>    if(read(fd_temp,data,sizeof(data))&lt;0)</div><div>    {</div><div>        printf(&quot;read %s failure\n&quot;,path);</div><div>        return -1;</div><div>    }</div><div>    if((ptr=strstr(data,&quot;t=&quot;))!=NULL)</div><div>    {</div><div>        ptr+=2;</div><div>        if(!ptr)</div><div>        {</div><div>            printf(&quot;read temperature failure\n&quot;);</div><div>            return -1;</div><div>        }</div><div>        temp=atof(ptr)/1000;</div><div>        snprintf(ch_temp,16,&quot;%f&quot;,temp);</div><div>    }</div><div>    return 0;</div><div>}</div><div><br/></div><div>int example_publish(void *handle)</div><div>{</div><div>    int             res = 0;</div><div>    const char     *fmt = &quot;/sys/%s/%s/thing/event/property/post&quot;;</div><div>    char           *topic = NULL;</div><div>    int             topic_len = 0;</div><div>    char            mac[32]={0};</div><div>    char            temp_s[16];</div><div>    if(get_mac(mac)&lt;0)</div><div>    {</div><div>        return -1;</div><div>    }</div><div>    if(get_temperature(temp_s)&lt;0)</div><div>    {</div><div>        return -1;</div><div>    }</div><div>    double temp=atof(temp_s);</div><div><br/></div><div>    cJSON * root =  cJSON_CreateObject();</div><div>    cJSON * item =  cJSON_CreateObject();</div><div><br/></div><div>    cJSON_AddItemToObject(root,&quot;method&quot;,cJSON_CreateString(&quot;thing.service.property.set&quot;));</div><div>    cJSON_AddItemToObject(root,&quot;id&quot;,cJSON_CreateString(mac));</div><div>    cJSON_AddItemToObject(root,&quot;params&quot;,item);</div><div>    cJSON_AddItemToObject(item,&quot;CurrentTemperature&quot;,cJSON_CreateNumber(temp));</div><div>    cJSON_AddItemToObject(root,&quot;version&quot;,cJSON_CreateString(&quot;1.0.0&quot;));</div><div>    char           *payload = cJSON_Print(root);</div><div><br/></div><div>    topic_len = strlen(fmt) + strlen(DEMO_PRODUCT_KEY) + strlen(DEMO_DEVICE_NAME) + 1;</div><div>    topic = HAL_Malloc(topic_len);</div><div>    if (topic == NULL) {</div><div>        EXAMPLE_TRACE(&quot;memory not enough&quot;);</div><div>        return -1;</div><div>    }</div><div>    memset(topic, 0, topic_len);</div><div>    HAL_Snprintf(topic, topic_len, fmt, DEMO_PRODUCT_KEY, DEMO_DEVICE_NAME);</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>    res = IOT_MQTT_Publish_Simple(0, topic, IOTX_MQTT_QOS0, payload, strlen(payload));</div><div>    if (res &lt; 0) {</div><div>        EXAMPLE_TRACE(&quot;publish failed, res = %d&quot;, res);</div><div>        HAL_Free(topic);</div><div>        return -1;</div><div>    }</div><div><br/></div><div>    HAL_Free(topic);</div><div>    return 0;</div><div>}</div><div><br/></div><div>void example_event_handle(void *pcontext, void *pclient, iotx_mqtt_event_msg_pt msg)</div><div>{</div><div>    EXAMPLE_TRACE(&quot;msg-&gt;event_type : %d&quot;, msg-&gt;event_type);</div><div>}</div><div><br/></div><div><br/></div><div>int main(int argc, char *argv[])</div><div>{</div><div>    void                   *pclient = NULL;</div><div>    int                     res = 0;</div><div>    int                     loop_cnt = 0;</div><div>    iotx_mqtt_param_t       mqtt_params;</div><div><br/></div><div>    HAL_GetProductKey(DEMO_PRODUCT_KEY);</div><div>    HAL_GetDeviceName(DEMO_DEVICE_NAME);</div><div>    HAL_GetDeviceSecret(DEMO_DEVICE_SECRET);</div><div><br/></div><div>    EXAMPLE_TRACE(&quot;mqtt example&quot;);</div><div><br/></div><div>    memset(&amp;mqtt_params, 0x0, sizeof(mqtt_params));</div><div><br/></div><div>    mqtt_params.handle_event.h_fp = example_event_handle;</div><div><br/></div><div>    pclient = IOT_MQTT_Construct(&amp;mqtt_params);</div><div>    if (NULL == pclient) {</div><div>        EXAMPLE_TRACE(&quot;MQTT construct failed&quot;);</div><div>        return -1;</div><div>    }</div><div><br/></div><div>    while (1) {</div><div>        if (0 == loop_cnt % 20) {</div><div>            example_publish(pclient);</div><div>        }</div><div><br/></div><div>        IOT_MQTT_Yield(pclient, 200);</div><div><br/></div><div>        loop_cnt += 1;</div><div>    }</div><div><br/></div><div><br/></div><div>    return 0;</div><div>}</div></div><div><span style="font-size: 12pt;">附：交叉编译时，将文件tools/build-rules/_rules-top.mk中“CC=”处改为交叉编译器路径，在顶层目录执行make CC=交叉编译器路径 即可，同时，如果是编译在主机运行的可执行文件，直接在顶层目录make即可（即使修改了</span><span style="font-size: 12pt;">tools/build-rules/_rules-top.mk文件）</span></div><div><span style="font-size: 12pt;">另外，使用交叉编译器编译，可能会报错：</span></div><div><span style="font-size: 12pt;">cc1: warnings being treated as errors</span></div><div><span style="font-size: 12pt;">/home/zhanghang/zhanghang/c-sdk-v3.0.1/wrappers/os/ubuntu/HAL_OS_linux.c: In function 'HAL_Wifi_Get_IP':</span></div><div><span style="font-size: 12pt;">/home/zhanghang/zhanghang/c-sdk-v3.0.1/wrappers/os/ubuntu/HAL_OS_linux.c:333: error: dereferencing pointer '({anonymous})' does break strict-aliasing rules</span></div><div><span style="font-size: 12pt;">/home/zhanghang/zhanghang/c-sdk-v3.0.1/wrappers/os/ubuntu/HAL_OS_linux.c:333: note: initialized from here</span></div><div><span style="font-size: 12pt;">make[1]: *** [/home/zhanghang/zhanghang/c-sdk-v3.0.1/.O/wrappers/os/ubuntu/HAL_OS_linux.o] Error 1</span></div><div><span style="font-size: 12pt;">make: *** [sub-mods] Error 2</span></div><div><span style="font-size: 12pt;">此时，只需要进入到此文件，注释掉此函数即可。</span></div><div><span style="font-size: 12pt;"><br/></span></div></span>
</div></body></html> 
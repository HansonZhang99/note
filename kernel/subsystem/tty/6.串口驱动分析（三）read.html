<html>
<head>
  <title>6.串口驱动分析（三）read</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="654"/>
<h1>6.串口驱动分析（三）read</h1>

<div>
<span><div><div><span style="font-size: 12pt;">从tty_read函数开始：</span></div><div><span style="font-size: 12pt;">static ssize_t</span> <span style="font-size: 12pt; color: rgb(255, 0, 0);">tty_read</span><span style="font-size: 12pt;">(struct file *file, char __user *buf, size_t count,</span></div><div><span style="font-size: 12pt;">            loff_t *ppos)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;">    int i;</span></div><div><span style="font-size: 12pt;">    struct inode *inode = file-&gt;f_path.dentry-&gt;d_inode;</span></div><div><span style="font-size: 12pt;">    <span style="font-size: 12pt; color: rgb(255, 0, 0);">struct tty_struct *tty = file_tty(file);</span></span></div><div><span style="font-size: 12pt;">    struct tty_ldisc *ld;</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">    ld = tty_ldisc_ref_wait(tty);</span></div><div><span style="font-size: 12pt;">   <span style="font-size: 12pt; color: rgb(255, 0, 0);"> if (ld-&gt;ops-&gt;read)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">        i = (ld-&gt;ops-&gt;read)(tty, file, buf, count);</span></span></div><div><span style="font-size: 12pt;">    else</span></div><div><span style="font-size: 12pt;">        i = -EIO;</span></div><div><span style="font-size: 12pt;">    tty_ldisc_deref(ld);</span></div><div><span style="font-size: 12pt;">    if (i &gt; 0)</span></div><div><span style="font-size: 12pt;">        inode-&gt;i_atime = current_fs_time(inode-&gt;i_sb);</span></div><div><span style="font-size: 12pt;">    return i;</span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;">在之前的open操作中，file的private保存了tty_struct结构。在这里调用file_tty获取此tty_struct结构，然后转到线路规程tty-&gt;ldisc-&gt;ops-&gt;read函数即n_tty_read函数：</span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">static ssize_t</span> <span style="font-size: 12pt; color: rgb(255, 0, 0);">n_tty_read</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(struct tty_struct *tty, struct file *file,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">             unsigned char __user *buf, size_t nr)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char __user *b = buf;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    DECLARE_WAITQUEUE(wait, current);</span></span></div><div><span style="font-size: 12pt;"> <span style="font-size: 12pt; color: rgb(168, 168, 168);">   int c;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int minimum, time;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    ssize_t retval = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    ssize_t size;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    long timeout;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long flags;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int packet;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">do_it_again:</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    BUG_ON(!tty-&gt;read_buf);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    c = job_control(tty, file);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (c &lt; 0)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return c;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    minimum = time = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    timeout = MAX_SCHEDULE_TIMEOUT;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (!tty-&gt;icanon) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        time = (HZ / 10) * TIME_CHAR(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        minimum = MIN_CHAR(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (minimum) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (time)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                tty-&gt;minimum_to_wake = 1;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            else if (!waitqueue_active(&amp;tty-&gt;read_wait) ||</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                 (tty-&gt;minimum_to_wake &gt; minimum))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                tty-&gt;minimum_to_wake = minimum;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        } else {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            timeout = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (time) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                timeout = time;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                time = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            tty-&gt;minimum_to_wake = minimum = 1;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">       }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /*</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     *  Internal serialization of reads.</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (file-&gt;f_flags &amp; O_NONBLOCK) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (!mutex_trylock(&amp;tty-&gt;atomic_read_lock))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            return -EAGAIN;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    } else {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (mutex_lock_interruptible(&amp;tty-&gt;atomic_read_lock))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            return -ERESTARTSYS;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    packet = tty-&gt;packet;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">    <span style="font-size: 12pt; color: rgb(255, 0, 0);">add_wait_queue(&amp;tty-&gt;read_wait, &amp;wait);</span></span></div><div><span style="font-size: 12pt;">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">while (nr) </span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0); font-weight: bold;">{</span></span></div><div><span style="font-size: 12pt;">      <span style="font-size: 12pt; color: rgb(168, 168, 168);">  /* First test for status change. */</span></span></div><div><span style="font-size: 12pt;">        <span style="font-size: 12pt; color: rgb(168, 168, 168);">if (packet &amp;&amp; tty-&gt;link-&gt;ctrl_status) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            unsigned char cs;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (b != buf)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            spin_lock_irqsave(&amp;tty-&gt;link-&gt;ctrl_lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            cs = tty-&gt;link-&gt;ctrl_status;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            tty-&gt;link-&gt;ctrl_status = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            spin_unlock_irqrestore(&amp;tty-&gt;link-&gt;ctrl_lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (tty_put_user(tty, cs, b++)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                retval = -EFAULT;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                b--;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            nr--;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span><span style="font-size: 12pt;">/*packet为0，if不执行*/</span></span></div><div><span style="font-size: 12pt;">   <span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt;"> set_current_state(TASK_INTERRUPTIBLE);/*设置进程为可中断*/</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (((minimum - (b - buf)) &lt; tty-&gt;minimum_to_wake) &amp;&amp;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">          ((minimum - (b - buf)) &gt;= 1))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            tty-&gt;minimum_to_wake = (minimum - (b - buf));</span></span></div><hr/><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt;">if (!input_available_p(tty, 0))/*输入缓冲区无数据可读*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);"> </span><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (test_bit(TTY_OTHER_CLOSED, &amp;tty-&gt;flags)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                retval = -EIO;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (tty_hung_up_p(file))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (!timeout)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">           </span><span style="font-size: 12pt;"> if (file-&gt;f_flags &amp; O_NONBLOCK) {</span></span></div><div><span style="font-size: 12pt;">                retval = -EAGAIN;/*非阻塞立即返回*/</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (</span><span style="font-size: 12pt;">signal_pending(current)) {/*信号唤醒直接返回*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                retval = -ERESTARTSYS;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            /* FIXME: does n_tty_set_room need locking ? */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            n_tty_set_room(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            </span><span style="font-size: 12pt;">timeout = schedule_timeout(timeout);/*睡眠让出cpu时间*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            BUG_ON(!tty-&gt;read_buf);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            continue;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        __set_current_state(TASK_RUNNING);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        /* Deal with packet mode. */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (packet &amp;&amp; b == buf) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (tty_put_user(tty, TIOCPKT_DATA, b++)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                retval = -EFAULT;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                b--;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            nr--;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">       </span><span style="font-size: 12pt;"> if (tty-&gt;icanon &amp;&amp; !L_EXTPROC(tty)) {/*</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            /* N.B. avoid overrun if nr == 0 */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            </span><span style="font-size: 12pt;">while (nr &amp;&amp; tty-&gt;read_cnt) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                int eol;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                eol = test_and_clear_bit(tty-&gt;read_tail,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                        tty-&gt;read_flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">          </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">     </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> c = tty-&gt;read_buf[tty-&gt;read_tail];/*从tty-&gt;read_buf中取数据*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                spin_lock_irqsave(&amp;tty-&gt;read_lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">         </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">      </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> tty-&gt;read_tail = ((tty-&gt;read_tail+1) &amp;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">                          (N_TTY_BUF_SIZE-1));/*移动tail指针*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">         </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">       tty-&gt;read_cnt--;/*数组中已有数据减一*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (eol) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    /* this test should be redundant:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                     * we shouldn't be reading data if</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                     * canon_data is 0</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                     */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    if (--tty-&gt;canon_data &lt; 0)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                        tty-&gt;canon_data = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                spin_unlock_irqrestore(&amp;tty-&gt;read_lock, flags);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (!eol || (c != __DISABLED_CHAR)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                   </span><span style="font-size: 12pt;"> if (</span><span style="font-size: 12pt;">tty_put_user(tty, c, b++)</span><span style="font-size: 12pt;">) {/*返回数据到用户空间*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                        retval = -EFAULT;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                        b--;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                        break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    nr--;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (eol) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    tty_audit_push(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">      </span><span style="font-size: 12pt;">      }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (retval)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">      </span><span style="font-size: 12pt;">  }</span> <span style="font-size: 12pt;">else {/*非标准模式*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            int uncopied;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            /* The copy function takes the read lock and handles</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">               locking internally for this case */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            uncopied =</span> <span style="font-size: 12pt;">copy_from_read_buf(tty, &amp;b, &amp;nr);/*返回数据到用户空间*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            uncopied += copy_from_read_buf(tty, &amp;b, &amp;nr);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (uncopied) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                retval = -EFAULT;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt;">}</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (n_tty_chars_in_buffer(tty) &lt;= TTY_THRESHOLD_UNTHROTTLE) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            n_tty_set_room(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            check_unthrottle(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt;">if (b - buf &gt;= minimum)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (time)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            timeout = time;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">  </span><span style="font-size: 12pt; color: rgb(255, 0, 0); font-weight: bold;"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0); font-weight: bold;"> }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    mutex_unlock(&amp;tty-&gt;atomic_read_lock);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt;"> remove_wait_queue(&amp;tty-&gt;read_wait, &amp;wait);/*删除等待队列*/</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (!waitqueue_active(&amp;tty-&gt;read_wait))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tty-&gt;minimum_to_wake = minimum;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    __set_current_state(TASK_RUNNING);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    size = b - buf;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (size) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        retval = size;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (nr)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            clear_bit(TTY_PUSH, &amp;tty-&gt;flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    } else if (test_and_clear_bit(TTY_PUSH, &amp;tty-&gt;flags))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">         goto do_it_again;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    n_tty_set_room(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return retval;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></span></div><hr/><div><span style="font-size: 12pt;">函数n_tty_read利用等待队列，等待队列被唤醒就进入到while循环，将数据以对应的模式发送至用户空间。至于等待队列核何时被唤醒，我们注意到open函数最终调用</span><span style="font-size: 12pt;">s3c24xx_serial_startup函数，该函数申请了两个中断rx_irq和tx_irq，其中rx_irq对应中断处理函数为</span><span style="font-size: 12pt;">s3c24xx_serial_rx_chars，现在看到这个函数：</span></div><div><span style="font-size: 12pt;">static irqreturn_t</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">s3c24xx_serial_rx_chars</span>(int irq, void *dev_id)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct s3c24xx_uart_port *ourport = dev_id;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct uart_port *port = &amp;ourport-&gt;port;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_struct *tty = port-&gt;state-&gt;port.tty;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned int ufcon, ch, flag, ufstat, uerstat;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int max_count = 64;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    while (max_count-- &gt; 0) </span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt;">ufcon = rd_regl(port, S3C2410_UFCON);</span></span></div><div><span style="font-size: 12pt;">        ufstat = rd_regl(port, S3C2410_UFSTAT);</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (s3c24xx_serial_rx_fifocnt(ourport, ufstat) == 0)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">       </span><span style="font-size: 12pt;"> uerstat = rd_regl(port, S3C2410_UERSTAT);</span></span></div><div><span style="font-size: 12pt;">        ch = rd_regb(port, S3C2410_URXH);</span></div><div><span style="font-size: 12pt;">        </span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (port-&gt;flags &amp; UPF_CONS_FLOW) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            int txe = s3c24xx_serial_txempty_nofifo(port);</span></span></div><div><span style="font-size: 12pt;">            flag=......</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">......    </span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">uart_insert_char(port, uerstat, S3C2410_UERSTAT_OVERRUN,</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">                 ch, flag);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">ignore_char:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        continue;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">   </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);"> }</span></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">  </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">tty_flip_buffer_push(tty);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">out:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return IRQ_HANDLED;</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;">这里我重写了一下，理了一下思路：</span></div><hr/><div><span style="font-size: 12pt;">看到tty_struct结构：</span></div><div><span style="font-size: 12pt;">struct tty_struct {</span></div><div><span style="font-size: 12pt;"> </span><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt;">int magic;/*TTY_MAGIC*/</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct kref kref;</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">struct device *dev;/*driver-&gt;dev*/</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">struct tty_driver *driver;/*driver*/</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">   const struct tty_operations *ops;/*driver-&gt;ops*/</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    int index;</span></span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Protects ldisc changes: Lock tty not pty */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct mutex ldisc_mutex;</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> struct tty_ldisc *ldisc;/*n_tty_ops*/</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct mutex termios_mutex;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spinlock_t ctrl_lock;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Termios values are protected by the termios mutex */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct ktermios *termios, *termios_locked;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct termiox *termiox;    /* May be NULL for unsupported */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    char name[64];</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct pid *pgrp;       /* Protected by ctrl lock */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct pid *session;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long flags;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int count;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct winsize winsize;     /* termios mutex */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char stopped:1, hw_stopped:1, flow_stopped:1, packet:1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char low_latency:1, warned:1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char ctrl_status;  /* ctrl_lock */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned int receive_room;  /* Bytes free for queue */</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_struct *link;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct fasync_struct *fasync;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> struct tty_bufhead buf;     /* Locked internally */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int alt_speed;      /* For magic substitution of 38400 bps */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    wait_queue_head_t write_wait;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    wait_queue_head_t read_wait;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct work_struct hangup_work;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    void *disc_data;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt;"> void *driver_data;/*uart_state*/</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct list_head tty_files;</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">#define N_TTY_BUF_SIZE 4096</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /*</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * The following is data for the N_TTY line discipline.  For</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * historical reasons, this is included in the tty structure.</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * Mostly locked by the BKL.</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">     */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned int column;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char lnext:1, erasing:1, raw:1, real_raw:1, icanon:1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char closing:1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char echo_overrun:1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned short minimum_to_wake;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long overrun_time;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int num_overrun;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long process_char_map[256/(8*sizeof(unsigned long))];</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">char *read_buf;</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    int read_head;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    int read_tail;</span></span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">  </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  int read_cnt;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);"> </span><span style="font-size: 12pt;">   unsigned long read_flags[N_TTY_BUF_SIZE/(8*sizeof(unsigned long))];</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char *echo_buf;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned int echo_pos;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned int echo_cnt;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int canon_data;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long canon_head;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned int canon_column;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct mutex atomic_read_lock;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct mutex atomic_write_lock;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct mutex output_lock;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct mutex echo_lock;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char *write_buf;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int write_cnt;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spinlock_t read_lock;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* If the tty has a pending do_SAK, queue it here - akpm */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct work_struct SAK_work;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_port *port;</span></div><div><span style="font-size: 12pt;">};</span></div><div><span style="font-size: 12pt;">和结构体tty_bufhead:</span></div><div><span style="font-size: 12pt;">struct tty_bufhead {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct work_struct work;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spinlock_t lock;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_buffer *head;    /* Queue head */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_buffer *tail;    /* Active buffer */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_buffer *free;    /* Free queue head */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int memory_used;        /* Buffer space used excluding</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">                                free queue */</span></div><div><span style="font-size: 12pt;">};</span></div><div><span style="font-size: 12pt;">在tty_open的tty_init_dev中的initialize_tty_struct函数中，第哦啊用tty_buffer_init函数对tty_struct的buf域进行初始化：</span></div><div><span style="font-size: 12pt;">void tty_buffer_init(struct tty_struct *tty)</span></div><div><span style="font-size: 12pt;">{   </span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_lock_init(&amp;tty-&gt;buf.lock);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    tty-&gt;buf.head = NULL;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    tty-&gt;buf.tail = NULL;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    tty-&gt;buf.free = NULL;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    tty-&gt;buf.memory_used = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    INIT_WORK(&amp;tty-&gt;buf.work, flush_to_ldisc);</span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;">结构tty_buffer：</span></div><div><span style="font-size: 12pt;">struct tty_buffer {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_buffer *next;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    char *char_buf_ptr;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned char *flag_buf_ptr;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int used;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int size;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int commit;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int read;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Data points here */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long data[0];</span></div><div><span style="font-size: 12pt;">};</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">在中断处理函数中的while循环中，调用了函数</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">uart_insert_char(port, uerstat, S3C2410_UERSTAT_OVERRUN,</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">ch, flag);进行数据追踪，循环执行64次（max_count控制）</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">数据从寄存器到变量：</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  ch = rd_regb(port, S3C2410_URXH);保存在ch变量中,并将标志放入到flag中。</span></div><div><span style="font-size: 12pt;">再调用函数：</span></div><div><span style="font-size: 12pt;">static inline void</span></div><div><span style="font-size: 12pt;">uart_insert_char(struct uart_port *port, unsigned int status,</span></div><div><span style="font-size: 12pt;">         unsigned int overrun, unsigned int ch, unsigned int flag)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">struct tty_struct *tty = port-&gt;state-&gt;port.tty;/*通过port找到tty结构*/</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if ((status &amp; port-&gt;ignore_status_mask &amp; ~overrun) == 0)</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">       </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> tty_insert_flip_char(tty, ch, flag);</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (status &amp; ~port-&gt;ignore_status_mask &amp; overrun)</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tty_insert_flip_char(tty, 0, TTY_OVERRUN);</span></div><div><span style="font-size: 12pt;">}   </span></div><div><span style="font-size: 12pt;">分析函数：</span></div><div><span style="font-size: 12pt;">static inline int tty_insert_flip_char(struct tty_struct *tty,</span></div><div><span style="font-size: 12pt;">                    unsigned char ch, char flag)</span></div><div><span style="font-size: 12pt;">{   </span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt;"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">struct tty_buffer *tb = tty-&gt;buf.tail;/*此域被初始化NULL在tty_open中*/</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (tb &amp;&amp; tb-&gt;used &lt; tb-&gt;size) {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tb-&gt;flag_buf_ptr[tb-&gt;used] = flag;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tb-&gt;char_buf_ptr[tb-&gt;used++] = ch;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return 1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">return tty_insert_flip_string_flags(tty, &amp;ch, &amp;flag, 1);</span></div><div><span style="font-size: 12pt;">}</span></div><div><br/></div><div><span style="font-size: 12pt;">函数</span></div><div><span style="font-size: 12pt;">int tty_insert_flip_string_flags(struct tty_struct *tty,</span></div><div><span style="font-size: 12pt;">        const unsigned char *chars, const char *flags, size_t size)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int copied = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    do {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        int goal = min_t(size_t, size - copied, TTY_BUFFER_PAGE);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">      </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  int space = tty_buffer_request_room(tty, goal);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        struct tty_buffer *tb = tty-&gt;buf.tail;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        /* If there is no space then tb may be NULL */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (unlikely(space == 0))</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">        memcpy(tb-&gt;char_buf_ptr + tb-&gt;used, chars, space);</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">        memcpy(tb-&gt;flag_buf_ptr + tb-&gt;used, flags, space);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">tb-&gt;used += space;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        copied += space;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        chars += space;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        flags += space;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        /* There is a small chance that we need to split the data ove</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">r</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">           several buffers. If this is the case we must loop */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    } while (unlikely(size &gt; copied));</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return copied;</span></div><div><span style="font-size: 12pt;">}     </span></div><div><span style="font-size: 12pt;">函数</span></div><div><span style="font-size: 12pt;">int tty_buffer_request_room(struct tty_struct *tty, size_t size)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_buffer *b, *n;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int left;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long flags;</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_lock_irqsave(&amp;tty-&gt;buf.lock, flags);</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* OPTIMISATION: We could keep a per tty &quot;zero&quot; sized buffer to</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">       remove this conditional if its worth it. This would be invisib</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">le</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">       to the callers */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if ((b = tty-&gt;buf.tail) != NULL)</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        left = b-&gt;size - b-&gt;used;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    else</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        left = 0;</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (left &lt; size) {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        /* This is the slow path - looking for new buffers to use */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if ((</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">n = tty_buffer_find(tty, size)</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">) != NULL) {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (b != NULL) {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">                b-&gt;next = n;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">                b-&gt;commit = b-&gt;used;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            } else</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">                </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">tty-&gt;buf.head = n;</span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">            tty-&gt;buf.tail = n;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        } else</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            size = left;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_unlock_irqrestore(&amp;tty-&gt;buf.lock, flags);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return size;</span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;">再到函数：</span></div><div><span style="font-size: 12pt;">static struct tty_buffer *tty_buffer_find(struct tty_struct *tty, siz</span></div><div><span style="font-size: 12pt;">e_t size)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">struct tty_buffer **tbh = &amp;tty-&gt;buf.free;/*tty_open中初始化为NULL*/</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    while ((*tbh) != NULL) {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        struct tty_buffer *t = *tbh;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (t-&gt;size &gt;= size) {</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            *tbh = t-&gt;next;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            t-&gt;next = NULL;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            t-&gt;used = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            t-&gt;commit = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            t-&gt;read = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            tty-&gt;buf.memory_used += t-&gt;size;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            return t;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tbh = &amp;((*tbh)-&gt;next);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Round the buffer size out */</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    size = (size + 0xFF) &amp; ~0xFF;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return</span> <span style="font-size: 12pt; color: rgb(255, 0, 0);">tty_buffer_alloc(tty, size);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Should possibly check if this fails for the largest buffer we</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">       have queued and recycle that ? */</span></div><div><span style="font-size: 12pt;">}</span></div><div><br/></div><div><span style="font-size: 12pt;">函数：</span></div><div><span style="font-size: 12pt;">static struct tty_buffer *tty_buffer_alloc(struct tty_struct *tty, si</span></div><div><span style="font-size: 12pt;">ze_t size)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_buffer *p;</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (tty-&gt;buf.memory_used + size &gt; 65536)</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return NULL;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    p = kmalloc(sizeof(struct tty_buffer) + 2 * size, GFP_ATOMIC);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (p == NULL)</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return NULL;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    p-&gt;used = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    p-&gt;size = size;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    p-&gt;next = NULL;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    p-&gt;commit = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">p-&gt;read = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    p-&gt;char_buf_ptr = (char *)(p-&gt;data);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    p-&gt;flag_buf_ptr = (unsigned char *)p-&gt;char_buf_ptr + size;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    tty-&gt;buf.memory_used += size;</span></span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return p;</span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;">kmalloc分配了</span><span style="font-size: 12pt;">sizeof(struct tty_buffer) + 2 * size大小的内存，此时结构体tty_struct占用一个，其他给了成员unsigned long data[0]，并将此段内存分配为两部分，char_buf_ptr和flag_buf_ptr。</span></div><div><span style="font-size: 12pt;">往上看，可以发现函数</span><span style="font-size: 12pt;">tty_buffer_request_room将此空间给了tty的buf的head和tail域。</span></div><div><span style="font-size: 12pt;">在函数</span><span style="font-size: 12pt;">tty_insert_flip_string_flags将第一组数据放入到tty-&gt;buf的char_buf_ptr和flag_buf_ptr中，并将buf-&gt;tail域的used加1。下一个数据到来，将会执行函数</span><span style="font-size: 12pt;">int tty_insert_flip_char的第一个条件语句块，直放入数据到</span><span style="font-size: 12pt;">char_buf_ptr和flag_buf_ptr。</span></div><hr/><div><span style="font-size: 12pt;">数据接收完毕，接下来是</span><span style="font-size: 12pt;">tty_flip_buffer_push函数：</span></div><div><span style="font-size: 12pt;">void tty_flip_buffer_push(struct tty_struct *tty)</span></div><div><span style="font-size: 12pt;">{           </span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long flags;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_lock_irqsave(&amp;tty-&gt;buf.lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">  </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">  if (tty-&gt;buf.tail != NULL)</span></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  </span></span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);"> tty-&gt;buf.tail-&gt;commit = tty-&gt;buf.tail-&gt;used;</span></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_unlock_irqrestore(&amp;tty-&gt;buf.lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                </span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (tty-&gt;low_latency)</span></span></div><div><span style="font-size: 12pt;">        flush_to_ldisc(&amp;tty-&gt;buf.work);</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    else</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        schedule_work(&amp;tty-&gt;buf.work);</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">static void flush_to_ldisc(struct work_struct *work)</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt;">struct tty_struct *tty =</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt;">        container_of(work, struct tty_struct, buf.work);/*获取到tty_struct结构*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long   flags;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_ldisc *disc;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt;">disc = tty_ldisc_ref(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (disc == NULL)   /*  !TTY_LDISC */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_lock_irqsave(&amp;tty-&gt;buf.lock, flags);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (!test_and_set_bit(TTY_FLUSHING, &amp;tty-&gt;flags)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        struct tty_buffer *head;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt;">while ((head = tty-&gt;buf.head) != NULL)</span> <span style="font-size: 12pt;">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            int count;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            char *char_buf;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            unsigned char *flag_buf;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">          </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">  count = head-&gt;commit - head-&gt;read;/*read域为0*/</span></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (!count) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (head-&gt;next == NULL)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                tty-&gt;buf.head = head-&gt;next;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                tty_buffer_free(tty, head);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                continue;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            /* Ldisc or user is trying to flush the buffers</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">               we are feeding to the ldisc, stop feeding the</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">               line discipline as we want to empty the queue */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (test_bit(TTY_FLUSHPENDING, &amp;tty-&gt;flags))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (!tty-&gt;receive_room)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (count &gt; tty-&gt;receive_room)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                count = tty-&gt;receive_room;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> char_buf = head-&gt;char_buf_ptr + head-&gt;read;</span></span><span style="font-size: 12pt; color: rgb(255, 0, 0);">/*指向</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">head-&gt;char_buf_ptr*/</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">          </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  flag_buf = head-&gt;flag_buf_ptr + head-&gt;read;/*指向</span></span><span style="font-size: 12pt; color: rgb(255, 0, 0);">head-&gt;flag_buf_ptr*/</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">           </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);"> head-&gt;read += count;</span></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            spin_unlock_irqrestore(&amp;tty-&gt;buf.lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">disc-&gt;ops-&gt;receive_buf(tty, char_buf,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">                            flag_buf, count);/*线路规程receive_buf函数*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            spin_lock_irqsave(&amp;tty-&gt;buf.lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        clear_bit(TTY_FLUSHING, &amp;tty-&gt;flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* We may have a deferred request to flush the input buffer,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">       if so pull the chain under the lock and empty the queue */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (test_bit(TTY_FLUSHPENDING, &amp;tty-&gt;flags)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        __tty_buffer_flush(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        clear_bit(TTY_FLUSHPENDING, &amp;tty-&gt;flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">wake_up(&amp;tty-&gt;read_wait);/*唤醒等待队列*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt;">}</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_unlock_irqrestore(&amp;tty-&gt;buf.lock, flags);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    tty_ldisc_deref(disc);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></span></div><div><span style="font-size: 12pt;">处理过程：</span></div><div><span style="font-size: 12pt;"><img src="6.串口驱动分析（三）read_files/Image.png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="6.串口驱动分析（三）read_files/Image [1].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;">当底层驱动接收到“一包”数据后，写入到tty_buffer,使用tty_buffer-&gt;data[used++]保存数据（</span><span style="font-size: 12pt;">uart_insert_char）</span><span style="font-size: 12pt;">，保存完毕后，调用</span><span style="font-size: 12pt;">tty_flip_buffer_push上报数据，此时使用user指针更新commit；向上层投递数据时，使用read指针（char_buf_ptr在</span><span style="font-size: 12pt;">tty_buffer_alloc函数中）</span><span style="font-size: 12pt;">投递数据，驱动不仅保存收到的每个字符，还会保存接受字符的状态，如帧错误，溢出等，当前字符与其状态之间的偏移地址size。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">针对每个tty_buffer,都会调用</span> <span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">tty_flip_buffer_push-&gt;receive_buf，并最终调用线路规程的ld-&gt;ops-&gt;receive_buf()--&gt;n_tty_receive_buf()进行数据处理。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">static void</span> <span style="font-size: 12pt;">n_tty_receive_buf</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(struct tty_struct *tty, const unsigned char *cp,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                  char *fp, int count)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    const unsigned char *p;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    char *f, flags = TTY_NORMAL;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int i;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    char    buf[64];</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long cpuflags;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">  </span><span style="font-size: 12pt;">  if (!tty-&gt;read_buf)/*n_tty_open为其开辟空间*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (tty-&gt;real_raw) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        spin_lock_irqsave(&amp;tty-&gt;read_lock, cpuflags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        i = min(N_TTY_BUF_SIZE - tty-&gt;read_cnt,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            N_TTY_BUF_SIZE - tty-&gt;read_head);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        i = min(count, i);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">memcpy(tty-&gt;read_buf + tty-&gt;read_head, cp, i);/*将char_buf中的数据复制到read_buf中*/</span></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tty-&gt;read_head = (tty-&gt;read_head + i) &amp; (N_TTY_BUF_SIZE-1);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">      </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">  tty-&gt;read_cnt += i;</span></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        cp += i;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        count -= i;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        i = min(N_TTY_BUF_SIZE - tty-&gt;read_cnt,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            N_TTY_BUF_SIZE - tty-&gt;read_head);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        i = min(count, i);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        memcpy(tty-&gt;read_buf + tty-&gt;read_head, cp, i);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tty-&gt;read_head = (tty-&gt;read_head + i) &amp; (N_TTY_BUF_SIZE-1);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tty-&gt;read_cnt += i;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        spin_unlock_irqrestore(&amp;tty-&gt;read_lock, cpuflags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    } else {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">for (i = count, p = cp, f = fp; i; i--, p++) {/*循环根据flag_buf中的flag,对read_buf中数据作相应的操作*/</span></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (f)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                flags = *f++;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            switch (flags) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            case TTY_NORMAL:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                n_tty_receive_char(tty, *p);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            case TTY_BREAK:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                n_tty_receive_break(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (f)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                flags = *f++;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            switch (flags) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            case TTY_NORMAL:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                n_tty_receive_char(tty, *p);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            case TTY_BREAK:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                n_tty_receive_break(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            case TTY_PARITY:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            case TTY_FRAME:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                n_tty_receive_parity_error(tty, *p);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            case TTY_OVERRUN:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                n_tty_receive_overrun(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            default:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                printk(KERN_ERR &quot;%s: unknown flag %d\n&quot;,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                       tty_name(tty, buf), flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (tty-&gt;ops-&gt;flush_chars)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            tty-&gt;ops-&gt;flush_chars(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    n_tty_set_room(tty);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if ((!tty-&gt;icanon &amp;&amp; (tty-&gt;read_cnt &gt;= tty-&gt;minimum_to_wake)) ||</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        L_EXTPROC(tty)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        kill_fasync(&amp;tty-&gt;fasync, SIGIO, POLL_IN);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (waitqueue_active(&amp;tty-&gt;read_wait))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            wake_up_interruptible(&amp;tty-&gt;read_wait);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /*</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * Check the remaining room for the input canonicalization</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * mode.  We don't want to throttle the driver if we're in</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * canonical mode and don't have a newline yet!</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (tty-&gt;receive_room &lt; TTY_THRESHOLD_THROTTLE)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        tty_throttle(tty);</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">函数</span><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">n_tty_receive_buf()最终将数据存放到tty_struct-&gt;read_buf[]中。</span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">在唤醒等待队列后,n_tty_read函数会从read_buf[]中取出数据。</span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></span></div><div><span style="font-size: 12pt;">给出比较完整的read过程图（大同小异）：</span></div><div><span style="font-size: 12pt;"><img src="6.串口驱动分析（三）read_files/Image [2].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="6.串口驱动分析（三）read_files/Image [3].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;">参考：</span></div><div><span style="font-size: 12pt;"><a href="http://www.wowotech.net/tty_framework/435.html" style="font-size: 12pt;">http://www.wowotech.net/tty_framework/435.html</a></span></div><div><a href="https://www.jianshu.com/p/3a9013b9569c" style="font-size: 12pt;">https://www.jianshu.com/p/3a9013b9569c</a></div><div><a href="https://blog.csdn.net/lushengchu_luis/article/details/9368031" style="font-size: 12pt;">https://blog.csdn.net/lushengchu_luis/article/details/9368031</a></div><div><a href="https://blog.csdn.net/lizuobin2/article/details/51773305" style="font-size: 12pt;">https://blog.csdn.net/lizuobin2/article/details/51773305</a></div></div><div><br/></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div></span>
</div></body></html> 
# s3c2440时钟

## 时钟源

时钟源的来源有两种，一种是外部晶振一种是外部时钟。

## 时钟信号

s3c2440的时钟信号有三种，分别是提供给CPU的FCLK，提供给AHB总线外设的HCLK，提供给APB总线外设的PCLK。s3c2440a包含两个锁相环，一个用于提供时钟给FCLK,HCLK,PCLK，一个用于提供时钟给USB模块(48MHZ)，时钟控制逻辑可以不使用PLL来适当减慢时钟，并且可由软件连接或断开个各个外设模块的时钟，降低功耗。

## 工作模式

s3c2440电源控制可以让其工作在四种模式，可以通过切换模式降低芯片功耗。四种模式分别是NORMAL，SLOW，IDLE，SLEEP。



时钟源的选择，通过芯片引脚的OM3和OM2组合，可以选择主时钟源和USB的时钟源。nRESET为上升沿时，将会参考OM3和OM2引脚的配置，将状态进行锁定

![image-20230424014025962](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014025962.png)

1. 虽然MPLL在复位后就开始，MPLL输出（Mpll）并没有作为系统时钟，直到软件写入有效值来设置MPLLCON 寄存器。在设置此值之前，是将外部晶振或外部时钟源提供的时钟直接作为系统时钟。即使用户不想改变 MPLLCON 寄存器的默认值，用户也应当写入与之相同的值到 MPLLCON 寄存器寄存器中。

2. OM[3:2]是用于当 OM[1:0]为 11 时决定一个测试模式

![image-20230424014035074](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014035074.png)

FCLK 是提供给 ARM920T 的时钟。 

HCLK 是提供给用于 ARM920T，存储器控制器，中断控制器，LCD 控制器，DMA 和 USB 主机模块的 AHB 总线的时钟。 

PCLK 是提供给用于外设如 WDT，IIS，I2C，PWM 定时器，MMC/SD 接口，ADC，UART，GPIO，RTC 和 SPI 的 APB 总线的时钟。



锁相环MPLL的时钟频率计算：

`MPLL = (2*m*Fin) /(p* 2^s)`

`m = M + 8`

`p = P + 2`

其中Fin为外部时钟源，p m s分别为可配置的值（如最上方的第三个红框）



时钟控制逻辑：时钟控制逻辑决定使用的时钟源，当使用MPLL时钟或直接使用外部时钟时，当配置了PLL为一个新的频率值，时钟控制逻辑首先会禁用FCLK，直至使用PLL锁定时间后使得PLL能稳定输出。

## 上电复位

![image-20230424014048700](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014048700.png)

上电复位顺序：

1.上电

2.根据OM[3:2]确定主时钟源（晶振或外部时钟），此时MPLL未配置，FCLK=主时钟源。

3.等待主时钟源发出时钟稳定后，释放nRESET，此时MPLL锁存之前OM[3:2]的主时钟源。

4.通过软件配置MPLL，进入LOCKTIME，等待配置完成，此时FCLK无输出，CPU停止。

5.配置完成，LOCKTIME时间到，FCLK输出按照新配置的频率（主时钟源经过MPLL设置后的频率），CPU运行。

NORMAL模式下改写PLL设置：

在 S3C2440A 运行在普通模式期间，用户可以通过改写 PMS 的值来改变频率，并且将自动插入 PLL 锁定时间。 在锁定时间期间，不提供时钟给 S3C2440A 的内部模块。

![image-20230424014101010](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014101010.png)

USB的时钟控制：

USB 主机接口和 USB 设备接口都需要 48MHz 的时钟。S3C2440A 中，USB 专用 PLL（UPLL）生成 48MHz 给 USB。在配置 PLL（UPLL）之前不提供 UCLK。

![image-20230424014122588](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014122588.png)

UCLK和FCLK差不多，但是复位上电后不提供UCLK，当UPLL配置后，在锁定期间的UCLk也是低电平，配置外UPLL也就是锁定时间后，UCLK为48MHZ



S3C2440A 支持对 FCLK、HCLK 和 PCLK 之间分频比例的选择。该比例由 CLKDIVN 控制寄存器中的 HDIVN 和 PDIVN 所决定(如第一张图中的CLKCNTL模块下方)。FCLK经过分频得到HCLK和PCLK。

![image-20230424014133821](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014133821.png)

设置完PMS的值后（即设置MPLL时，此时处于LOCKTIME，LOCKTIME后FCLK将工作，但是HCLK和PCLK未工作），必须接着设置CLKDIVN寄存器。CLKDIVN将在PLL锁定时间后起效。对于复 位和改变电源管理模式该值同样起效。



1. 应当谨慎设置 CLKDIVN，不要使其超过 HCLK 和 PCLK 的最小值。 

2. 如果 HDIVN 不为 0，CPU 总线模式应该使用以下指令使其从快总线模式改变为异步总线模式（S3C2440 不支持同步总线模式）。

```shell
MMU_SetAsyncBusMode 
MRC p15, 0, r0, c1, c0, 0 
ORR r0, r0, #R1_nF:OR:R1_iA 
MCR p15, 0, r0, c1, c0, 0
```

如果 HDIVN 不为 0 并且 CPU 总线模式为快总线模式，CPU 运行在 HCLK。可以用此特性在不影响 HCLK 和 PCLK 的情况下改变 CPU 频率为一半或更多。

![image-20230424014141789](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014141789.png)

LOCKTIME寄存器使用默认值即可

MPLLCON和UPLLCON寄存器需要配置PMS对主时钟源进行分频

PLL 值选择向导（MPLLCON） 

1. Fout = 2 × m × Fin / ( p*2s )，Fvco = 2 × m × Fin / p 此处：m =MDIV+8, p=PDIV+2, s=SDIV 
2. 600MHz ≤ FVCO ≤ 1.2GHz 
3. 200MHz ≤ FCLKOUT ≤ 600MHz 
4. 不要设置 P 或 M 的值为 0，这是因为设置 P=000000，M=00000000 将会引起 PLL 的故障。 
5. P 和 M 的合理范围为：1 ≤ P ≤ 62，1 ≤ M ≤ 248

`0000 0111 1111 0000 0010 0001b=0x7f021`



![image-20230424014154831](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014154831.png)

![image-20230424014210657](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014210657.png)

![image-20230424014254596](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014254596.png)

配置S3C2440的时钟：

根据S3C2440的datasheet目录

![image-20230424014302059](https://gitee.com/zhanghang1999/typora-picture/raw/master/image-20230424014302059.png)

S3C2440拥有外部晶振12MHZ，主时钟源和USB时钟源都是用此晶振作为发生源，这里设置FCLK为400MHZ



u-boot设置：

```assembly
#define LOCKTIME 0x4c000000
#define MPLLCON 0x4c000004
#define UPLLCON 0x4c000008
#define CLKDIVN 0x4c000014

/*设置locktime*/
ldr r0,=LOCKTIME
ldr r1,0xffffffff
str r1,[r0]

/*设置CLKDIVN,使用48MHZ的UPLL,CAMDIVN寄存器根据datasheet，初始化为0x00000000，所以HDIVN=10b或11，PDIVN根据HCLK的设置而设置，上一步的HDIVN设置为10b，HCLK就是400/4 = 100,而PLCK<=68MHZ，所以PDIVN=1b*/
ldr r0,=CLKDIVN
ldr r1,=0x5
str r0,[r1]

/*Fout = 2 × m × Fin / ( p*2s )，Fvco = 2 × m × Fin / p 此处：m =MDIV+8, p=PDIV+2, s=SDIV*/
/*12MHZ晶振进过MPLL倍频后得到400MHZ的FCK:
PMS配置：P和M不能为0，且范围为1 ≤ P ≤ 62，1 ≤ M ≤ 248
Fin为12，即24*(M+8)/(P+2)*2^S=400
可以简单计算出M=92 P=S=1，再根据PMS位在MPLLCON寄存器的位置，可如下配置
*/
ldr r0,=MPLLCON
ldr r1,(92<<12)|(1<<4)|(1<<0)
str r1,[r0]

/*设置UPLLCON*/
ldr r0,=UPLLCON
ldr r1,(56<<12)||(2<<4)||(2<<0)
str r1,[r0]
```


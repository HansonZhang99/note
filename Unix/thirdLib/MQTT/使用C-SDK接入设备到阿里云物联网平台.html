<html>
<head>
  <title>使用C-SDK接入设备到阿里云物联网平台</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="543"/>
<h1>使用C-SDK接入设备到阿里云物联网平台</h1>

<div>
<span><div><div><span style="font-size: 12pt;">设备：开发板fl2440</span></div><div><span style="font-size: 12pt;">开发主机：ubuntu-14.04</span></div><div><span style="font-size: 12pt;">cpu：s3c2440</span></div><div><span style="font-size: 12pt;">Linux内核版本：3.0</span></div><div><span style="font-size: 12pt;">移植USB驱动，rt3070wifi模块接入，移植DS18B20驱动。</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">1.获取阿里云3.0.1版本C-SDK</span></font></div><div><span style="font-size: 12pt;">地址：</span><a href="https://code.aliyun.com/linkkit/c-sdk/repository/archive.zip?spm=a2c4g.11186623.2.15.3b24492bm3SZ3S&amp;ref=v3.0.1" style="font-size: 12pt;">https://code.aliyun.com/linkkit/c-sdk/repository/archive.zip?spm=a2c4g.11186623.2.15.3b24492bm3SZ3S&amp;ref=v3.0.1</a></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>zhanghang@Ubuntu-14:~/zhanghang$ wget https://code.aliyun.com/linkkit/c-sdk/repository/archive.zip</div><div>zhanghang@Ubuntu-14:~/zhanghang$ unzip archive.zip  </div><div>zhanghang@Ubuntu-14:~/zhanghang$ mv c-sdk-v3.0.1-269691d1b45b15fb9045a8eb178efa54b262aca1c-sdk.git/ c-sdk-v3.0.1</div></div><div><br/></div><div><span style="font-size: 12pt; font-weight: bold;">2.由于是在Ubuntu下开发，根据之前在阿里云物联网平台创建的产品，设备，修改文件</span><span style="font-size: 12pt; font-weight: bold;">wrappers/os/ubuntu/HAL_OS_linux.c</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">查看在阿里云物联网平台上创建的产品和设备。</span></div><div><span style="font-size: 12pt;"><img src="使用C-SDK接入设备到阿里云物联网平台_files/Image.png" type="image/png" data-filename="Image.png" width="450"/></span></div><div><span style="font-size: 12pt;"><img src="使用C-SDK接入设备到阿里云物联网平台_files/Image [1].png" type="image/png" data-filename="Image.png" width="453"/></span></div><div><span style="font-size: 12pt;">修改文件</span><span style="font-size: 12pt;">wrappers/os/ubuntu/HAL_OS_linux.c</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#ifdef DYNAMIC_REGISTER</div><div>    char _product_key[IOTX_PRODUCT_KEY_LEN + 1]       = &quot;a1ZETBPbycq&quot;;</div><div>    char _product_secret[IOTX_PRODUCT_SECRET_LEN + 1] = &quot;L68wCVXYUaNg1Ey9&quot;;</div><div>    char _device_name[IOTX_DEVICE_NAME_LEN + 1]       = &quot;example1&quot;;</div><div>    char _device_secret[IOTX_DEVICE_SECRET_LEN + 1]   = &quot;&quot;;</div><div>#else</div><div> <font color="#FF0000">   #ifdef DEVICE_MODEL_ENABLED</font></div><div><font color="#FF0000">        char _product_key[IOTX_PRODUCT_KEY_LEN + 1]       = &quot;</font>a17i4DkIYtW<font color="#FF0000">&quot;;//修改为产品的productkey</font></div><div><font color="#FF0000">        char _product_secret[IOTX_PRODUCT_SECRET_LEN + 1] = &quot;</font>DxYqtfCggDxqENJb<font color="#FF0000">&quot;;//修改为产品的secret</font></div><div><font color="#FF0000">        char _device_name[IOTX_DEVICE_NAME_LEN + 1]       = &quot;</font><font color="#000000">DS18B20</font><font color="#FF0000">&quot;;//修改为设备的name</font></div><div><font style="color: rgb(255, 0, 0);">        char _device_secret[IOTX_DEVICE_SECRET_LEN + 1]   = &quot;</font><font color="#000000">uug19VsZveTVnQhpWAwoulzeQBXhz8TR</font><font style="color: rgb(255, 0, 0);">&quot;;//修改为设备的secert</font></div><div>    #else</div><div>        char _product_key[IOTX_PRODUCT_KEY_LEN + 1]       = &quot;a1MZxOdcBnO&quot;;</div><div>        char _product_secret[IOTX_PRODUCT_SECRET_LEN + 1] = &quot;h4I4dneEFp7EImTv&quot;;</div><div>        char _device_name[IOTX_DEVICE_NAME_LEN + 1]       = &quot;test_01&quot;;</div><div>        char _device_secret[IOTX_DEVICE_SECRET_LEN + 1]   = &quot;t9GmMf2jb3LgWfXBaZD2r3aJrfVWBv56&quot;;</div><div>    #endif</div><div>#endif</div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">3.编译c-sdk</span></font></div><div><span style="font-size: 12pt;">直接在顶层目录执行make即可。</span></div><div><span style="font-size: 12pt;">这里我们只进行一个测试，make会编译</span><span style="font-size: 12pt;">src/mqtt/examples/mqtt_example.c这个文件，生成可执行文件</span><span style="font-size: 12pt;">output/release/bin/mqtt-example</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">4.测试执行</span></span></div><div><span style="font-size: 12pt;">设置平台产品的topic：</span></div><div><span style="font-size: 12pt;"><img src="使用C-SDK接入设备到阿里云物联网平台_files/Image [2].png" type="image/png" data-filename="Image.png"/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>zhanghang@Ubuntu-14:~/zhanghang/c-sdk-v3.0.1$ ./output/release/bin/mqtt-example     </div><div>main|125 :: mqtt example</div><div>establish tcp connection with server(host='a17i4DkIYtW.iot-as-mqtt.cn-shanghai.aliyuncs.com', port=[1883])</div><div>success to establish tcp, fd=3</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">...</span></div><div>example_event_handle|098 :: msg-&gt;event_type : 9</div><div><br/></div><div><br/></div><div>&lt; {</div><div>&lt;     &quot;id&quot;: &quot;0&quot;,</div><div>&lt;     &quot;version&quot;: &quot;1.0&quot;,</div><div>&lt;     &quot;params&quot;: [</div><div>&lt;         {</div><div>&lt;             &quot;attrKey&quot;: &quot;SYS_LP_SDK_VERSION&quot;,</div><div>&lt;             &quot;attrValue&quot;: &quot;3.0.1&quot;,</div><div>&lt;             &quot;domain&quot;: &quot;SYSTEM&quot;</div><div>&lt;         },</div><div>&lt;         {</div><div>&lt;             &quot;attrKey&quot;: &quot;SYS_SDK_LANGUAGE&quot;,</div><div>&lt;             &quot;attrValue&quot;: &quot;C&quot;,</div><div>&lt;             &quot;domain&quot;: &quot;SYSTEM&quot;</div><div>&lt;         }</div><div>&lt;     ],</div><div>&lt;     &quot;method&quot;: &quot;thing.deviceinfo.update&quot;</div><div>&lt; }</div><div><br/></div><div><br/></div><div>example_event_handle|098 :: msg-&gt;event_type : 12</div><div>example_event_handle|098 :: msg-&gt;event_type : 3</div><div>example_event_handle|098 :: msg-&gt;event_type : 9</div><div><br/></div><div><font color="#FF0000"><br/></font></div><div><font color="#FF0000">&lt; {</font></div><div><font style="color: rgb(255, 0, 0);">&lt;     &quot;message&quot;: &quot;hello!&quot;</font></div><div><font color="#FF0000">&lt; }</font></div><div><br/></div><div><br/></div><div><font color="#FF0000">example_message_arrive|031 :: Message Arrived:</font></div><div><font color="#FF0000">example_message_arrive|032 :: Topic  : /a17i4DkIYtW/DS18B20/user/get</font></div><div><font color="#FF0000">example_message_arrive|033 :: Payload: {&quot;message&quot;:&quot;hello!&quot;}</font></div><div><font color="#FF0000">example_message_arrive|034 ::</font></div></div><div><span style="font-size: 12pt;">文件</span><span style="font-size: 12pt;">src/mqtt/examples/mqtt_example.c订阅和发布了</span><span style="color: rgb(255, 0, 0);">&quot;message&quot;: &quot;hello!&quot;</span><span style="font-size: 12pt;">消息到主题</span> <span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgba(230, 249, 252, 0.075);"><span style="background-color: rgba(230, 249, 252, 0.075); font-size: 12pt; font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">/a17i4DkIYtW/DS18B20/user/get上，打印消息红色部分分别显示了发布和订阅收到的内容。</span></span></div><div><span style="font-size: 12pt; font-family: &quot;Helvetica Neue&quot;;">具体参考：</span> <span style="font-size: 12pt;"><a href="https://help.aliyun.com/document_detail/96624.html?spm=a2c4g.11186623.6.554.3b24492bm3SZ3S" style="font-size: 12pt; font-family: &quot;Helvetica Neue&quot;;">https://help.aliyun.com/document_detail/96624.html?spm=a2c4g.11186623.6.554.3b24492bm3SZ3S</a></span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt; font-family: &quot;Helvetica Neue&quot;;">源码分析：src/mqtt/examples/</span><span style="font-size: 12pt; font-family: &quot;Helvetica Neue&quot;;">mqtt_example.c</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#include &quot;dev_sign_api.h&quot;</div><div>#include &quot;mqtt_api.h&quot;</div><div><br/></div><div><br/></div><div><font color="#FF0000">char DEMO_PRODUCT_KEY[IOTX_PRODUCT_KEY_LEN + 1] = {0};</font></div><div><font color="#FF0000">char DEMO_DEVICE_NAME[IOTX_DEVICE_NAME_LEN + 1] = {0};</font></div><div><font color="#FF0000">char DEMO_DEVICE_SECRET[IOTX_DEVICE_SECRET_LEN + 1] = {0};</font></div><div><br/></div><div><font color="#000000"><br/></font></div><div><font color="#000000">void *HAL_Malloc(uint32_t size);</font></div><div><font color="#000000">void HAL_Free(void *ptr);</font></div><div><font color="#000000">void HAL_Printf(const char *fmt, ...);</font></div><div><font color="#000000">int HAL_GetProductKey(char product_key[IOTX_PRODUCT_KEY_LEN + 1]);</font></div><div><font color="#000000">int HAL_GetDeviceName(char device_name[IOTX_DEVICE_NAME_LEN + 1]);</font></div><div><font color="#000000">int HAL_GetDeviceSecret(char device_secret[IOTX_DEVICE_SECRET_LEN]);</font></div><div><font color="#000000">uint64_t HAL_UptimeMs(void);</font></div><div><font color="#000000">int HAL_Snprintf(char *str, const int len, const char *fmt, ...);</font></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><br/></div><div>#define EXAMPLE_TRACE(fmt, ...)  \</div><div>    do { \</div><div>        HAL_Printf(&quot;%s|%03d :: &quot;, __func__, __LINE__); \</div><div>        HAL_Printf(fmt, ##__VA_ARGS__); \</div><div>        HAL_Printf(&quot;%s&quot;, &quot;\r\n&quot;); \</div><div>    } while(0)</div><div><br/></div><div><br/></div><div>void <font style="color: rgb(255, 0, 0);">example_message_arrive</font>(void *pcontext, void *pclient, iotx_mqtt_event_msg_pt msg)</div><div>{</div><div>    iotx_mqtt_topic_info_t     *topic_info = (iotx_mqtt_topic_info_pt) msg-&gt;msg;</div><div><br/></div><div>    switch (msg-&gt;event_type) {</div><div>        case IOTX_MQTT_EVENT_PUBLISH_RECEIVED:</div><div>            /* print topic name and topic message */</div><div>            EXAMPLE_TRACE(&quot;Message Arrived:&quot;);</div><div>            EXAMPLE_TRACE(&quot;Topic  : %.*s&quot;, topic_info-&gt;topic_len, topic_info-&gt;ptopic);</div><div>            EXAMPLE_TRACE(&quot;Payload: %.*s&quot;, topic_info-&gt;payload_len, topic_info-&gt;payload);</div><div>            EXAMPLE_TRACE(&quot;\n&quot;);</div><div>            break;</div><div>        default:</div><div>            break;</div><div>    }</div><div>}</div><div><br/></div><div>int <font color="#FF0000">example_subscribe</font>(void *handle)</div><div>{</div><div>    int res = 0;</div><div>    const char *fmt = &quot;/%s/%s/user/get&quot;;</div><div>    char *topic = NULL;</div><div>    int topic_len = 0;</div><div><br/></div><div><br/></div><div>    topic_len = strlen(fmt) + strlen(<font color="#FF0000">DEMO_PRODUCT_KEY</font>) + strlen(<font color="#FF0000">DEMO_DEVICE_NAME</font>) + 1;</div><div>    topic = HAL_Malloc(topic_len);</div><div>    if (topic == NULL) {</div><div>        EXAMPLE_TRACE(&quot;memory not enough&quot;);</div><div>        return -1;</div><div>    }</div><div>    memset(topic, 0, topic_len);</div><div>   <font color="#FF0000"> HAL_Snprintf(topic, topic_len, fmt, DEMO_PRODUCT_KEY, DEMO_DEVICE_NAME);//将产品product_key，设备的device_name和fmt连接形成topic，即在物联网平台设置为可订阅发布的topic</font></div><div><br/></div><div>    res = <font style="color: rgb(255, 0, 0);">IOT_MQTT_Subscribe(handle, topic, IOTX_MQTT_QOS0, example_message_arrive, NULL);</font></div><div>    if (res &lt; 0) {</div><div>        EXAMPLE_TRACE(&quot;subscribe failed&quot;);</div><div>        HAL_Free(topic);</div><div>        return -1;</div><div>    }</div><div><br/></div><div>    HAL_Free(topic);</div><div>    return 0;</div><div>}</div><div><br/></div><div>int example_publish(void *handle)</div><div>{</div><div>    int             res = 0;</div><div>    const char     *fmt = &quot;/%s/%s/user/get&quot;;</div><div>    char           *topic = NULL;</div><div>    int             topic_len = 0;</div><div>    char           *payload = &quot;{\&quot;message\&quot;:\&quot;hello!\&quot;}&quot;;</div><div><br/></div><div><br/></div><div>    topic_len = strlen(fmt) + strlen(DEMO_PRODUCT_KEY) + strlen(DEMO_DEVICE_NAME) + 1;</div><div>    topic = HAL_Malloc(topic_len);</div><div>    if (topic == NULL) {</div><div>        EXAMPLE_TRACE(&quot;memory not enough&quot;);</div><div>        return -1;</div><div>    }</div><div>    memset(topic, 0, topic_len);</div><div><font color="#FF0000">    HAL_Snprintf(topic, topic_len, fmt, DEMO_PRODUCT_KEY, DEMO_DEVICE_NAME);</font></div><div><br/></div><div><br/></div><div>    res = <font color="#FF0000">IOT_MQTT_Publish_Simple(0, topic, IOTX_MQTT_QOS0, payload, strlen(payload));</font></div><div>    if (res &lt; 0) {</div><div>        EXAMPLE_TRACE(&quot;publish failed, res = %d&quot;, res);</div><div>        HAL_Free(topic);</div><div>        return -1;</div><div>    }</div><div><br/></div><div>    HAL_Free(topic);</div><div>    return 0;</div><div>}</div><div><br/></div><div>void example_event_handle(void *pcontext, void *pclient, iotx_mqtt_event_msg_pt msg)</div><div>{</div><div>    EXAMPLE_TRACE(&quot;msg-&gt;event_type : %d&quot;, msg-&gt;event_type);</div><div>}</div><div><br/></div><div><br/></div><div>int main(int argc, char *argv[])</div><div>{</div><div>    void                   *pclient = NULL;</div><div>    int                     res = 0;</div><div>    int                     loop_cnt = 0;</div><div>    iotx_mqtt_param_t       mqtt_params;</div><div><br/></div><div>   <font color="#FF0000"> HAL_GetProductKey(DEMO_PRODUCT_KEY);</font></div><div><font color="#FF0000">    HAL_GetDeviceName(DEMO_DEVICE_NAME);</font></div><div><font color="#FF0000">    HAL_GetDeviceSecret(DEMO_DEVICE_SECRET);</font></div><div><br/></div><div>    EXAMPLE_TRACE(&quot;mqtt example&quot;);</div><div><br/></div><div>    memset(&amp;mqtt_params, 0x0, sizeof(mqtt_params));</div><div><br/></div><div>    mqtt_params.handle_event.h_fp = example_event_handle;</div><div><br/></div><div>   <font style="color: rgb(255, 0, 0);"> pclient = IOT_MQTT_Construct(&amp;mqtt_params);</font></div><div>    if (NULL == pclient) {</div><div>        EXAMPLE_TRACE(&quot;MQTT construct failed&quot;);</div><div>        return -1;</div><div>    }</div><div><br/></div><div>    res = example_subscribe(pclient);</div><div>    if (res &lt; 0) {</div><div>        IOT_MQTT_Destroy(&amp;pclient);</div><div>        return -1;</div><div>    }</div><div><br/></div><div>    while (1) {</div><div>        if (0 == loop_cnt % 20) {</div><div>            example_publish(pclient);</div><div>        }</div><div><br/></div><div>       <font color="#FF0000"> IOT_MQTT_Yield(pclient, 200);</font></div><div><br/></div><div>        loop_cnt += 1;</div><div>    }</div><div><br/></div><div>    return 0;</div><div>}</div><div><br/></div></div><div><span style="font-size: 12pt;">从main函数开始：</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">HAL_GetProductKey(DEMO_PRODUCT_KEY);</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">HAL_GetDeviceName(DEMO_DEVICE_NAME);</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">HAL_GetDeviceSecret(DEMO_DEVICE_SECRET);</span></div><div><span style="font-size: 12pt;">这三个函数将读取我们之前在文件</span><span style="font-size: 12pt;">wrappers/os/ubuntu/HAL_OS_linux.c中修改的那部分信息，并填入对应数组中。</span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;">接下来看到函数</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">IOT_MQTT_Construct</span><span style="font-size: 12pt;">的实现：</span></div><div><span style="font-size: 12pt;">void *IOT_MQTT_Construct(iotx_mqtt_param_t *pInitParams)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;">    void *pclient;</span></div><div><span style="font-size: 12pt;">    iotx_dev_meta_info_t meta_info;</span></div><div><span style="font-size: 12pt;">    iotx_mqtt_param_t mqtt_params;</span></div><div><span style="font-size: 12pt;">    char device_id[IOTX_PRODUCT_KEY_LEN + IOTX_DEVICE_NAME_LEN + 1] = {0};</span></div><div><span style="font-size: 12pt;">    int region = 0;</span></div><div><span style="font-size: 12pt;">    int dynamic = 0;</span></div><div><span style="font-size: 12pt;">    uint8_t enalbe_itls = 0;</span></div><div><span style="font-size: 12pt;">    int ret;</span></div><div><span style="font-size: 12pt;">    void *callback;</span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">...</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">    /* get meta_info from hal */</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">    memset(&amp;meta_info, 0, sizeof(iotx_dev_meta_info_t));</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">    HAL_GetProductKey(meta_info.product_key);</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">    HAL_GetDeviceName(meta_info.device_name);</span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">...</span></div><div><span style="font-size: 12pt;">#else /* get device secret from hal */</span></div><div><span style="font-size: 12pt;">  </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  HAL_GetDeviceSecret(meta_info.device_secret);</span></div><div><span style="font-family: Monaco; color: rgb(255, 0, 0); font-size: 12pt;">//获取三元素到met_info中</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">#else /* direct mode */</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">    ret = IOT_Sign_MQTT(region, &amp;meta_info, &amp;g_default_sign);</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt; font-family: Monaco;">//用存有三元素的meta_info初始化</span><span style="color: rgb(255, 0, 0); font-size: 12pt;">g_default_sign</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">    /* setup device_id */</span></div><div><span style="font-size: 12pt;">    memcpy(device_id, meta_info.product_key, strlen(meta_info.product_key));</span></div><div><span style="font-size: 12pt;">    memcpy(device_id + strlen(device_id), &quot;.&quot;, strlen(&quot;.&quot;));</span></div><div><span style="font-size: 12pt;">    memcpy(device_id + strlen(device_id), meta_info.device_name, strlen(meta_info.device_name));</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><br/></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">    if (_sign_get_clientid(g_default_sign.clientid, device_id,</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">                           (pInitParams != NULL) ? pInitParams-&gt;customize_info : NULL, enalbe_itls) != SUCCESS_RETURN) </span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt; font-family: Monaco;">//同样是对</span><span style="color: rgb(255, 0, 0); font-size: 12pt;">g_default_sign进行初始化</span></div><div><span style="font-size: 12pt;">    memset(&amp;mqtt_params, 0x0, sizeof(iotx_mqtt_param_t));</span></div><div><br/></div><div><span style="font-size: 12pt;">#endif</span></div><div><span style="font-size: 12pt;">    mqtt_params.request_timeout_ms    = CONFIG_MQTT_REQUEST_TIMEOUT;</span></div><div><span style="font-size: 12pt;">    mqtt_params.clean_session         = 0;</span></div><div><span style="font-size: 12pt;">    mqtt_params.keepalive_interval_ms = CONFIG_MQTT_KEEPALIVE_INTERVAL * 1000;</span></div><div><span style="font-size: 12pt;">    mqtt_params.read_buf_size         = CONFIG_MQTT_MESSAGE_MAXLEN;</span></div><div><span style="font-size: 12pt;">    mqtt_params.write_buf_size        = CONFIG_MQTT_MESSAGE_MAXLEN;</span></div><div><span style="font-size: 12pt;">    mqtt_params.handle_event.h_fp     = NULL;</span></div><div><span style="font-size: 12pt;">    mqtt_params.handle_event.pcontext = NULL;</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">    /* optional configuration */</span></div><div><span style="font-size: 12pt;">    if (pInitParams != NULL) {</span></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;host &amp;&amp; strlen(pInitParams-&gt;host)) {</span></div><div><span style="font-size: 12pt;">            mqtt_params.host = pInitParams-&gt;host;</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default hostname: '%s'&quot;, g_default_sign.hostname);</span></div><div><span style="font-size: 12pt;">            mqtt_params.host = g_default_sign.hostname;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;port) {</span></div><div><span style="font-size: 12pt;">            mqtt_params.port = pInitParams-&gt;port;</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default port: [%d]&quot;, g_default_sign.port);</span></div><div><span style="font-size: 12pt;">            mqtt_params.port = g_default_sign.port;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;client_id &amp;&amp; strlen(pInitParams-&gt;client_id)) {</span></div><div><span style="font-size: 12pt;">            mqtt_params.client_id = pInitParams-&gt;client_id;</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default client_id: %s&quot;, g_default_sign.clientid);</span></div><div><span style="font-size: 12pt;">            mqtt_params.client_id = g_default_sign.clientid;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;username &amp;&amp; strlen(pInitParams-&gt;username)) {</span></div><div><span style="font-size: 12pt;">            mqtt_params.username = pInitParams-&gt;username;</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default username: %s&quot;, g_default_sign.username);</span></div><div><span style="font-size: 12pt;">            mqtt_params.username = g_default_sign.username;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;password &amp;&amp; strlen(pInitParams-&gt;password)) {</span></div><div><span style="font-size: 12pt;">            mqtt_params.password = pInitParams-&gt;password;</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">#if 1</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default password: %s&quot;, &quot;******&quot;);</span></div><div><span style="font-size: 12pt;">#else</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default password: %s&quot;, g_default_sign.password);</span></div><div><span style="font-size: 12pt;">#endif</span></div><div><span style="font-size: 12pt;">            mqtt_params.password = g_default_sign.password;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;request_timeout_ms &lt; CONFIG_MQTT_REQ_TIMEOUT_MIN ||</span></div><div><span style="font-size: 12pt;">            pInitParams-&gt;request_timeout_ms &gt; CONFIG_MQTT_REQ_TIMEOUT_MAX) {</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default request_timeout_ms: %d, configured value(%d) out of [%d, %d]&quot;,</span></div><div><span style="font-size: 12pt;">                         mqtt_params.request_timeout_ms,</span></div><div><span style="font-size: 12pt;">                         pInitParams-&gt;request_timeout_ms,</span></div><div><span style="font-size: 12pt;">                         CONFIG_MQTT_REQ_TIMEOUT_MIN,</span></div><div><span style="font-size: 12pt;">                         CONFIG_MQTT_REQ_TIMEOUT_MAX);</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">            mqtt_params.request_timeout_ms = pInitParams-&gt;request_timeout_ms;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;clean_session == 0 || pInitParams-&gt;clean_session == 1) {</span></div><div><span style="font-size: 12pt;">            mqtt_params.clean_session = pInitParams-&gt;clean_session;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;keepalive_interval_ms &lt; CONFIG_MQTT_KEEPALIVE_INTERVAL_MIN * 1000 ||</span></div><div><span style="font-size: 12pt;">            pInitParams-&gt;keepalive_interval_ms &gt; CONFIG_MQTT_KEEPALIVE_INTERVAL_MAX * 1000) {</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default keepalive_interval_ms: %d, configured value(%d) out of [%d, %d]&quot;,</span></div><div><span style="font-size: 12pt;">                         mqtt_params.keepalive_interval_ms,</span></div><div><span style="font-size: 12pt;">                         pInitParams-&gt;keepalive_interval_ms,</span></div><div><span style="font-size: 12pt;">                         CONFIG_MQTT_KEEPALIVE_INTERVAL_MIN * 1000,</span></div><div><span style="font-size: 12pt;">                         CONFIG_MQTT_KEEPALIVE_INTERVAL_MAX * 1000);</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">            mqtt_params.keepalive_interval_ms = pInitParams-&gt;keepalive_interval_ms;</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (!pInitParams-&gt;read_buf_size) {</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default read_buf_size: %d&quot;, mqtt_params.read_buf_size);</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">            mqtt_params.read_buf_size = pInitParams-&gt;read_buf_size;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (!pInitParams-&gt;write_buf_size) {</span></div><div><span style="font-size: 12pt;">            mqtt_warning(&quot;Using default write_buf_size: %d&quot;, mqtt_params.write_buf_size);</span></div><div><span style="font-size: 12pt;">        } else {</span></div><div><span style="font-size: 12pt;">            mqtt_params.write_buf_size = pInitParams-&gt;write_buf_size;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;handle_event.h_fp != NULL) {</span></div><div><span style="font-size: 12pt;">            mqtt_params.handle_event.h_fp = pInitParams-&gt;handle_event.h_fp;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        if (pInitParams-&gt;handle_event.pcontext != NULL) {</span></div><div><span style="font-size: 12pt;">            mqtt_params.handle_event.pcontext = pInitParams-&gt;handle_event.pcontext;</span></div><div><span style="font-size: 12pt;">        }</span></div><div><span style="font-size: 12pt;">    } else {</span></div><div><span style="font-size: 12pt;">        mqtt_warning(&quot;Using default port: [%d]&quot;, g_default_sign.port);</span></div><div><span style="font-size: 12pt;">        mqtt_params.port = g_default_sign.port;</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        mqtt_warning(&quot;Using default hostname: '%s'&quot;, g_default_sign.hostname);</span></div><div><span style="font-size: 12pt;">        mqtt_params.host = g_default_sign.hostname;</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        mqtt_warning(&quot;Using default client_id: %s&quot;, g_default_sign.clientid);</span></div><div><span style="font-size: 12pt;">        mqtt_params.client_id = g_default_sign.clientid;</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        mqtt_warning(&quot;Using default username: %s&quot;, g_default_sign.username);</span></div><div><span style="font-size: 12pt;">        mqtt_params.username = g_default_sign.username;</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">#if 1</span></div><div><span style="font-size: 12pt;">        mqtt_warning(&quot;Using default password: %s&quot;, &quot;******&quot;);</span></div><div><span style="font-size: 12pt;">#else</span></div><div><span style="font-size: 12pt;">        mqtt_warning(&quot;Using default password: %s&quot;, g_default_sign.password);</span></div><div><span style="font-size: 12pt;">#endif</span></div><div><span style="font-size: 12pt;">        mqtt_params.password = g_default_sign.password;</span></div><div><span style="font-size: 12pt;">    }</span></div><div><span style="color: rgb(255, 0, 0); font-size: 12pt;">//pInitParams是我们传进来的只初始化过mqtt_params.handle_event.h_fp = example_event_handle;的参数，此处利用pInitParams和通过三元组初始化的g_default_sign来初始化mqtt_params</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> pclient = wrapper_mqtt_init(&amp;mqtt_params);//利用mqtt_params初始化pclient,很明显，pclient应该保存了三元组形成的所有连接到阿里云物联网所需要的资源。</span></div><div><br/></div><div><span style="font-size: 12pt;">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> ret = wrapper_mqtt_connect(pclient);//与物联网平台建立连接</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">g_mqtt_client = pclient;//全</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">局变量</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">g_mqtt_client保存pclient</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> return pclient;</span></div><div><span style="font-size: 12pt;">}</span></div><hr/><div><span style="font-size: 12pt;">建立连接后返回pclient句柄，接下来可以利用pclient向物联网平台的topic发布消息和订阅主题。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">函数example_subscribe主要进行平台topic的订阅</span></div><div><span style="font-size: 12pt;">res = IOT_MQTT_Subscribe(handle, topic, IOTX_MQTT_QOS0, example_message_arrive, NULL);</span></div><div><span style="font-size: 12pt;">订阅主题为topic，服务质量为0。handle作为来连接到平台的句柄。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">函数example_publish发布内容到平台的topic</span></div><div><span style="font-size: 12pt;">res = IOT_MQTT_Publish_Simple(0, topic, IOTX_MQTT_QOS0, payload, strlen(payload));</span></div><div><span style="font-size: 12pt;">发布消息paylaod到平台topic上。在这里，并没有传入句柄hanlde，但是却可以和平台通信？</span></div><div><span style="font-size: 12pt;">事实上，在调用函数IOT_MQTT_construct是，我们将pclient的地址给了一个全局变量g_mqtt_client</span></div><div><span style="font-size: 12pt;">我们查看IOT_MQTT_Subscribe和IOT_MQTT_Publish_Simple的源码：</span></div><div><span style="font-size: 12pt;">int IOT_MQTT_Subscribe(void *handle,</span></div><div><span style="font-size: 12pt;">                       const char *topic_filter,</span></div><div><span style="font-size: 12pt;">                       iotx_mqtt_qos_t qos,</span></div><div><span style="font-size: 12pt;">                       iotx_mqtt_event_handle_func_fpt topic_handle_func,</span></div><div><span style="font-size: 12pt;">                       void *pcontext)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;">   <span style="font-size: 12pt; color: rgb(255, 0, 0);"> void *client = handle ? handle : g_mqtt_client;</span></span></div><div><span style="font-size: 12pt;">...</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">    </span></div><div><span style="font-size: 12pt;">int IOT_MQTT_Publish_Simple(void *handle, const char *topic_name, int qos, void *data, int len)</span></div><div><span style="font-size: 12pt;">{   </span></div><div><span style="font-size: 12pt;">    iotx_mqtt_topic_info_t mqtt_msg;</span></div><div><span style="font-size: 12pt;">    <span style="font-size: 12pt; color: rgb(255, 0, 0);">void *client = handle ? handle : g_mqtt_client;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果不传入pclient，这两个函数也回去找g_mqtt_client变量，而这两个变量存储的其实pclient的地址。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">最后看到这段代码：</span></div><div><span style="font-size: 12pt;">    res = example_subscribe(pclient);</span></div><div><span style="font-size: 12pt;">    if (res &lt; 0) {</span></div><div><span style="font-size: 12pt;">        IOT_MQTT_Destroy(&amp;pclient);</span></div><div><span style="font-size: 12pt;">        return -1;</span></div><div><span style="font-size: 12pt;">    }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">    while (1) {</span></div><div><span style="font-size: 12pt;">        if (0 == loop_cnt % 20) {</span></div><div><span style="font-size: 12pt;">            example_publish(pclient);</span></div><div><span style="font-size: 12pt;">        }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">       </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> IOT_MQTT_Yield(pclient, 200);</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">        loop_cnt += 1;</span></div><div><span style="font-size: 12pt;">    }</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">函数IOT_MQTT_Subscribe一次订阅，到断开连接或取消订阅前此订阅会一直生效</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">函数IOT_MQTT_Publish发布消息到topic，可以进行多次发送，在这里，使用一个循环进行不断发送</span></div><div><span style="font-size: 12pt;">最后函数</span></div><div><span style="font-size: 12pt;">int IOT_MQTT_Yield(void *handle, int timeout_ms)</span></div><div><span style="font-size: 12pt;">{       </span></div><div><span style="font-size: 12pt;">    void *pClient = (handle ? handle : g_mqtt_client);//同上</span></div><div><span style="font-size: 12pt;">return wrapper_mqtt_yield(pClient, timeout_ms);</span></div><div><span style="font-size: 12pt;">}</span></div><div><font style="font-size: 12pt;"><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 12pt; font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">用于接收网络报文并将消息分发到用户的回调函数中，即订阅了某个topic后，此函数会接受此topic的消息，并调用之前在IOT_MQTT_Subscribe的回调</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 12pt; font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">函数</span><span style="font-size: 12pt;">example_message_arrive，即打印收到的消息。</span></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">其他常用函数还有</span></div><div><span style="font-size: 12pt;">int </span><span style="font-size: 12pt;">IOT_MQTT_Destroy（void **phandle)</span> <span style="font-size: 12pt; font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">销毁指定MQTT连接并释放资源</span></div><div><br/></div><div><span style="font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 12pt;">int IOT_MQTT_Unsubscribe(void *handle,const char * topic_filter)向云端取消订阅指定topic</span></div><div><br/></div><div><span style="font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 12pt;">int IOT_MQTT_Publish（void *handle,const char *topic_name,iotx_mqtt_topic_info_pt topic_msg)向云端指定topic推送消息</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">参考：</span> <span style="font-size: 12pt;"><a href="https://code.aliyun.com/edward.yangx/public-docs/wikis/user-guide/Linkkit_User_Manual" style="font-size: 12pt;">https://code.aliyun.com/edward.yangx/public-docs/wikis/user-guide/Linkkit_User_Manual</a></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><br/></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 
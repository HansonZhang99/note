<html>
<head>
  <title>磁盘与文件系统</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1207"/>
<h1>磁盘与文件系统</h1>

<div>
<span><div><span style="font-weight: bold;">硬盘：</span></div><div>圆形的盘片：记录数据</div><div>机械手臂：读写磁盘数据</div><div>扇区：最小的物理存储单位512byte</div><div>扇区组成的圆：柱面，柱面是分区的最小单位</div><div>第一个扇区：含有硬盘的主引导记录MBR（446byte）和分区表（64byte）</div><div>各种接口在Linux系统中的文件名：</div><div>/dev/sd[a-p][1-15]：SCSI,SATA,USB,FLASH等接口</div><div>/dev/hd[a-d][1-63]：IDE接口</div><div><br/></div><div>如何记录指定分区的柱面范围：</div><div>64byte的分区表记录四条分区记录：</div><div>主分区+扩展分区（扩展分区可分出逻辑分区），主分区和逻辑分区可被格式化</div><div>主分区和扩展分区最多四个，扩展分区最多一个。</div><div>逻辑分区的数量因操作系统的不同而不同，在Linux中，IDE硬盘最多有59个逻辑分区（5-63），SATA硬盘则有11个逻辑分区（5-15）</div><div><br/></div><div>Linux正规的文件系统是EXT2。</div><div><br/></div><div>传统的文件系统中，一个分区只能格式化微一个文件系统。如今可将多个分区格式化为一个文件系统。也可以将一个分区格式化为多个文件系统</div><div>现称：一个可被挂载的数据是一个文件系统而不是分区</div><div>Linux操作系统将文件的属性和数据分开存放。属性放在inode中，数据放在data block中。另外还会有一个超级块去记录文件系统的整体信息，包括inode和block的总数，使用数和剩余数。</div><div><br/></div><div>super block（超级块）：记录此文件系统的整体信息，包括inode，block的总数，使用量和剩余量，以及文件系统的格式或相关信息</div><div>inode：记录文件的属性，一个文件占用一个inode，同属也会记录此文件的数据所在的block号码</div><div>block：实际记录文件的内容，若文件太大会占用多个block</div><div><img src="磁盘与文件系统_files/20210309193149809_18001.png" type="image/png" data-filename="20210309193149809_18001.png"/></div><div><br/></div><div>Linux使用这种索引式文件系统，当一个文件数据占用4个block如上图，分别是2 4 6 8时，此文件对应的inode会记录此文件所占用的所有block编号，通过inode即可找到文件。</div><div><br/></div><div>像U盘之类的使用FAT文件系统的设备，没有inode的存在，使用前一个block记录后一个block的编号，即可读完整个文件。</div><div><br/></div><div>文件系统一开始就会将inode和block规划好，除非重新格式化，或者resize2fs等命令更改文件系统大小，否则inode和block固定后将不再变动。</div><div>Ext2文件系统格式化后会分为多个块组（block group）每个块组拥有独立的inode/block/super block系统。文件系统最前面有一个启动扇区，这个启动扇区可以安装引导装载程序。这样可以可以将不同引导装载程序安装在个别文件系统的最前端，不用覆盖整块硬盘唯一的MBR，制作出多重引导环境。</div><div><img src="磁盘与文件系统_files/20210309194613116_23427.png" type="image/png" data-filename="20210309194613116_23427.png"/></div><div><br/></div><div>1.data block，Ext2文件系统支持的block大小有三个：1,2,4KB。</div><div>block的大小和数量在格式化后就不能改变了</div><div>每个block最多放置一个文件数据，如果文件数据小于block大小，多余空间也不可被使用，如果大于一个block，会再用掉一个block。</div><div><br/></div><div>inode table（inode）：</div><div>记录：</div><div>该文件的访问模式rwx</div><div>所有者和组(user，group）</div><div>文件大小</div><div>创建或修改时间</div><div>最后一次修改时间</div><div><br/></div><div>inode也在初始化是时大小数量被固定</div><div>每个inode大小固定128byte</div><div>每个文件仅会占用一个inode</div><div>一个文件系统能创建的文件数量与inode有关</div><div>系统读取文件时先找到inode，分析权限，用户等，符合才能读取block内容</div><div>inode记录一个block要花费4byte，inode总大小128byte，当文件占用的block数大于inode能记录的最大block数时，会怎样？</div><div>Linux系统将inode记录block的号码区域定义为12个直接，1个间接，一个双间接，一个三间接，block为1KB时文件最大可达到16GB，逻辑如下：</div><div><img src="磁盘与文件系统_files/20210309200128911_16852.png" type="image/png" data-filename="20210309200128911_16852.png"/></div><div>super block：相关信息可使用dumpe2fs命令查看</div><div>记录：</div><div>block和inode总量</div><div>未使用和已使用的inode/block量</div><div>block，inode大小(block：1,2,4KB，inode 128byte）</div><div>文件系统挂载时间，最近一次写入数据时间，最近一次检验磁盘时间等</div><div>每个block group都可能含有一个super block，用来作为super block的备份</div><div><br/></div><div>文件系统描述说明：</div><div>描述每个block group开始和结束的block号码，可使用dumpe2fs查看</div><div><br/></div><div>块对照表：</div><div>记录哪些block是在被使用的未被使用的</div><div><br/></div><div>inode对照表：</div><div>记录哪些inode是在被使用的未被使用的</div><div><br/></div><div>df查看当前被挂载的设备</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>zhanghang@zhanghang-virtual-machine:~$ df</div><div>Filesystem     1K-blocks    Used Available Use% Mounted on</div><div>udev             1006084       4   1006080   1% /dev</div><div>tmpfs             203920     664    203256   1% /run</div><div>/dev/sda1       39089600 6029660  31051264  17% /    &lt;-----------------</div><div>none                   4       0         4   0% /sys/fs/cgroup</div><div>none                5120       0      5120   0% /run/lock</div><div>none             1019584     152   1019432   1% /run/shm</div><div>none              102400      28    102372   1% /run/user</div><div>/dev/sr0         1130496 1130496         0 100% /media/zhanghang/Ubuntu 14.04.6 LTS amd641</div><div>zhanghang@zhanghang-virtual-machine:~$ sudo dumpe2fs /dev/sda1 &gt; test.txt ; head -n 80 test.txt</div><div>dumpe2fs 1.42.9 (4-Feb-2014)</div><div>Filesystem volume name:   &lt;none&gt;  文件系统名称（暂无）</div><div>Last mounted on:          /</div><div>Filesystem UUID:          ce0666b7-882b-4ede-8e5f-3b8a2a4611dc</div><div>Filesystem magic number:  0xEF53</div><div>Filesystem revision #:    1 (dynamic)</div><div>Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery extent flex_bg sparse_super large_file huge_file uninit_bg dir_nlink extra_isize</div><div>Filesystem flags:         signed_directory_hash</div><div>Default mount options:    user_xattr acl</div><div>Filesystem state:         clean  文件系统没有问题</div><div>Errors behavior:          Continue</div><div>Filesystem OS type:       Linux</div><div>Inode count:              2490368   inode总数</div><div>Block count:              9961472      block总数</div><div>Reserved block count:     498073</div><div>Free blocks:              8264973        可用block</div><div>Free inodes:              2219590        可用inode</div><div>First block:              0</div><div>Block size:               4096        block大小</div><div>Fragment size:            4096</div><div>Reserved GDT blocks:      1021</div><div>Blocks per group:         32768        每个block group中block数</div><div>Fragments per group:      32768</div><div>Inodes per group:         8192        每个block group中inode数</div><div>Inode blocks per group:   512</div><div>Flex block group size:    16</div><div>Filesystem created:       Tue Jul 14 11:20:24 2020</div><div>Last mount time:          Tue Mar  9 14:52:54 2021</div><div>Last write time:          Tue Mar  9 14:52:54 2021</div><div>Mount count:              92</div><div>Maximum mount count:      -1</div><div>Last checked:             Tue Jul 14 11:20:24 2020</div><div>Check interval:           0 (&lt;none&gt;)</div><div>Lifetime writes:          4946 MB</div><div>Reserved blocks uid:      0 (user root)</div><div>Reserved blocks gid:      0 (group root)</div><div>First inode:              11</div><div>Inode size:               256  inode大小</div><div>Required extra isize:     28</div><div>Desired extra isize:      28</div><div>Journal inode:            8</div><div>First orphan inode:       1327443</div><div>Default directory hash:   half_md4</div><div>Directory Hash Seed:      adef8694-ee6a-48d9-82ce-05ca2ad8d49a</div><div>Journal backup:           inode blocks</div><div>Journal features:         journal_incompat_revoke</div><div>Journal size:             128M</div><div>Journal length:           32768</div><div>Journal sequence:         0x0000969a</div><div>Journal start:            9505</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>Group 0: (Blocks 0-32767) [ITABLE_ZEROED]</div><div>  Checksum 0xce34, unused inodes 8179</div><div>  Primary superblock at 0, Group descriptors at 1-3  super block在group0,</div><div>  Reserved GDT blocks at 4-1024</div><div>  Block bitmap at 1025 (+1025), Inode bitmap at 1041 (+1041)</div><div>  Inode table at 1057-1568 (+1057)</div><div>  23513 free blocks, 8179 free inodes, 2 directories, 8179 unused inodes</div><div>  Free blocks: 9255-32767</div><div>  Free inodes: 14-8192</div><div>Group 1: (Blocks 32768-65535) [INODE_UNINIT, ITABLE_ZEROED]</div><div>  Checksum 0x5632, unused inodes 8192</div><div>  Backup superblock at 32768, Group descriptors at 32769-32771</div><div>  Reserved GDT blocks at 32772-33792</div><div>  Block bitmap at 1026 (bg #0 + 1026), Inode bitmap at 1042 (bg #0 + 1042)</div><div>  Inode table at 1569-2080 (bg #0 + 1569)</div><div>  24336 free blocks, 8192 free inodes, 0 directories, 8192 unused inodes</div><div>  Free blocks: 34170-34303, 36347-36863, 41378-41407, 41435-41439, 41468-60927, 61346-65535</div><div>  Free inodes: 8193-16384</div><div>Group 2: (Blocks 65536-98303) [INODE_UNINIT, ITABLE_ZEROED]</div><div>  Checksum 0xd465, unused inodes 8192</div><div>  Block bitmap at 1027 (bg #0 + 1027), Inode bitmap at 1043 (bg #0 + 1043)</div><div>  Inode table at 2081-2592 (bg #0 + 2081)</div><div>  21924 free blocks, 8192 free inodes, 0 directories, 8192 unused inodes</div><div>  Free blocks: 65536-67327, 67525-75135, 75243-86015, 89320-90111, 93252-94207</div><div>  Free inodes: 16385-24576</div><div>Group 3: (Blocks 98304-131071) [INODE_UNINIT, ITABLE_ZEROED]</div><div>  Checksum 0x48ab, unused inodes 8192</div><div>  Backup superblock at 98304, Group descriptors at 98305-98307</div><div>  Reserved GDT blocks at 98308-99328</div><div>zhanghang@zhanghang-virtual-machine:~$</div></div><div>在Linux下创建目录时，ext2会分配一个inode好至少一个block给该目录。inode记录目录的权限属性等和分配的block号码。</div><div>block记录这个目录下的文件名和该文件名占用的inode号码的数据</div><div><br/></div><div>ls -li查看文件占用的inode</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>zhanghang@zhanghang-virtual-machine:~$ ls -li</div><div>total 524</div><div>787712 -rw-rw-r--  1 zhanghang zhanghang   8690  8æ  4  2020 aaa.c</div><div>797696 -rw-r--r--  1 root      root       58486 12æ 23 16:22 aaa.cap</div><div>787709 -rwxrwxr-x  1 zhanghang zhanghang   8518  1æ 25 11:02 a.out</div><div>787710 -rw-rw-r--  1 zhanghang zhanghang   7540  8æ  4  2020 bbb.c</div><div>793325 -rwxrwxr-x  1 zhanghang zhanghang   9157 12æ 23 14:23 c</div><div>797739 -rwxrw-rw-  1 zhanghang zhanghang   1056 12æ 23 14:23 client.c</div><div>793906 -rw-rw-r--  1 zhanghang zhanghang   1041  1æ 23 13:11 curl-7.74.0.tar.gz</div><div><br/></div><div>zhanghang@zhanghang-virtual-machine:/$ ll -d  /bin /boot /proc /sbin</div><div>drwxr-xr-x   2 root root  4096  7æ 14  2020 /bin/  1个block</div><div>drwxr-xr-x   3 root root  4096  7æ 14  2020 /boot/   1个block</div><div>dr-xr-xr-x 270 root root     0  3æ  9 14:52 /proc/    proc存在于内存的伪文件系统，不占用硬盘</div><div>drwxr-xr-x   2 root root 12288  7æ 30  2020 /sbin/        3个block</div></div><div><br/></div><div>目录中文件太多时可能占用多个block</div><div><br/></div><div>ext2文件系统下创建一个文件，文件系统会根据文件大小分配1个inode和与文件大小对等的block数量</div><div><br/></div><div>目录树是从根目录开始读取，通过挂载点信息可以找到挂载点的inode号码（通常为2），从根目录的inode去读取inode对应的block中的文件名及文件对应的inode，从而读取到文件</div><div><br/></div><div>cat /etc/passwd文件的流程：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>zhanghang@zhanghang-virtual-machine:~$ ll -di / /etc/ /etc/passwd</div><div>     2 drwxr-xr-x  24 root root  4096  3æ  9 20:26 //</div><div>131073 drwxr-xr-x 127 root root 12288  3æ  9 20:52 /etc//</div><div>142620 -rw-r--r--   1 root root  1989  7æ 24  2020 /etc/passwd</div></div><div><br/></div><div>/的inode</div><div>通过挂载点信息找到/dev/sda1的inode号码为2的根目录inode，且inode具有rx权限可读取此block内容</div><div>/的block</div><div>取得上述block后找到/etc对应inode号码</div><div>/etc的inode</div><div>读取131073inode具有rx权限可读取/etc的block</div><div>/etc的block</div><div>取得上述block后得到passwd文件的inode</div><div>passwd的inode</div><div>具有r权限</div><div>passwd的block</div><div>读取block内容即可</div><div><br/></div><div><br/></div><div>新创建一个文件或目录时，Ext2文件系统的操作：</div><div>先确定用户对此文件是否具有w和x权限，有的话才能加入</div><div>inode bitmap找到没有使用的inode号码，将新文件的权限/属性写入</div><div>block bitmap找到没有使用的block号码，将实际数据写入block中，并更新inode的block指针</div><div>将刚才写入的inode和block数据同步到inode/block bitmap,并更新super block</div><div><br/></div><div>日志文件系统Ext3-&gt;解决如上操作过程中发生断电等问题的情况下，（super block，inode/block bitmap 即meta data中间数据，经常变化的数据）中数据与inode/block不一致的情况</div><div>预备：当系统要写入一个文件时，会现在日志记录块中记录某个文件要写入的信息</div><div>实际写入：开始写入文件的权限与数据，开始更新meta data数据</div><div>结束：完成数据与meta data的更新后，在日志记录块中完成该文件的记录</div><div><br/></div><div>Linux文件磁盘读写的异步处理方式：</div><div>系统加载一个文件到内存后，如果文件没有被改动，则此文件在内存中会被设置一个标志clean，如果改动这个文件，此标志会被设置为dirty。此时所有的操作都在内存中执行，并没有写入到磁盘中。系统会不定时的将北村中设置为dirty的数据写入到磁盘，以保持磁盘与内存数据的一致性，也可以使用sync，fsync系列的函数强制将数据写入到磁盘。</div><div><br/></div><div>系统会将常用的文件放到主存储器的缓冲器，以加速文件系统的读写</div><div>系统的物理内存最后会被用光，这是正常的，可加速系统性能</div><div>正常关机时，关机命令会调用sync将内存中的数据写入到磁盘</div><div>若不正常关机，由于数据未写回到磁盘，重启后回话更多的时间进行磁盘检验，甚至损坏文件系统（非磁盘损坏）</div><div><br/></div><div><br/></div><div>每个文件系统都有自己的inode,block，superblock等信息，这个文件系统要连接带目录树才能被我们使用。将文件系统和目录树的操作我们称为挂载。挂载点一定是目录，该目录是进入该文件系统的入口。</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@zhanghang-virtual-machine:/# ls -lid /</div><div>2 drwxr-xr-x 24 root root 4096  3æ  9 20:26 /</div></div><div><br/></div><div>文件系统最顶层的inode号一般为2</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@zhanghang-virtual-machine:/# ls -lid / /.. /.</div><div>2 drwxr-xr-x 24 root root 4096  3æ  9 20:26 /</div><div>2 drwxr-xr-x 24 root root 4096  3æ  9 20:26 /.</div><div>2 drwxr-xr-x 24 root root 4096  3æ  9 20:26 /..</div></div><div><br/></div><div>/ /.. /.为同一个文件</div><div>磁盘与目录的容量shell命令：</div><div>df,du</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>zhanghang@zhanghang-virtual-machine:/$ df</div><div>Filesystem     1K-blocks    Used Available Use% Mounted on</div><div>udev             1006084       4   1006080   1% /dev</div><div>tmpfs             203920     664    203256   1% /run</div><div>/dev/sda1       39089600 6123536  30957388  17% /</div><div>none                   4       0         4   0% /sys/fs/cgroup</div><div>none                5120       0      5120   0% /run/lock</div><div>none             1019584     144   1019440   1% /run/shm</div><div>none              102400      36    102364   1% /run/user</div><div><br/></div><div><br/></div><div>zhanghang@zhanghang-virtual-machine:/$ df -h</div><div>Filesystem      Size  Used Avail Use% Mounted on</div><div>udev            983M  4.0K  983M   1% /dev</div><div>tmpfs           200M  664K  199M   1% /run</div><div>/dev/sda1        38G  5.9G   30G  17% /</div><div>none            4.0K     0  4.0K   0% /sys/fs/cgroup</div><div>none            5.0M     0  5.0M   0% /run/lock</div><div>none            996M  144K  996M   1% /run/shm</div><div>none            100M   36K  100M   1% /run/user</div><div><br/></div><div><br/></div><div>zhanghang@zhanghang-virtual-machine:/$ df -aT</div><div>Filesystem     Type                1K-blocks    Used Available Use% Mounted on</div><div>sysfs          sysfs                       0       0         0    - /sys</div><div>proc           proc                        0       0         0    - /proc</div><div>udev           devtmpfs              1006084       4   1006080   1% /dev</div><div>devpts         devpts                      0       0         0    - /dev/pts</div><div>tmpfs          tmpfs                  203920     664    203256   1% /run</div><div>/dev/sda1      ext4                 39089600 6123536  30957388  17% /</div><div>none           tmpfs                       4       0         4   0% /sys/fs/cgroup</div><div>none           fusectl                     0       0         0    - /sys/fs/fuse/connections</div><div>none           debugfs                     0       0         0    - /sys/kernel/debug</div><div>none           securityfs                  0       0         0    - /sys/kernel/security</div><div>none           tmpfs                    5120       0      5120   0% /run/lock</div><div>none           tmpfs                 1019584     144   1019440   1% /run/shm</div><div>none           tmpfs                  102400      36    102364   1% /run/user</div><div>none           pstore                      0       0         0    - /sys/fs/pstore</div><div>systemd        cgroup                      0       0         0    - /sys/fs/cgroup/systemd</div><div>vmware-vmblock fuse.vmware-vmblock         0       0         0    - /run/vmblock-fuse</div><div>gvfsd-fuse     -                           -       -         -    - /run/user/112/gvfs</div><div><br/></div><div><br/></div><div>zhanghang@zhanghang-virtual-machine:/$ df -ih</div><div>Filesystem     Inodes IUsed IFree IUse% Mounted on</div><div>udev             246K   448  246K    1% /dev</div><div>tmpfs            249K   458  249K    1% /run</div><div>/dev/sda1        2.4M  265K  2.2M   11% /</div><div>none             249K     2  249K    1% /sys/fs/cgroup</div><div>none             249K     5  249K    1% /run/lock</div><div>none             249K     4  249K    1% /run/shm</div><div>none             249K    19  249K    1% /run/user</div></div><div><br/></div><div>du</div><div>-a列出所有文件与目录总量</div><div>-h易读方式列出G/M</div><div>-s列出总量，不列出个别目录占用总量</div><div>-S不包括子目录的统计</div><div>-k 以KB显示</div><div>-m以MB显示</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>du：</div><div>...</div><div>8       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel/modules/bcm-knet</div><div>24      ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel/modules</div><div>28      ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel</div><div>88      ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux</div><div>120     ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems</div><div>76      ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/make</div><div>212     ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules</div><div>216     ./kernel/ubuntu/opennsl/OpenNSL</div><div>228     ./kernel/ubuntu/opennsl</div><div>12      ./kernel/ubuntu/ixxat</div><div>416     ./kernel/ubuntu</div><div>161120  ./kernel</div><div>1796372 .</div><div><br/></div><div><br/></div><div>du -h:</div><div>...</div><div>24K     ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel/modules</div><div>28K     ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel</div><div>88K     ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux</div><div>120K    ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems</div><div>76K     ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/make</div><div>212K    ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules</div><div>216K    ./kernel/ubuntu/opennsl/OpenNSL</div><div>228K    ./kernel/ubuntu/opennsl</div><div>12K     ./kernel/ubuntu/ixxat</div><div>416K    ./kernel/ubuntu</div><div>158M    ./kernel</div><div>1.8G    .</div><div><br/></div><div><br/></div><div>du -a:</div><div>...</div><div>8       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/make/Makefile.linux-iproc-3_14</div><div>4       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/make/Makefile.linux-x86-common-2_6</div><div>4       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/make/Makefile.linux-x86-smp_generic_64-2_6</div><div>8       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/make/Makefile.linux-kernel-4_4</div><div>76      ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/make</div><div>212     ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules</div><div>216     ./kernel/ubuntu/opennsl/OpenNSL</div><div>4       ./kernel/ubuntu/opennsl/Makefile</div><div>4       ./kernel/ubuntu/opennsl/Kconfig</div><div>228     ./kernel/ubuntu/opennsl</div><div>4       ./kernel/ubuntu/ixxat/Makefile</div><div>4       ./kernel/ubuntu/ixxat/Kconfig</div><div>12      ./kernel/ubuntu/ixxat</div><div>4       ./kernel/ubuntu/Kconfig</div><div>416     ./kernel/ubuntu</div><div>161120  ./kernel</div><div>4       ./.dmrc</div><div>1796372 .</div><div><br/></div><div><br/></div><div>root@zhanghang-virtual-machine:/home/zhanghang# du -s</div><div>1796372 .</div><div><br/></div><div><br/></div><div>du -S:</div><div>...</div><div>8       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel/modules/shared</div><div>8       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel/modules/bcm-knet</div><div>8       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel/modules</div><div>4       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux/kernel</div><div>4       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems/linux</div><div>4       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/systems</div><div>76      ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules/make</div><div>4       ./kernel/ubuntu/opennsl/OpenNSL/sdk-6.5.10-gpl-modules</div><div>4       ./kernel/ubuntu/opennsl/OpenNSL</div><div>12      ./kernel/ubuntu/opennsl</div><div>12      ./kernel/ubuntu/ixxat</div><div>12      ./kernel/ubuntu</div><div>52104   ./kernel</div><div>668     .</div><div><br/></div><div><br/></div></div><div><br/></div><div>连接文件：</div><div>硬链接：在某个目录下新建一个文件名链接到某个inode号码的关联记录</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@zhanghang-virtual-machine:/home/zhanghang# ls -li</div><div>794471 -rw-rw-r--  1 zhanghang zhanghang    849  3æ 20 16:34 server.c</div><div>root@zhanghang-virtual-machine:/home/zhanghang/test# ls</div><div>aaa.c  a.out  test  test.c</div><div>root@zhanghang-virtual-machine:/home/zhanghang/test# ln ../server.c .</div><div>root@zhanghang-virtual-machine:/home/zhanghang/test# ls</div><div>aaa.c  a.out  server.c  test  test.c</div><div><br/></div><div><br/></div><div>root@zhanghang-virtual-machine:/home/zhanghang/test# ll -i ../server.c  server.c</div><div>794471 -rw-rw-r-- 2 zhanghang zhanghang 849  3æ 20 16:34 ../server.c</div><div>794471 -rw-rw-r-- 2 zhanghang zhanghang 849  3æ 20 16:34 server.c</div></div><div><br/></div><div>test目录下的server.c和test/../server.c有着同样的inode号码:794471</div><div>ls -li命令第三个字段连接数也由1变为了2,连接数表示有多少个文件名链接到这个目录</div><div><img src="磁盘与文件系统_files/20210322104631671_15725.png" type="image/png" data-filename="20210322104631671_15725.png"/></div><div><br/></div><div>inode2指向目录/home/zhanghang</div><div>inode1指向目录/home/zhanghang/test</div><div><br/></div><div>文件server.c在/home/zhanghang目录下，其inode  real记录在/home/zhanghang的block中</div><div>新建一个到目录/home/zhanghang/test/的server.c连接时，/home/zhanghang/test的block中会多一条指向inode real的数据</div><div>因此新建一个硬链接只是在对应目录的block中添加一条指向该文件的索引，不会增加inode和block</div><div><br/></div><div>由图可知，硬链接的活动范围只能针对单一文件系统进行。</div><div>不能跨文件系统，不能连接目录：因为使用硬链接与一个目录建立连接是，需要和对应目录下的所有文件都建立连接，而且目录下还有可能有目录，复杂度比较大，暂时不支持</div><div><br/></div><div>符号链接（Windows的快捷方式）</div><div>创建一个独立的文件，文件的数据读取指向连接的文件的文件名，当原文件被删除时，符号链接也会打不开</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@zhanghang-virtual-machine:/home/zhanghang/test# ln -s ../server.c .</div><div>root@zhanghang-virtual-machine:/home/zhanghang/test# ls -li ../server.c server.c</div><div>797722 -rw-rw-r-- 1 zhanghang zhanghang 866  3æ 20 16:50 ../server.c</div><div>1191678 lrwxrwxrwx 1 root      root       11  3æ 22 11:01 server.c -&gt; ../server.c</div></div><div><br/></div><div>以上两个文件的inode号码是不一样的，连接文件会写上目标文件的文件名</div><div>第二行的root后的数字11代表链接文件链接到的文件名的长度，即符号链接会记录这个文件名的路径，即：../server.c长度为11，当使用绝对路径创建符号链接时，这个长度又会变成绝对路径的长度</div><div>当使用符号链接时，ln -s后的两个参数分别是实际文件和符号链接文件，两者不能调换顺序</div><div><br/></div><div><img src="磁盘与文件系统_files/20210322112400689_32440.png" type="image/png" data-filename="20210322112400689_32440.png"/></div><div><br/></div><div>与硬连接不同的是，符号链接文件有自己的inode1和block，当访问符号链接时，inode1找到连接文件的block，读取block的数据为../server.c，再根据文件名去找到对应文件的inode-&gt;block。</div><div>当实际文件删除，移动，改名时，符号链接都会失效</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@zhanghang-virtual-machine:/tmp# vim test</div><div>root@zhanghang-virtual-machine:/tmp# df</div><div>Filesystem     1K-blocks    Used Available Use% Mounted on</div><div>udev             1006084       4   1006080   1% /dev</div><div>tmpfs             203920     664    203256   1% /run</div><div>/dev/sda1       39089600 6123540  30957384  17% /</div><div>none                   4       0         4   0% /sys/fs/cgroup</div><div>none                5120       0      5120   0% /run/lock</div><div>none             1019584     144   1019440   1% /run/shm</div><div>none              102400      36    102364   1% /run/user</div><div>root@zhanghang-virtual-machine:/tmp# df -i</div><div>Filesystem      Inodes  IUsed   IFree IUse% Mounted on</div><div>udev            251521    448  251073    1% /dev</div><div>tmpfs           254896    458  254438    1% /run</div><div>/dev/sda1      2490368 270801 2219567   11% /</div><div>none            254896      2  254894    1% /sys/fs/cgroup</div><div>none            254896      5  254891    1% /run/lock</div><div>none            254896      4  254892    1% /run/shm</div><div>none            254896     19  254877    1% /run/user</div><div>root@zhanghang-virtual-machine:/tmp# du -sb</div><div>45867   .</div><div>root@zhanghang-virtual-machine:/tmp# ln test test_hd</div><div>root@zhanghang-virtual-machine:/tmp# du -sb</div><div>45867   .</div><div>root@zhanghang-virtual-machine:/tmp# df</div><div>Filesystem     1K-blocks    Used Available Use% Mounted on</div><div>udev             1006084       4   1006080   1% /dev</div><div>tmpfs             203920     664    203256   1% /run</div><div>/dev/sda1       39089600 6123540  30957384  17% /</div><div>none                   4       0         4   0% /sys/fs/cgroup</div><div>none                5120       0      5120   0% /run/lock</div><div>none             1019584     144   1019440   1% /run/shm</div><div>none              102400      36    102364   1% /run/user</div><div>root@zhanghang-virtual-machine:/tmp# df -h</div><div>Filesystem      Size  Used Avail Use% Mounted on</div><div>udev            983M  4.0K  983M   1% /dev</div><div>tmpfs           200M  664K  199M   1% /run</div><div>/dev/sda1        38G  5.9G   30G  17% /</div><div>none            4.0K     0  4.0K   0% /sys/fs/cgroup</div><div>none            5.0M     0  5.0M   0% /run/lock</div><div>none            996M  144K  996M   1% /run/shm</div><div>none            100M   36K  100M   1% /run/user</div><div>root@zhanghang-virtual-machine:/tmp# df -i</div><div>Filesystem      Inodes  IUsed   IFree IUse% Mounted on</div><div>udev            251521    448  251073    1% /dev</div><div>tmpfs           254896    458  254438    1% /run</div><div>/dev/sda1      2490368 270801 2219567   11% /</div><div>none            254896      2  254894    1% /sys/fs/cgroup</div><div>none            254896      5  254891    1% /run/lock</div><div>none            254896      4  254892    1% /run/shm</div><div>none            254896     19  254877    1% /run/user</div><div>root@zhanghang-virtual-machine:/tmp# ls -li test test_hd</div><div>2101715 -rw-r--r-- 2 root root 6  3æ 22 11:43 test</div><div>2101715 -rw-r--r-- 2 root root 6  3æ 22 11:43 test_hd</div><div>root@zhanghang-virtual-machine:/tmp# ln -s test test_so</div><div>root@zhanghang-virtual-machine:/tmp# ls -li test test_so</div><div>2101715 -rw-r--r-- 2 root root 6  3æ 22 11:43 test</div><div>2101714 lrwxrwxrwx 1 root root 4  3æ 22 11:45 test_so -&gt; test</div><div>root@zhanghang-virtual-machine:/tmp# du -sb</div><div>45871   .</div><div>root@zhanghang-virtual-machine:/tmp# df -i</div><div>Filesystem      Inodes  IUsed   IFree IUse% Mounted on</div><div>udev            251521    448  251073    1% /dev</div><div>tmpfs           254896    458  254438    1% /run</div><div>/dev/sda1      2490368 270802 2219566   11% /</div><div>none            254896      2  254894    1% /sys/fs/cgroup</div><div>none            254896      5  254891    1% /run/lock</div><div>none            254896      4  254892    1% /run/shm</div><div>none            254896     19  254877    1% /run/user</div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 
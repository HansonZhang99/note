<html>
<head>
  <title>mosquitto库MQTT编程</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="557"/>
<h1>mosquitto库MQTT编程</h1>

<div>
<span><div><div><span style="font-size: 12pt;">之前做mqtt一直用的paho库编程，但是要开启broker服务，又必须有mosquitto库的支持，要移植的时候，也要移植两个库的相应动态库，编译和移植两个库总比一个库要复杂，mosquitto库是提供了mqtt编程接口的，虽然接口和paho是完全不一样，但是其底层实现是一样的(socket）。接下来谈谈mosquitto库编程实现mqtt通信。</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">先说一个问题吧：当报错有</span><span style="font-size: 12pt;">/usr/bin/ld: skipping incompatible...时，看看编译器和动态库版本是否一样，之前编译一个文件，死活报这个错，结果编译器是x86的，而链接动态库是arm的...</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">    </span></div><div><span style="font-size: 12pt;">查看源码，现在mosquitto目录下建立索引，这个库的索引比较小。</span></div><div><span style="font-size: 12pt;">ctags -R</span></div><div><span style="font-size: 12pt;">在vim配置文件（/etc/vim/vimrc或~/.vimrc下）添加set tags=“tags所在绝对路径”</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在client目录下，有两个文件</span><span style="font-size: 12pt;">pub_client.c和s</span><span style="font-size: 12pt;">ub_client.c分别是mosquitto_pub和mosquitto_sub的实现。</span></div><div><span style="font-size: 12pt;">在src目录下，函数mosquitto.c是对mosquitto工具的实现。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">看到mosquitto/test目录，库为我们提供了两个简单的测试程序，我们分析</span><span style="font-size: 12pt;">msgsps_pub.c和</span><span style="font-size: 12pt;">msgsps_sub.c文件。</span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">/* This provides a crude manner of testing the performance of a broker in messages/s. */</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;stdbool.h&gt;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;stdint.h&gt;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;stdio.h&gt;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;stdlib.h&gt;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;sys/time.h&gt;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;mosquitto.h&gt;</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;msgsps_common.h&gt;</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">static bool run = true;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">static int message_count = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">static struct timeval start, stop;</span></div><div><span style="font-size: 12pt;">/*#define MESSAGE_SIZE 1024L*/</span></div><div><span style="font-size: 12pt;">/*#define MESSAGE_COUNT 100000L*/</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">void</span> <span style="font-size: 12pt; color: rgb(0, 0, 0); font-weight: bold;">my_connect_callback</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(struct mosquitto *mosq, void *obj, int rc)//回调函数</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    printf(&quot;rc: %d\n&quot;, rc);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    gettimeofday(&amp;start, NULL);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">void</span> <span style="font-size: 12pt; color: rgb(0, 0, 0); font-weight: bold;">my_disconnect_callback</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(struct mosquitto *mosq, void *obj, int result)//回调函数</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    run = false;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">void</span> <span style="font-size: 12pt; color: rgb(0, 0, 0); font-weight: bold;">my_publish_callback</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(struct mosquitto *mosq, void *obj, int mid)</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    message_count++;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    //printf(&quot;%d &quot;, message_count);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(message_count == MESSAGE_COUNT){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        gettimeofday(&amp;stop, NULL);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        mosquitto_disconnect((struct mosquitto *)obj);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span><span style="font-size: 12pt; color: rgb(0, 0, 0);">/*函数每调用一次，message_count加1，最大为100000L,后断开连接*/</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">int</span> <span style="font-size: 12pt; color: rgb(0, 0, 0);">create_data</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(void)</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int i;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    FILE *fptr, *rnd;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int rc = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    char buf[MESSAGE_SIZE];</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(0, 0, 0);">fptr = fopen(&quot;msgsps_pub.dat&quot;, &quot;rb&quot;);//在当前目录只读打开文件（二进制打开）</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(fptr){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(0, 0, 0);">fseek(fptr, 0, SEEK_END);//定位光标到文件尾</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if(ftell(fptr) &gt;= MESSAGE_SIZE*MESSAGE_COUNT){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            fclose(fptr);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            return 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }//文件过大关闭返回</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">       </span><span style="font-size: 12pt; color: rgb(0, 0, 0);"> fclose(fptr);//关闭文件指针</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(0, 0, 0);">fptr = fopen(&quot;msgsps_pub.dat&quot;, &quot;wb&quot;);//再次以只写方式二进制打开文件，并将文件数据截为0</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(!fptr) return 1;</span></div><div><span style="font-size: 12pt; color: rgb(0, 0, 0);">    </span><span style="font-size: 12pt; color: rgb(0, 0, 0);">rnd = fopen(&quot;/dev/urandom&quot;, &quot;rb&quot;);///dev/random和/dev/urandom是Linux系统中提供的随机伪设备，这两个设备的任务，是提供永不为空的随机字节数据流。很多解密程序与安全应用程序（如SSH Keys,SSL Keys等）需要它们提供的随机数据流。</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(!rnd){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        fclose(fptr);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return 1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    for(i=0; i&lt;MESSAGE_COUNT; i++){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if(fread(buf, sizeof(char), MESSAGE_SIZE, rnd) != MESSAGE_SIZE){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            rc = 1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if(fwrite(buf, sizeof(char), MESSAGE_SIZE, fptr) != MESSAGE_SIZE){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            rc = 1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    fclose(rnd);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    fclose(fptr);</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">补一下fread和fwrite的功课吧：</span></div><div><span style="font-size: 12pt;">size_t fwrite(const void * restrict ptr,size_t size,size_t nmemb,FILE* restrict fp);</span></div><div><span style="font-size: 12pt;">fwrite(buffer,256,1,fp);</span></div><div><span style="font-size: 12pt;">将256字节数据从buffer写入文件fp;</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">size_t fread(</span><span style="font-size: 12pt;">const void * restrict ptr,size_t size,size_t nmemb,FILE* restrict fp);</span></div><div><span style="font-size: 12pt;">fread(buffer,256,1,fp);</span></div><div><span style="font-size: 12pt;">从fp中取出256字节数据放入buffer中</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">都为二进制</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return rc;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></div><div><span style="font-size: 12pt;">这个函数简单来说就是从</span><span style="font-size: 12pt; color: rgb(0, 0, 0);">/dev/urandom以二进制形式取出100000字节数据放到文件</span><span style="font-size: 12pt; color: rgb(0, 0, 0); font-weight: bold;">msgsps_pub.dat</span><span style="font-size: 12pt; color: rgb(0, 0, 0);">中成功并返回rc=1。</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">int main(int argc, char *argv[])</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct mosquitto *mosq;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int i;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    double dstart, dstop, diff;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    FILE *fptr;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    uint8_t *buf;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt;">buf = malloc(MESSAGE_SIZE*MESSAGE_COUNT);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(!buf){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        printf(&quot;Error: Out of memory.\n&quot;);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return 1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    start.tv_sec = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    start.tv_usec = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    stop.tv_sec = 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    stop.tv_usec = 0;</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(create_data()){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        printf(&quot;Error: Unable to create random input data.\n&quot;);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return 1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    fptr = fopen(&quot;msgsps_pub.dat&quot;, &quot;rb&quot;);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(!fptr){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        printf(&quot;Error: Unable to open random input data.\n&quot;);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return 1;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    fread(buf, sizeof(uint8_t), MESSAGE_SIZE*MESSAGE_COUNT, fptr);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    fclose(fptr);</span></div><div><span style="font-size: 12pt;">//create_data函数生成100000字节数据到文件msgsps_pub.dat中，再将这些数据写道buf中</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">mosquitto_lib_init();//初始化</span></span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> mosq = mosquitto_new(&quot;perftest&quot;, true, NULL);//为指针分配空间，并设置某些成员</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    mosquitto_connect_callback_set(mosq, my_connect_callback);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    mosquitto_disconnect_callback_set(mosq, my_disconnect_callback);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    mosquitto_publish_callback_set(mosq, my_publish_callback);</span></span></div><div><span style="font-size: 12pt;">//为结构mosquitto中对应函数指针赋值</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);"> </span></span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">mosquitto_connect(mosq, &quot;127.0.0.1&quot;, 1883, 600)</span>;//创建连接，ip为127.0.0.1，端口1883，存活时间600秒</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    i=0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt;">while(!mosquitto_loop(mosq, 1, 10) &amp;&amp; run){//</span><span style="font-size: 12pt;">mosquitto_loop()</span><span style="font-size: 12pt;">函数正常执行会返回0</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if(i&lt;MESSAGE_COUNT){</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">           </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">mosquitto_publish(mosq, NULL, &quot;perf/test&quot;, MESSAGE_SIZE,</span> <span style="font-size: 12pt; color: rgb(255, 0, 0);">&amp;buf[i*MESSAGE_SIZE]</span><span style="font-size: 12pt; color: rgb(255, 0, 0);">, 0, false);</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">            i++;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    dstart = (double)start.tv_sec*1.0e6 + (double)start.tv_usec;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    dstop = (double)stop.tv_sec*1.0e6 + (double)stop.tv_usec;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    diff = (dstop-dstart)/1.0e6;</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    printf(&quot;Start: %g\nStop: %g\nDiff: %g\nMessages/s: %g\n&quot;, dstart, dstop, diff, (double)MESSAGE_COUNT/diff);</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);"> mosquitto_destroy(mosq);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    mosquitto_lib_cleanup();</span></span></div><div><span style="font-size: 12pt;">//释放资源</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return 0;</span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></div><div><span style="font-size: 12pt;">//程序将从/dev/urandom获取100000字节数据，并将这些数据按字节发送出去</span></div><div><span style="font-size: 12pt;">函数</span><span style="font-size: 12pt;">mosquitto_connect和函数</span><span style="font-size: 12pt;">mosquitto_disconnec由函数</span><span style="font-size: 12pt;">mosquitto_loop调用</span></div><div><span style="font-size: 12pt;">函数</span><span style="font-size: 12pt;">mosquitto_publish会调用函数</span><span style="font-size: 12pt;">my_publish_callback函数</span></div><hr/><div><span style="font-size: 12pt;">结构体mosquito:</span></div><div><span style="font-size: 12pt;">struct mosquitto {</span></div><div><span style="font-size: 12pt;">...</span></div><div><span style="font-size: 12pt;">    char *address;</span></div><div><span style="font-size: 12pt;">    char *id;</span></div><div><span style="font-size: 12pt;">    char *username;</span></div><div><span style="font-size: 12pt;">    char *password;</span></div><div><span style="font-size: 12pt;">    uint16_t keepalive;</span></div><div><span style="font-size: 12pt;">    uint16_t last_mid;</span></div><div><span style="font-size: 12pt;">    enum mosquitto_client_state state;</span></div><div><span style="font-size: 12pt;">...</span></div><div><span style="font-size: 12pt;">#if defined(WITH_THREADING) &amp;&amp; !defined(WITH_BROKER)</span></div><div><span style="font-size: 12pt;">    pthread_mutex_t callback_mutex;</span></div><div><span style="font-size: 12pt;">...</span></div><div><span style="font-size: 12pt;">#endif</span></div><div><span style="font-size: 12pt;">...</span></div><div><span style="font-size: 12pt;">    void (*on_connect)(struct mosquitto *, void *userdata, int rc);</span></div><div><span style="font-size: 12pt;">    void (*on_disconnect)(struct mosquitto *, void *userdata, int rc)</span><span style="font-size: 12pt;">;</span></div><div><span style="font-size: 12pt;">    void (*on_publish)(struct mosquitto *, void *userdata, int mid);</span></div><div><span style="font-size: 12pt;">    void (*on_message)(struct mosquitto *, void *userdata, const stru</span><span style="font-size: 12pt;">ct mosquitto_message *message);</span></div><div><span style="font-size: 12pt;">    void (*on_subscribe)(struct mosquitto *, void *userdata, int mid,</span><span style="font-size: 12pt;">int qos_count, const int *granted_qos);</span></div><div><span style="font-size: 12pt;">    void (*on_unsubscribe)(struct mosquitto *, void *userdata, int mi</span><span style="font-size: 12pt;">d);</span></div><div><span style="font-size: 12pt;">    void (*on_log)(struct mosquitto *, void *userdata, int level, con</span><span style="font-size: 12pt;">st char *str);</span></div><div><span style="font-size: 12pt;">    //void (*on_error)();</span></div><div><span style="font-size: 12pt;">    char *host;</span></div><div><span style="font-size: 12pt;">    int port;</span></div><div><span style="font-size: 12pt;">...</span></div><div><span style="font-size: 12pt;">};</span></div><hr/><div><span style="font-size: 12pt;">函数</span><span style="font-size: 12pt;">mosquitto_publish：</span></div><div><span style="font-size: 12pt;">函数原型：</span><span style="font-size: 12pt;">int mosquitto_publish(struct mosquitto *mosq, int *mid, const char *t</span></div><div><span style="font-size: 12pt;">opic, int payloadlen, const void *payload, int qos, bool retain)</span></div><div><span style="font-size: 12pt;">根据参数qos值，会有两条执行路径，0或非0。</span></div><div><span style="font-size: 12pt;">函数调用过程比较复杂，调用成功返回0，函数发送主题为topic，长度为</span><span style="font-size: 12pt;">payloadlen的消息</span><span style="font-size: 12pt;">payload，服务质量为qos，retain表示保留信息有无。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">接下来是文件</span><span style="font-size: 12pt;">msgsps_sub.c</span></div><hr/><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">/* This provides a crude manner of testing the performance of a broker in messages/s. */</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;stdbool.h&gt;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;stdint.h&gt;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;stdio.h&gt;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;sys/time.h&gt;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;unistd.h&gt;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;mosquitto.h&gt;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">#include &lt;msgsps_common.h&gt;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">static bool run = true;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">static int message_count = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">static struct timeval start, stop;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">FILE *fptr = NULL;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">void</span> <span style="font-size: 12pt;">my_connect_callback</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(struct mosquitto *mosq, void *obj, int rc)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    printf(&quot;rc: %d\n&quot;, rc);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">void</span> <span style="font-size: 12pt;">my_disconnect_callback</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(struct mosquitto *mosq, void *obj, int result)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    run = false;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">void</span> <span style="font-size: 12pt;">my_message_callback</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(struct mosquitto *mosq, void *obj, const struct mosquitto_message *msg)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(message_count == 0){</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        gettimeofday(&amp;start, NULL);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    fwrite(msg-&gt;payload, sizeof(uint8_t), msg-&gt;payloadlen, fptr);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    message_count++;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(message_count == MESSAGE_COUNT){</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        gettimeofday(&amp;stop, NULL);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        mosquitto_disconnect((struct mosquitto *)obj);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">int main(int argc, char *argv[])</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct mosquitto *mosq;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    double dstart, dstop, diff;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int mid = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    char id[50];</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int rc;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    start.tv_sec = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    start.tv_usec = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    stop.tv_sec = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    stop.tv_usec = 0;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    fptr = fopen(&quot;msgsps_sub.dat&quot;, &quot;wb&quot;);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if(!fptr){</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        printf(&quot;Error: Unable to write to msgsps_sub.dat.\n&quot;);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return 1;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">mosquitto_lib_init();</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    snprintf(id, 50, &quot;msgps_sub_%d&quot;, getpid());</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> mosq = mosquitto_new(id, true, NULL);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> mosquitto_connect_callback_set(mosq, my_connect_callback);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> mosquitto_disconnect_callback_set(mosq, my_disconnect_callback);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">mosquitto_message_callback_set(mosq, my_message_callback);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> mosquitto_connect(mosq, &quot;127.0.0.1&quot;, 1883, 600);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">  </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  mosquitto_subscribe(mosq, &amp;mid, &quot;perf/test&quot;, 0);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    do{</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        rc =</span> <span style="font-size: 12pt; color: rgb(255, 0, 0);">mosquitto_loop</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">(mosq, 1, 10);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }while(rc == MOSQ_ERR_SUCCESS &amp;&amp; run);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    dstart = (double)start.tv_sec*1.0e6 + (double)start.tv_usec;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    dstop = (double)stop.tv_sec*1.0e6 + (double)stop.tv_usec;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    diff = (dstop-dstart)/1.0e6;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    printf(&quot;Start: %g\nStop: %g\nDiff: %g\nMessages/s: %g\n&quot;, dstart, dstop, diff, (double)MESSAGE_COUNT/diff);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">mosquitto_destroy(mosq);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">mosquitto_lib_cleanup();</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    fclose(fptr);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">}</span></span></div><hr/><div><span style="font-size: 12pt;">函数</span><span style="font-size: 12pt;">int mosquitto_subscribe(struct mosquitto *mosq, int *mid, const char *sub, int qos)；</span></div><div><span style="font-size: 12pt;">sub表示订阅的主题。</span></div><div><span style="font-size: 12pt;">订阅主题后，函数</span><span style="font-size: 12pt;">mosquitto_loop检测到消息，就会调用函数</span><span style="font-size: 12pt;">my_message_callback来对获取的消息进行操作。</span></div><div><span style="font-size: 12pt;">mosquitto_loop会在循环开始时调用</span><span style="font-size: 12pt;">my_connect_callback函数，在循环中收到消息调用</span><span style="font-size: 12pt;">my_message_callback，在结束时调用函数</span><span style="font-size: 12pt;">my_disconnect_callback</span></div><div><span style="font-size: 12pt;">最后，此函数将收到的消息以二进制形式写入到文件中。</span></div><hr/><div><span style="font-size: 12pt;">库函数编程实现MQTT通信示例，使用本地环回测试测试：</span></div></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">开启broker：</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>zhanghang@Ubuntu-14:~$ mosquitto</div></div><div><span style="font-size: 12pt;">执行命令后，主机的1883号端口会开启。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">客户端程序(publish)</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#include &lt;stdbool.h&gt;</div><div>#include &lt;stdint.h&gt;</div><div>#include &lt;stdio.h&gt;</div><div>#include &lt;sys/time.h&gt;</div><div>#include &lt;unistd.h&gt;</div><div>#include &lt;mosquitto.h&gt;</div><div>#include &lt;string.h&gt;</div><div>#include &lt;stdlib.h&gt;</div><div>#include &lt;msgsps_common.h&gt;</div><div><br/></div><div><br/></div><div>#define MAXSIZE 1024</div><div>#define HOST &quot;localhost&quot;</div><div>#define PORT 1883</div><div>#define KEEPALIVE 60</div><div>#define TOPIC &quot;temp&quot;</div><div><br/></div><div>//此函数会在mosquitto_loop_start函数后执行</div><div>void my_connect_callback(struct mosquitto *mosq, void *obj, int rc)</div><div>{</div><div>    printf(&quot;connected\n&quot;);</div><div>}</div><div>//此函数会在loop结束时执行，此处并不会用到</div><div>void my_disconnect_callback(struct mosquitto *mosq, void *obj, int result)</div><div>{</div><div>    printf(&quot;disconnect\n&quot;);</div><div>}</div><div><br/></div><div>int main(void)</div><div>{</div><div>    struct mosquitto *mosq;</div><div>    int loop=0;</div><div>    char buf_s[]={&quot;hello&quot;};</div><div><br/></div><div><br/></div><div>    mosquitto_lib_init();</div><div>    mosq = mosquitto_new(NULL, true, NULL);</div><div>    mosquitto_connect_callback_set(mosq,my_connect_callback);</div><div>    mosquitto_disconnect_callback_set(mosq,my_disconnect_callback);</div><div>    mosquitto_connect(mosq,HOST,PORT,KEEPALIVE);</div><div><br/></div><div>    loop=mosquitto_loop_start(mosq);//use connect callback and disconnect callback</div><div>    if(loop!=MOSQ_ERR_SUCCESS)</div><div>    {</div><div>        printf(&quot;mosquitto_loop_start failure\n&quot;);</div><div>        return -1;</div><div>    }</div><div>    sleep(1);</div><div>    while(1)</div><div>    {</div><div>        int i=mosquitto_publish(mosq,NULL,TOPIC,strlen(buf_s)+1,&amp;buf_s,0,0);</div><div>        if(i!=0)</div><div>        {</div><div>            printf(&quot;mosquitto_publish failure\n&quot;);</div><div>            return -1;</div><div>        }</div><div>        printf(&quot;topic [%s] message [%s] publish successfully\n&quot;,TOPIC,buf_s);</div><div>        sleep(3);</div><div>    }</div><div>//循环发布消息，每次检测是否发布成功，如果成功则打印成功信息，否则退出</div><div>    mosquitto_destroy(mosq);</div><div>    mosquitto_lib_cleanup();//释放资源</div><div>    return 0;</div><div>}</div></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">客户端程序(subscribe)</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#include &lt;stdbool.h&gt;</div><div>#include &lt;stdint.h&gt;</div><div>#include &lt;stdio.h&gt;</div><div>#include &lt;sys/time.h&gt;</div><div>#include &lt;unistd.h&gt;</div><div>#include &lt;mosquitto.h&gt;</div><div><br/></div><div><br/></div><div>#include &lt;msgsps_common.h&gt;</div><div><br/></div><div><br/></div><div>#define HOST &quot;localhost&quot;</div><div>#define PORT 1883</div><div>#define KEEPALIVE 60</div><div>#define TOPIC &quot;temp&quot;</div><div><br/></div><div><br/></div><div>void my_connect_callback(struct mosquitto *mosq, void *userdata, int result)</div><div>{</div><div>    printf(&quot;connected\n&quot;);</div><div>/*    if(!result)</div><div>    {</div><div>        mosquitto_subscribe(mosq,NULL,TOPIC,0);</div><div>    }*/</div><div>}</div><div>//由于my_connect_callback函数会首先调用，，可以在此函数中执行订阅工作，也可以在loop_forever之前调用subscribe函数</div><div><br/></div><div>void my_disconnect_callback(struct mosquitto *mosq, void *userdata, int result)</div><div>{</div><div>    printf(&quot;disconnected\n&quot;);</div><div>}</div><div>//此处不会用到</div><div><br/></div><div>void my_message_callback(struct mosquitto *mosq, void *userdata, const struct mosquitto_message *message)</div><div>{</div><div>    if(message-&gt;payloadlen)</div><div>    {</div><div>        printf(&quot;revieve topic message [%s]\n&quot;,(char *)message-&gt;payload);</div><div>    }</div><div>}</div><div>//如果收到消息，则打印消息</div><div><br/></div><div>int main()</div><div>{</div><div>    struct mosquitto *mosq;</div><div>    mosquitto_lib_init();</div><div>    mosq = mosquitto_new(NULL, true, NULL);</div><div>    mosquitto_connect_callback_set(mosq,my_connect_callback);</div><div>    mosquitto_disconnect_callback_set(mosq,my_disconnect_callback);</div><div>    mosquitto_message_callback_set(mosq,my_message_callback);</div><div><br/></div><div><br/></div><div>    if(mosquitto_connect(mosq,HOST,PORT,KEEPALIVE))</div><div>    {</div><div>        printf(&quot;mosquitto_connect failure\n&quot;);</div><div>        return -1;</div><div>    }</div><div><br/></div><div><br/></div><div>    mosquitto_subscribe(mosq,NULL,TOPIC,0);</div><div>    mosquitto_loop_forever(mosq,-1,1);//此函数首先会调用my_connect_callback函数，之后循环检测是否收到消息，如果收到则调用my_message_callbcak函数</div><div><br/></div><div><br/></div><div>    mosquitto_destroy(mosq);</div><div>    mosquitto_lib_cleanup();//释放资源</div><div>    return 0;</div><div>}</div></div><div><span style="font-size: 12pt;">运行结果如下：</span></div><div><span style="font-size: 12pt;"><img src="mosquitto库MQTT编程_files/Image.png" type="image/png" data-filename="Image.png"/></span><span style="font-size: 12pt;"><img src="mosquitto库MQTT编程_files/Image [1].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">通常情况下，broker和publish，subscribe会运行在三个各不相同的主机上，broker通常运行在服务器上，服务器有全球ip，可被私有ip访问，如果服务器在NAT路由器下，例NAT路由器的全球域名为a.b.c，服务器ip为192.168.0.168，在NAT路由器下端口映射为a.b.c：4444-&gt;192.168.0.168：22,在服务器下搭建mqtt环境，需在NAT路由器下设置第二个端口映射：a.b.c:xxx-&gt;192.168.0.168:1883。接下来我们可以将订阅和发布都指向此broker,这样只要是发布到此broker的消息，订阅端订阅相应话题,即可收到消息。此外，publish和subscribe程序都要将ip和端口设置为a.b.c:xxx。</span></div><div><br/></div></span>
</div></body></html> 
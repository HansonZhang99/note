<html>
<head>
  <title>aliyun搭建MQTT</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="784"/>
<h1>aliyun搭建MQTT</h1>

<div>
<span><div><span style="font-size: 12pt;">在阿里云上创建一个简单的产品和其下设备，并能使用mqtt.fx工具来测试对于此设备的topic的订阅和发布。</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">进入到aliyun官网，并注册一个账号。</span></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">在产品服务栏，进入到物联网平台。</span></font></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image.png" type="image/png" data-filename="Image.png" width="512"/></span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [1].png" type="image/png" data-filename="Image.png" width="514"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">创建一个产品，先有产品后有设备。</span></span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [2].png" type="image/png" data-filename="Image.png" width="253"/></span></div><div><span style="font-size: 12pt;">产品名称和分类可自定义。</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [3].png" type="image/png" data-filename="Image.png" width="437"/></span></div><div><span style="font-size: 12pt;">点击产品可以看到其详细信息和可执行功能</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [4].png" type="image/png" data-filename="Image.png" width="437"/></span></div><div><span style="font-size: 12pt;">接下来定义产品的功能：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [5].png" type="image/png" data-filename="Image.png" width="378"/></span></div><div><span style="font-size: 12pt;">进入到功能定义，并添加功能：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [6].png" type="image/png" data-filename="Image.png" width="417"/></span></div><div><span style="font-size: 12pt;">此时产品”温度获取服务”下添加了一个功能：“当前温度”</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [7].png" type="image/png" data-filename="Image.png" width="453"/></span></div><div><span style="font-size: 12pt;">我们可以对其编辑：</span></div><div><span style="font-size: 12pt;">比如我在这里将华氏温度改为了摄氏温度：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [8].png" type="image/png" data-filename="Image.png" width="220"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">接下来在产品下创建一个设备</span></span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [9].png" type="image/png" data-filename="Image.png" width="438"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [10].png" type="image/png" data-filename="Image.png" width="432"/></span></div><div><span style="font-size: 12pt;">在这里我们选择刚才创建的产品，并在其下创建一个设备，因为我后面将进行的DS18B20的温度操作，这里创建了DS18B20设备，可随意设置。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">创建完成后，会弹出提示框：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [11].png" type="image/png" data-filename="Image.png" width="411"/></span></div><div><span style="font-size: 12pt;">这些信息会在后面用到，可以先复制到文本中，当然也可以在设备信息里查看。</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [12].png" type="image/png" data-filename="Image.png" width="424"/></span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [13].png" type="image/png" data-filename="Image.png" width="425"/></span></div><div><span style="font-size: 12pt;">现在产品“温度获取服务下”有设备”DS18B20“，并对产品进行了一个功能的定义。此时我们就要测试该产品下的设备DS18B20的mqtt订阅和发布服务。</span></div><div><span style="font-size: 12pt;">记下</span><span style="font-size: 12pt; font-weight: bold;">设备</span><span style="font-size: 12pt;">DS18B20下Topic列表下的发布和订阅栏。</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [14].png" type="image/png" data-filename="Image.png" width="384"/></span></div><div><span style="font-size: 12pt;">此时我们记下的信息就有这些：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>{</div><div>  &quot;ProductKey&quot;: &quot;a17i4DkIYtW&quot;,</div><div>  &quot;DeviceName&quot;: &quot;DS18B20&quot;,</div><div>  &quot;DeviceSecret&quot;: &quot;uug19VsZveTVnQhpWAwoulzeQBXhz8TR&quot;</div><div>}</div><div><br/></div><div><br/></div><div>订阅：/sys/a17i4DkIYtW/DS18B20/thing/service/property/set</div><div>发布：/sys/a17i4DkIYtW/DS18B20/thing/event/property/post</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">此时服务器端的配置已经完成，接下来就是使用mqtt工具来测试服务器端的功能。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">下载mqtt.fx工具进行测试：</span></div><div><span style="font-size: 12pt;">下载地址：</span><span style="font-size: 12pt;"><a href="http://mqttfx.jensd.de/index.php/download" style="font-size: 12pt;">http://mqttfx.jensd.de/index.php/download</a></span></div><div><br/></div><div><span style="font-size: 12pt;">打开mqtt.fx软件：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [15].png" type="image/png" data-filename="Image.png" width="363"/></span></div><div><span style="font-size: 12pt;">profile Name可以随意设置，</span></div><div><span style="font-size: 12pt;">域名的设置可以查看阿里云物联网平台文档：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [16].png" type="image/png" data-filename="Image.png" width="354"/></span></div><div><span style="font-size: 12pt;">查看地域的Region ID：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [17].png" type="image/png" data-filename="Image.png" width="379"/></span></div><div><span style="font-size: 12pt;">并在阿里云官网查看可用区：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [18].png" type="image/png" data-filename="Image.png" width="354"/></span></div><div><span style="font-size: 12pt;">这里只有上海可以使用。</span></div><div><span style="font-size: 12pt;">再参考之前保存的一些信息。</span></div><div><span style="font-size: 12pt;">所以域名的设置为：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>域名（Broker Address): a17i4DkIYtW.iot-as-mqtt.cn-shanghai.aliyuncs.com</div><div>端口：1883</div></div><div><span style="font-size: 12pt;">接下来设置client id，username和password：</span></div><div><span style="font-size: 12pt;">参考阿里云物联网平台文档：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [19].png" type="image/png" data-filename="Image.png" width="358"/></span></div><div><span style="font-size: 12pt;">在这里，clientId，timestamp，signmethod都是我们自己设置的，而deviceName和deviceSecret是我们之前保存的信息。</span></div><div><span style="font-size: 12pt;">所以这里的设置为：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>clientid: 12345|securemode=3,signmethod=hmacsha1,timestamp=789|</div></div><div><span style="font-size: 12pt;">用户名：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>username: DS18B20&amp;a17i4DkIYtW</div></div><div><span style="font-size: 12pt;">密码:</span></div><div><span style="font-size: 12pt;">在文档里clientid指明了signmethod为hmacsha1,即哈希sha1算法，productKey</span></div><div><span style="font-size: 12pt;">此处使用的是mqtt.fx工具，并不能直接带入hmacsha1(&quot;...&quot;,&quot;...&quot;)</span></div><div><span style="font-size: 12pt;">所以密码需要我们手动去算：</span></div><div><span style="font-size: 12pt;">算法地址：</span><span style="font-size: 12pt;"><a href="https://1024tools.com/hmac" style="font-size: 12pt;">https://1024tools.com/hmac</a></span></div><div><img src="aliyun搭建MQTT_files/Image [20].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: 12pt; font-weight: bold;">消息为：clientId12345deviceName</span><span style="font-size: 12pt; font-weight: bold;">DS18B20</span><span style="font-size: 12pt; font-weight: bold;">productKey</span><span style="font-size: 12pt; font-weight: bold;">a17i4DkIYtWtimestamp789</span></div><div><span style="font-size: 12pt; font-weight: bold;">密钥为：</span><span style="font-size: 12pt; font-weight: bold;">uug19VsZveTVnQhpWAwoulzeQBXhz8TR（这是之前保存的第三个信息）</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [21].png" type="image/png" data-filename="Image.png" width="471"/></span></div><div><span style="font-size: 12pt;">计算结果即password：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">password:  </span>01dfcb6ae1f52db5bf37c7acd0875a8bcb0b36df</div></div><div><span style="font-size: 12pt;">接下来在mqtt.fx设置中添加我们刚才推出的信息：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [22].png" type="image/png" data-filename="Image.png" width="373"/></span></div><div><span style="font-size: 12pt;">点击Ok，再点击connect：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [23].png" type="image/png" data-filename="Image.png" width="362"/></span></div><div><span style="font-size: 12pt;">灯变为绿色表示成功连接到阿里云服务器</span></div><div><span style="font-size: 12pt;">我们在subscribe栏中订阅我们之前保存的话题（一定要点订阅）：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [24].png" type="image/png" data-filename="Image.png" width="332"/></span></div><div><span style="font-size: 12pt;">我们在阿里云服务器端进入到产品的在线调试，也可以由设备进入。</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [25].png" type="image/png" data-filename="Image.png" width="431"/></span></div><div><span style="font-size: 12pt;">选择设备DS18B20</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [26].png" type="image/png" data-filename="Image.png" width="442"/></span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [27].png" type="image/png" data-filename="Image.png" width="445"/></span></div><div><span style="font-size: 12pt;">等一下，尴尬发现我们之前选择的“当前温度”选项只能自动获取温度，由于我们并没有获取温度到服务器上，所以每次发送的数据都为“{}”即空...</span></div><div><span style="font-size: 12pt;">现在在产品“温度获取服务”下再创建一个功能--颜色状态：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [28].png" type="image/png" data-filename="Image.png" width="412"/></span></div><div><span style="font-size: 12pt;">我们再测试一下：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [29].png" type="image/png" data-filename="Image.png" width="489"/></span></div><div><span style="font-size: 12pt;">发送成功后，我们在接收端可以收到消息：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [30].png" type="image/png" data-filename="Image.png" width="380"/></span></div><div><span style="font-size: 12pt;">服务器实时日志显示消息发送成功</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">再进行发布测试，这里也要用JSON格式发送数据到服务器：</span></div><div><span style="font-size: 12pt;">可以直接copy之前收到的数据,添加温度信息,记得逗号结尾：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [31].png" type="image/png" data-filename="Image.png" width="440"/></span></div><div><img src="aliyun搭建MQTT_files/Image [32].png" type="image/png" data-filename="Image.png" width="440"/></div><div><span style="font-size: 12pt;">点击publish，打开服务器产品下设备的运行状态，服务器接收到我们刚才发送的消息。</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [33].png" type="image/png" data-filename="Image.png" width="493"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">至此，测试完毕。接下来会研究aliyun的mqtt c-sdk提供的库函数编程实现消息到服务器产品设备的订阅和发布。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">PS:</span></div><div><span style="font-size: 12pt;">产品：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [34].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;">设备：</span></div><div><span style="font-size: 12pt;"><img src="aliyun搭建MQTT_files/Image [35].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;">两者有相同的producekey,不同的secert，设备的ip地址为我们创建该设备时所在网络的公有ip，当有客户端连接到该设备时，设备才会在线，否则会一直处于离线状态。我们订阅和发布的消息的标识符可在产品的功能定义中找到。订阅和发布的主题的topic可在设备的topic列表找到，可以发布同一topic的一个或多个标识符数据，前提是该标识符存在，否则会出错。发布和订阅必须使用JSON格式，否则也会出错。</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">ref：</span> <a href="https://blog.csdn.net/qq997758497/article/details/90757307" style="font-size: 12pt;">https://blog.csdn.net/qq997758497/article/details/90757307</a></div><div><a href="https://www.cnblogs.com/nanqiang/p/6735025.html" style="font-size: 12pt;">https://www.cnblogs.com/nanqiang/p/6735025.html</a></div><div><a href="https://www.cnblogs.com/catgatp/p/6379955.html" style="font-size: 12pt;">https://www.cnblogs.com/catgatp/p/6379955.html</a></div></span>
</div></body></html> 
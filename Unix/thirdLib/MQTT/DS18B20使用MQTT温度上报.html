<html>
<head>
  <title>DS18B20使用MQTT温度上报</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="567"/>
<h1>DS18B20使用MQTT温度上报</h1>

<div>
<span><div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">前提条件:</span></font></div><div><span style="font-size: 12pt;">        <b>完成paho库的交叉编译，mosquitto库交叉编译，以及w1总线下的ds18b20模块的使能，USB驱动使能，有线网卡或无线网卡STA模式的使能。</b></span></div><hr/><div><span style="font-size: 12pt;">paho库提供库函数编程实现温度的获取，和mqtt消息的发布在主机上编译程序移植到开发板。</span></div><div><br/></div><div><span style="font-size: 12pt;">mosquitto工具用于开启broker，并开启端口1883（mqtt固定端口），mosquitto会运行在开发板上，开发板上使用paho库的函数实现温度获取并发布，其他任意网络主机使用mosquitto或者paho库函数订阅话题可收到消息，实现温度获取。</span></div><div><span style="font-size: 12pt;">mosquitto具体作用：</span> <span style="font-size: 12pt;"><a href="https://blog.csdn.net/qq_43260665/article/details/88369355" style="font-size: 12pt;">https://blog.csdn.net/qq_43260665/article/details/88369355</a></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">linux内核自带ds18b20的驱动，我们只用添加相应的管脚配置及平台设备，并使能内核w1子系统相应模块，编译移植内核，在</span><span style="font-size: 12pt;">/sys/devices/w1 bus master/</span><span style="font-size: 12pt;">28-031604ce05ff下的w1_slave文件中可看到温度信息。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">开发板作为服务器即mqtt的发布端，需要能被外网的主机访问。使能无线网卡的STA模式，连接上级有公网的路由器，并在路由器下开启端口转发，如我的端口转发：</span></div><div><span style="font-size: 12pt;"><img src="DS18B20使用MQTT温度上报_files/Image.png" type="image/png" data-filename="Image.png" title="Attachment"/></span></div><div><span style="font-size: 12pt;">映射到mqtt1883号端口，开发板无线网卡ip为192.168.0.168，这样，外网的主机访问我们路由器公网的11111号端口会直接映射到开发板的1883号端口，即可获取温度信息。</span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">1.移植mosquitto工具到开发板</span></span></div><div><span style="font-size: 12pt;">        将交叉编译生成的</span><span style="font-size: 12pt;">mosquitto_sub,</span><span style="font-size: 12pt;">mosquitto_pub,</span><span style="font-size: 12pt;">mosquitto工具以及配置文件</span><span style="font-size: 12pt;">mosquitto.conf</span><span style="font-size: 12pt;">移植到开发板，并运行他们，提示缺少动态库，将对应动态库从主机的对应交叉编译库中移植。</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">2.移植paho程序必要动态库到开发板</span></span></div><div><span style="font-size: 12pt;">        随便移植一个paho库中build/output/samples下的可执行文件到开发板，运行，提示缺少库，</span><span style="font-size: 12pt;">将对应动态库从主机的对应交叉编译库中移植。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">将移植的动态库放到开发板的/usr/lib或lib下，mosquitto工具放到usr/bin下或bin下。</span></div><div><br/></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">3.测试mqtt是否能正常运行</span></span></div><div><span style="font-size: 12pt;">使用环回测试测试：</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">使能环回测试：</span></span></div><div><span style="font-size: 12pt;">ifconfig lo 127.0.0.1 ip</span></div><div><span style="font-size: 12pt;">使能环回测试，能在ifconfig -a下看到lo。</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">开启broker服务：</span></span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">./mosquitto -c /etc/mosquitto.conf -v</span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">命令netstat -tlnp查看端口状况：</span></div><div><span style="font-size: 12pt; font-family: &quot;Microsoft YaHei&quot;;">tcp        0      0 0.0.0.0:1883            0.0.0.0:*               LISTEN      1313/mosquitto</span></div><div><span style="font-size: 12pt; font-family: &quot;Microsoft YaHei&quot;;">正常开启</span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 16px; font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">测试订阅发布：</span></span></div><div><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 12pt; font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">订阅：</span><span style="font-size: 12pt;"> mosquitto_sub  -h 127.0.0.1 -p 1883 -v -t testtopic</span></div><div><span style="font-size: 12pt;">发布： </span><span style="font-size: 12pt;">mosquitto_pub  -h 127.0.0.1 -p 1883 -t testtopic -m helloworld     </span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">发布成功后会在订阅端收到订阅消息：</span><span style="font-size: 12pt;">testtopic helloworld</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">4.测试mqtt服务器</span></span></div><div><span style="font-size: 12pt;">首先确定开发板使用无线网卡STA模块是否正确连上路由器和网络：</span></div><div><span style="font-size: 12pt;">关于联网在移植rt3070时讲过</span></div><div><span style="font-size: 12pt;">ping 192.168.0.1（网关）</span></div><div><span style="font-size: 12pt;">ping</span> <a href="http://www.baidu.com/" style="font-size: 12pt;">www.baidu.com</a><span style="font-size: 12pt;"> (上网）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">确认连接后，测试服务器：</span></div><div><span style="font-size: 12pt;">在开发板：</span></div><div><span style="font-size: 12pt;">mosquitto_pub  -h 192.168.0.168 -p 1883 -t testtopic -m helloworld 发布消息</span></div><div><span style="font-size: 12pt;">在外网主机，不同网络：</span></div><div><span style="font-size: 12pt;">mosquitto_sub  -h</span>  <span style="font-size: 12px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(64, 64, 64); font-family: Arial; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="font-size: 12pt;">路由器公网ip  -p 11111 -v -t testtopic</span></div><div><span style="font-size: 12pt; font-family: &quot;Microsoft YaHei&quot;;">多次重复，可看到外网主机能获取订阅的消息。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-family: &quot;Microsoft YaHei&quot;;">接下来就是利用paho库编写程序来发布温度了。。。订阅端可以直接用mosquito订阅接收消息，当然也可以编程实现。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><br/></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div></div><div><br/></div></span>
</div></body></html> 
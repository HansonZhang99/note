<html>
<head>
  <title>7.串口驱动分析（四）write</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="569"/>
<h1>7.串口驱动分析（四）write</h1>

<div>
<span><div><span style="font-size: 12pt;">写操作函数如下：</span></div><div><span style="font-size: 12pt;">static ssize_t tty_write(struct file *file, const char __user *buf,</span></div><div><span style="font-size: 12pt;">                        size_t count, loff_t *ppos)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct inode *inode = file-&gt;f_path.dentry-&gt;d_inode;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_struct *tty = file_tty(file);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct tty_ldisc *ld;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    ssize_t ret;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (tty_paranoia_check(tty, inode, &quot;tty_write&quot;))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return -EIO;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (!tty || !tty-&gt;ops-&gt;write ||</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        (test_bit(TTY_IO_ERROR, &amp;tty-&gt;flags)))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            return -EIO;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Short term debug to catch buggy drivers */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (tty-&gt;ops-&gt;write_room == NULL)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        printk(KERN_ERR &quot;tty driver %s lacks a write_room method.\n&quot;,</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            tty-&gt;driver-&gt;name);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">  </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  ld = tty_ldisc_ref_wait(tty);/*获取tty的线路规程域*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (!ld-&gt;ops-&gt;write)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        ret = -EIO;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    else</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">ret = do_tty_write(ld-&gt;ops-&gt;write, tty, file, buf, count);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    tty_ldisc_deref(ld);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return ret;</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">看到函数:</span></div><div><span style="font-size: 12pt;">static inline ssize_t do_tty_write(</span></div><div><span style="font-size: 12pt;">    ssize_t (*write)(struct tty_struct *, struct file *, const unsigned char *, size_t),</span></div><div><span style="font-size: 12pt;">    struct tty_struct *tty,</span></div><div><span style="font-size: 12pt;">    struct file *file,</span></div><div><span style="font-size: 12pt;">    const char __user *buf,</span></div><div><span style="font-size: 12pt;">    size_t count)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    ssize_t ret, written = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned int chunk;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    ret = tty_write_lock(tty, file-&gt;f_flags &amp; O_NDELAY);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (ret &lt; 0)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return ret;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    chunk = 2048;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (test_bit(TTY_NO_WRITE_SPLIT, &amp;tty-&gt;flags))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        chunk = 65536;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (count &lt; chunk)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        chunk = count;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* write_buf/write_cnt is protected by the atomic_write_lock mutex */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (tty-&gt;write_cnt &lt; chunk) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        unsigned char *buf_chunk;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (chunk &lt; 1024)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            chunk = 1024;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">    buf_chunk = kmalloc(chunk, GFP_KERNEL);/*为内核write缓冲区分配内存*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (!buf_chunk) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            ret = -ENOMEM;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            goto out;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        kfree(tty-&gt;write_buf);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">    tty-&gt;write_cnt = chunk;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">        tty-&gt;write_buf = buf_chunk;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Do the write .. */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    for (;;) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        size_t size = count;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (size &gt; chunk)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            size = chunk;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        ret = -EFAULT;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">      </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">  if (copy_from_user(tty-&gt;write_buf, buf, size))/*数据从用户空间到内核空间的拷贝*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">ret = write(tty, file, tty-&gt;write_buf, size);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (ret &lt;= 0)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        written += ret;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        buf += ret;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        count -= ret;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (!count)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        ret = -ERESTARTSYS;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (signal_pending(current))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        cond_resched();</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (written) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        struct inode *inode = file-&gt;f_path.dentry-&gt;d_inode;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        inode-&gt;i_mtime = current_fs_time(inode-&gt;i_sb);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        ret = written;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">out:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    tty_write_unlock(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return ret;</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">调用而write函数，将调用线路规程的write函数：</span></div><div><span style="font-size: 12pt;">static ssize_t n_tty_write(struct tty_struct *tty, struct file *file,</span></div><div><span style="font-size: 12pt;">               const unsigned char *buf, size_t nr)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    const unsigned char *b = buf;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> DECLARE_WAITQUEUE(wait, current);/*初始化等待队列*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int c;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    ssize_t retval = 0;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Job control check -- must be done at start (POSIX.1 7.1.1.4). */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (L_TOSTOP(tty) &amp;&amp; file-&gt;f_op-&gt;write != redirected_tty_write) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        retval = tty_check_change(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (retval)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            return retval;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* Write out any echoed characters that are still pending */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    process_echoes(tty);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">add_wait_queue(&amp;tty-&gt;write_wait, &amp;wait);/*加入等待队列*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    while (1) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">set_current_state(TASK_INTERRUPTIBLE);/*可中断模式*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (signal_pending(current)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            retval = -ERESTARTSYS;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (tty_hung_up_p(file) || (tty-&gt;link &amp;&amp; !tty-&gt;link-&gt;count)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            retval = -EIO;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (O_OPOST(tty) &amp;&amp; !(test_bit(TTY_HW_COOK_OUT, &amp;tty-&gt;flags))) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            while (nr &gt; 0) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                ssize_t num = process_output_block(tty, b, nr);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (num &lt; 0) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    if (num == -EAGAIN)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                        break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    retval = num;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    goto break_out;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                b += num;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                nr -= num;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (nr == 0)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                c = *b;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (process_output(c, tty) &lt; 0)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                b++; nr--;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            if (tty-&gt;ops-&gt;flush_chars)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                tty-&gt;ops-&gt;flush_chars(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        } else {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            while (nr &gt; 0) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">               </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> c = tty-&gt;ops-&gt;write(tty, b, nr);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (c &lt; 0) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    retval = c;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    goto break_out;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                if (!c)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                    break;</span></span></div><div><span style="font-size: 12pt; color: rgb(168, 168, 168);">                b += c;</span><span style="font-size: 12pt; color: rgb(168, 168, 168);">                </span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                nr -= c;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (!nr)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (file-&gt;f_flags &amp; O_NONBLOCK) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            retval = -EAGAIN;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">schedule();/*睡眠*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">break_out:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    __set_current_state(TASK_RUNNING);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    remove_wait_queue(&amp;tty-&gt;write_wait, &amp;wait);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (b - buf != nr &amp;&amp; tty-&gt;fasync)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        set_bit(TTY_DO_WRITE_WAKEUP, &amp;tty-&gt;flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return (b - buf) ? b - buf : retval;</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;">调用到核心层的uart_write函数：</span></div><div><span style="font-size: 12pt;">static int uart_write(struct tty_struct *tty,</span></div><div><span style="font-size: 12pt;">                    const unsigned char *buf, int count)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct uart_state *state = tty-&gt;driver_data;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct uart_port *port;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">struct circ_buf *circ;/*循环缓冲区*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long flags;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int c, ret = 0;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /*</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * This means you called this function _after_ the port was</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * closed.  No cookie for you.</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     */</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (!state) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        WARN_ON(1);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return -EL3HLT;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    port = state-&gt;uart_port;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">circ = &amp;state-&gt;xmit;/*state-&gt;xmit域在uart_open函数中的uart_startup函数中为武器分配空间，并将其head和tail域初始化为0*/</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (!circ-&gt;buf)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        return 0;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_lock_irqsave(&amp;port-&gt;lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    while (1) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        c = CIRC_SPACE_TO_END(circ-&gt;head, circ-&gt;tail, UART_XMIT_SIZE);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (count &lt; c)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            c = count;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (c &lt;= 0)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">memcpy(circ-&gt;buf + circ-&gt;head, buf, c);</span></span><span style="font-size: 12pt; color: rgb(255, 0, 0);">/*将之前存储在tty_struct-&gt;write_buf中的数据复制到circ-&gt;buf中*/</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">        circ-&gt;head = (circ-&gt;head + c) &amp; (UART_XMIT_SIZE - 1);/*移动head指针*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        buf += c;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        count -= c;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        ret += c;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_unlock_irqrestore(&amp;port-&gt;lock, flags);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">uart_start(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return ret;</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">看到函数uart_start：</span></div><div><span style="font-size: 12pt;">static void uart_start(struct tty_struct *tty)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct uart_state *state = tty-&gt;driver_data;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct uart_port *port = state-&gt;uart_port;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    unsigned long flags;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_lock_irqsave(&amp;port-&gt;lock, flags);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">__uart_start(tty);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    spin_unlock_irqrestore(&amp;port-&gt;lock, flags);</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;">看到__uart_start：</span></div><div><span style="font-size: 12pt;">static void __uart_start(struct tty_struct *tty)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct uart_state *state = tty-&gt;driver_data;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct uart_port *port = state-&gt;uart_port;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    if (!uart_circ_empty(&amp;state-&gt;xmit) &amp;&amp; state-&gt;xmit.buf &amp;&amp;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">        !tty-&gt;stopped &amp;&amp; !tty-&gt;hw_stopped)/*循环缓冲区存在，并且tty的stopped域和hard_ward stopped域不为1*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">port-&gt;ops-&gt;start_tx(port);</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;">调用到了uart_port的start_tx函数：</span></div><div><span style="font-size: 12pt;">static void s3c24xx_serial_start_tx(struct uart_port *port)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct s3c24xx_uart_port *ourport = to_ourport(port);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    if (!tx_enabled(port)) {</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        if (port-&gt;flags &amp; UPF_CONS_FLOW)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">            s3c24xx_serial_rx_disable(port);</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">        enable_irq(ourport-&gt;tx_irq);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">        tx_enabled(port) = 1;/*使能中断，并没有真正的发生中断*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在n_tty_write函数中，将进程加入到等待队列，等待队列的唤醒我们还没看到，在open函数被调用的最后，执行了tx-&gt;irq中断申请，其对应的中断处理函数如下：</span></div><div><span style="font-size: 12pt;">static irqreturn_t s3c24xx_serial_tx_chars(int irq, void *id)</span></div><div><span style="font-size: 12pt;">{</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct s3c24xx_uart_port *ourport = id;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct uart_port *port = &amp;ourport-&gt;port;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    struct circ_buf *xmit = &amp;port-&gt;state-&gt;xmit;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    int count = 256;</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> if (port-&gt;x_char) {/*此条件不会执行，port-&gt;x_char域在uart_register_driver时调用tty_port_init被置为0*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        wr_regb(port, S3C2410_UTXH, port-&gt;x_char);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        port-&gt;icount.tx++;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        port-&gt;x_char = 0;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        goto out;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* if there isn't anything more to transmit, or the uart is now</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">     * stopped, disable the uart and exit</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    */</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    if (uart_circ_empty(xmit) || uart_tx_stopped(port)) {/*循环缓冲区存在，且port没有被设置为stop*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        s3c24xx_serial_stop_tx(port);</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        goto out;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    /* try and drain the buffer... */</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    </span><span style="font-size: 12pt; color: rgb(255, 0, 0);">while (!uart_circ_empty(xmit) &amp;&amp; count-- &gt; 0) {/*循环缓冲区不为空，并且数据最大数量count不为0*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        </span><span style="font-size: 12pt; color: rgb(168, 168, 168);">if (rd_regl(port, S3C2410_UFSTAT) &amp; ourport-&gt;info-&gt;tx_fifofull)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">                break;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">       </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> wr_regb(port, S3C2410_UTXH, xmit-&gt;buf[xmit-&gt;tail]);/*向寄存器写入xmit-&gt;buf域的数据*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">       </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> xmit-&gt;tail = (xmit-&gt;tail + 1) &amp; (UART_XMIT_SIZE - 1);/*tail域更新*/</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">        port-&gt;icount.tx++;</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    }</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">   </span><span style="font-size: 12pt; color: rgb(255, 0, 0);"> if (uart_circ_chars_pending(xmit) &lt; WAKEUP_CHARS)</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">        uart_write_wakeup(port);/*缓冲区数据太少，唤醒等待队列*/</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">    if (uart_circ_empty(xmit))</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0);">        s3c24xx_serial_stop_tx(port);/*缓冲区为空，就stop port*/</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">out:</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168);">    return IRQ_HANDLED;</span></span></div><div><span style="font-size: 12pt;">}</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">函数调用层级关系：</span></div><div><span style="font-size: 12pt;">tty_write-&gt;do_tty_write为write_buf分配内存，并从用户空间取数据到write_buf中，该循环一直执行。</span></div><div><span style="font-size: 12pt;">调用n_tty_write函数，加入等待队列，在调用uart_write函数后，调用schedlue函数进入睡眠。</span></div><div><span style="font-size: 12pt;">uart_write函数将write_buf中的数据拷贝到circ-&gt;buf中，调用uart_start函数。</span></div><div><span style="font-size: 12pt;">uart_start函数最终调用</span><span style="font-size: 12pt;">port-&gt;ops-&gt;start_tx(port)也就是</span><span style="font-size: 12pt;">s3c24xx_serial_start_tx函数，使能tx-&gt;irq中断，使能后，中断处理函数</span><span style="font-size: 12pt;">s3c24xx_serial_tx_chars就会执行，</span><span style="font-size: 12pt;">将数据发送到寄存器，最后由硬件发出。如果数据小于</span><span style="font-size: 12pt;">WAKEUP_CHARS，就唤醒等待队列，继续从write_buf中拷贝数据到circ-&gt;buf中，然后检测到circ-&gt;buf满了，就再次调用schedlue让n_tty_write进入睡眠。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">参考：</span> <span style="font-size: 12pt;"><a href="https://blog.csdn.net/sbctsp/article/details/50471278" style="font-size: 12pt;">https://blog.csdn.net/sbctsp/article/details/50471278</a></span></div></span>
</div></body></html> 
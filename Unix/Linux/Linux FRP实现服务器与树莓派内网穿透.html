<html>
<head>
  <title>Linux FRP实现服务器与树莓派内网穿透</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="574"/>
<h1>Linux FRP实现服务器与树莓派内网穿透</h1>

<div>
<span><div><div><font style="font-size: 14pt;">树莓派工作在局域网，通过路由器访问Internet，此处路由器没有公网IP，需要从外网访问内网的树莓派，可以通过具体有公网IP的服务器，服务器可以使用阿里云，腾讯，华为等的服务器，需要付费，有点是提供公网IP，也不贵。</font></div><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;">为了实现服务器到树莓派的映射，需要使用frp工具分别配置服务器和树莓派：</font></div><hr/><div><font style="font-size: 14pt;">首先是服务器，服务器架构是x86_64，frp工具下载地址：</font></div><div><font style="font-size: 14pt;">wget <a href="https://github.com/fatedier/frp/releases/download/v0.29.1/frp_0.29.1_linux_amd64.tar.gz">https://github.com/fatedier/frp/releases/download/v0.29.1/frp_0.29.1_linux_amd64.tar.gz</a></font></div><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;">解压后进入目录，有如下文件：</font></div><div><font style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image.png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;">服务器端会使用到frps程序和frps.ini配置文件</font></div><div><span style="font-size: 14pt;">配置文件frps.ini的配置如下：</span></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [1].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;">表示服务其监听本机的8888端口，开启服务器服务：</span></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [2].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;">&amp;表示后台运行，但是标准输出没有被重定向，依然会打印到屏幕，获得终端控制权，可以看到服务器监听本就的8888端口</span></div><div><span style="font-size: 14pt;">使用netstat -tnlp命令查看服务器tcp端口的开启情况：</span></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [3].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;">可以看到8888号端口开启，接下来服务器监听本地8888端口，等待来自frp客户端的连接</span></div><hr/><div><span style="font-size: 14pt;">接下来是树莓派（相当于客户端）的配置：</span></div><div><span style="font-size: 14pt;">树莓派是arm架构，指令集不一样，frp下载地址：</span></div><div><span style="font-size: 14pt;">wget <a href="https://github.com/fatedier/frp/releases/download/v0.29.1/frp_0.29.1_linux_arm.tar.gz">https://github.com/fatedier/frp/releases/download/v0.29.1/frp_0.29.1_linux_arm.tar.gz</a></span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 14pt;">解压后进入目录，客户端会使用到frp程序和frpc.ini配置文件，接下来对frpc.ini进行配置：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[common]</div><div>server_addr = xx.xx.xx.xx//服务器IP</div><div>server_port = 8888//服务器监听端口号</div><div><br/></div><div><br/></div><div>[ssh]</div><div>type = tcp//ssh是tcp协议</div><div>local_ip = 127.0.0.1//监听本机地址</div><div>local_port = 22//映射到本地的端口</div><div>remote_port = 6000//与服务器的8888端口建立连接后，服务器会开启tcp：6000端口并使其映射到树莓派的tcp：22端口上</div><div><br/></div><div>//同上只是为了多开几个端口</div><div>[tcp socket]</div><div>type = tcp</div><div>local_ip = 127.0.0.1</div><div>local_port = 6001</div><div>remote_port = 6001</div><div><br/></div><div><br/></div><div>[udp socket]</div><div>type = udp</div><div>local_ip = 127.0.0.1</div><div>local_port = 6002</div><div>remote_port = 6002</div></div><div><br/></div><div><font style="font-size: 14pt;">运行frp服务:</font></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [4].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;">可以看到树莓派开启ssh,tcp_socket和udp_socket端口成功，此时树莓派的tcp:22,tcp:6001,upd:6002端口分别映射到服务器的tcp:6000,tcp:6001,upd:6002端口上，</span></div><div><span style="font-size: 14pt;">树莓派并不会开启6001和6002端口，只有在端口被使用时才会进行映射。</span></div><hr/><div><span style="font-size: 14pt;">连接后服务器的打印：</span></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [5].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 14pt;">服务器端口情况：</span></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [6].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;">服务器开启8888端口后收到来自树莓派的frp请求开启了tcp:6000,tcp:6001,udp:6002端口。</span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 14pt;">此时进行tcp或udp socket测试，树莓派作为服务器监听本机端口6001/6002时，外网客户端可以作为客户端连接至服务器公网ip+6001/6002端口再而映射到树莓派的6001/6002端口上，使用netstat命令可以看到树莓派开启6001/6002端口。</span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 14pt;">同样外网ssh访问树莓派有如下映射：服务器公网IP+6000端口-&gt;树莓派22端口。</span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 14pt;">最后有的服务器需要在控制台开放端口tcp:6000,tcp:6001,udp:6002</span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 14pt;">frp原理思考：树莓派处理局域网内，没有公网ip，服务器有公网IP，树莓派发送frp请求到服务器时，服务器只是开启了树莓派要求的端口，此时这些端口和树莓派并没有建立任何连接。当服务器tcp:6001端口收到来自客户端的数据时，是如何转发到树莓派的（树莓派没有公网IP，服务器又是如何访问树莓派的）？</span></div><div><span style="font-size: 14pt;">在服务器先开启frp服务后，树莓派跟着开启frp服务，此时树莓派和客户端的打印如下：</span></div><div><span style="font-size: 14pt;">raspberry：</span></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [7].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;">server：</span></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [8].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;">服务器端显示来自树莓派配置文件的三个端口开放，使用netstat可以看到端口开放了，其次，建立了一条来自树莓派连接到服务器的树莓派局域网所在的公网的一条udp连接</span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 14pt;">使用树莓派作为服务器监听6001tcp端口，客户端运行在其他位置，连接到服务器的6001端口，此时服务器会将数据转发到树莓派，看到服务器的frp打印：</span></div><div><span style="font-size: 14pt;"><img src="Linux FRP实现服务器与树莓派内网穿透_files/Image [9].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt;">服务器与树莓派之前建立的udp连接,通过对树莓派抓包测试，得出一下结论：</span></div><div><span style="font-size: 14pt;">1.树莓派frp配置文件中可配置多个端口，无论配置多少个tcp会udp端口，在连接到服务器时，服务器和树莓派之间，都只会建立一条通道，树莓派会随机使用一个tcp端口与服务器的8888端口建立TCP连接，这个端口使用netstat 不带任何参数可以看到。此后所有与服务器的数据交换都通过此端口来实现，即内网穿透的数据都</span><span style="font-size: 14pt; color: unset; font-family: unset;">通过服务器和此连接传递到树莓派，此端口的tcp不能被其他程序使用，而udp依然可以使用。因为udp是面向无连接的，为了实现服务器数据传输到树莓派，必须使用有连接的通道，因此服务器和树莓派建立的一定会是TCP连接</span></div><div><span style="font-size: 14pt; color: unset; font-family: unset;">2.树莓派frp配置文件开启多个端口（tcp/udp），虽然与服务器只有一条tcp通道，数据的传输也不会混乱，原因是服务器为树莓派的每一个连接都配置了一个端口（tcp/udp），到达此端口的数据会按照对应关系转发给树莓派，树莓派配置的UDP端口在服务器上依然为udp，而udp协议在此处的体现为客户端到服务器的udp传输为无连接传输，而数据一旦到达服务器，服务器会通过tcp传给树莓派上的udp服务器，此处数据数据交换是面向连接的</span></div><div><span style="font-size: 14pt; color: unset; font-family: unset;">3.经由服务器转发到树莓派的数据，无法得知其源地址。</span></div><div><span style="font-size: 14pt; color: unset; font-family: unset;">4.如上图的58.101.158.145:43864表示的是树莓派所在局域网的公网IP和端口号，建立连接的路径：</span></div><div><span style="font-size: 14pt; color: unset; font-family: unset;">树莓派随机TCP端口----路由器----路由器-----....-----公网路由器(</span><span style="font-size: 14pt; color: unset; font-family: unset;">58.101.158.145:43864) -----服务器(ip+tcp:8888)</span></div><div><span style="font-size: 14pt;"><br/></span></div><div><br/></div></div></span>
</div></body></html> 
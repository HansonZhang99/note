<html>
<head>
  <title>8.dns-example.c</title>
  <basefont face="Verdana" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Verdana;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="954"/>
<h1>8.dns-example.c</h1>

<div>
<span><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/*</div><div>  This example code shows how to use the high-level, low-level, and</div><div>  server-level interfaces of evdns.</div><div>  XXX It's pretty ugly and should probably be cleaned up.</div><div>*/</div><div><br/></div><div>#include &lt;event2/event-config.h&gt;</div><div><br/></div><div>/* Compatibility for possible missing IPv6 declarations */</div><div>#include &quot;../ipv6-internal.h&quot;</div><div><br/></div><div>#include &lt;sys/types.h&gt;</div><div>#ifdef EVENT__HAVE_UNISTD_H</div><div>#include &lt;unistd.h&gt;</div><div>#endif</div><div><br/></div><div>#ifdef _WIN32</div><div>#include &lt;winsock2.h&gt;</div><div>#include &lt;ws2tcpip.h&gt;</div><div>#include &lt;getopt.h&gt;</div><div>#else</div><div>#include &lt;sys/socket.h&gt;</div><div>#include &lt;netinet/in.h&gt;</div><div>#include &lt;arpa/inet.h&gt;</div><div>#endif</div><div><br/></div><div>#include &lt;event2/event.h&gt;</div><div>#include &lt;event2/dns.h&gt;</div><div>#include &lt;event2/dns_struct.h&gt;</div><div>#include &lt;event2/util.h&gt;</div><div><br/></div><div><br/></div><div>#ifdef EVENT__HAVE_NETINET_IN6_H</div><div>#include &lt;netinet/in6.h&gt;</div><div>#endif</div><div><br/></div><div>#include &lt;stdio.h&gt;</div><div>#include &lt;stdlib.h&gt;</div><div>#include &lt;string.h&gt;</div><div><br/></div><div>#define u32 ev_uint32_t</div><div>#define u8 ev_uint8_t</div><div><br/></div><div>static const char *debug_ntoa(u32 address)</div><div>{</div><div>    static char buf[32];</div><div>    u32 a = ntohl(address);</div><div>    evutil_snprintf(buf, sizeof(buf), &quot;%d.%d.%d.%d&quot;,</div><div>                    (int)(u8)((a&gt;&gt;24)&amp;0xff),</div><div>                    (int)(u8)((a&gt;&gt;16)&amp;0xff),</div><div>                    (int)(u8)((a&gt;&gt;8 )&amp;0xff),</div><div>                    (int)(u8)((a    )&amp;0xff));</div><div>    return buf;</div><div>}</div><div><br/></div><div><br/></div><div>static void main_callback(int result, char type, int count, int ttl,</div><div>              void *addrs, void *orig) {</div><div>    <font color="#328712">char *n = (char*)orig;</font></div><div>    int i;</div><div>    for (i = 0; i &lt; count; ++i) {</div><div>      <font color="#328712">  if (type == DNS_IPv4_A) {</font></div><div><font color="#328712">            printf(&quot;%s: %s\n&quot;, n, debug_ntoa(((u32*)addrs)[i]));</font></div><div><font color="#328712">        } else if (type == DNS_PTR) {</font></div><div><font color="#328712">            printf(&quot;%s: %s\n&quot;, n, ((char**)addrs)[i]);</font></div><div>        }</div><div>    }</div><div>    if (!count) {</div><div>        printf(&quot;%s: No answer (%d)\n&quot;, n, result);</div><div>    }</div><div>    fflush(stdout);</div><div>}</div><div><br/></div><div><br/></div><div>static void gai_callback(int err, struct evutil_addrinfo *ai, void *arg)</div><div>{</div><div>    <font color="#AD0000">const char *name = arg;</font></div><div>    int i;</div><div>    <font color="#AD0000">struct evutil_addrinfo *first_ai = ai;</font></div><div><br/></div><div><br/></div><div>    if (err) {</div><div>        printf(&quot;%s: %s\n&quot;, name, evutil_gai_strerror(err));</div><div>    }</div><div>    if (ai &amp;&amp; ai-&gt;ai_canonname)</div><div>        printf(&quot;    %s ==&gt; %s\n&quot;, name, ai-&gt;ai_canonname);</div><div>   <font color="#AD0000"> for (i=0; ai; ai = ai-&gt;ai_next, ++i) {</font></div><div>        char buf[128];</div><div>       <font color="#AD0000"> if (ai-&gt;ai_family == PF_INET) {</font></div><div><font color="#AD0000">            struct sockaddr_in *sin =</font></div><div><font color="#AD0000">                (struct sockaddr_in*)ai-&gt;ai_addr;</font></div><div><font color="#AD0000">            evutil_inet_ntop(AF_INET, &amp;sin-&gt;sin_addr, buf,</font></div><div><font color="#AD0000">                sizeof(buf));</font></div><div><font color="#AD0000">            printf(&quot;[%d] %s: %s\n&quot;,i,name,buf);</font></div><div><font color="#AD0000">        } else {</font></div><div><font color="#AD0000">            struct sockaddr_in6 *sin6 =</font></div><div><font color="#AD0000">                (struct sockaddr_in6*)ai-&gt;ai_addr;</font></div><div><font color="#AD0000">            evutil_inet_ntop(AF_INET6, &amp;sin6-&gt;sin6_addr, buf,</font></div><div><font color="#AD0000">                sizeof(buf));</font></div><div><font color="#AD0000">            printf(&quot;[%d] %s: %s\n&quot;,i,name,buf);</font></div><div>        }</div><div>    }</div><div><br/></div><div><br/></div><div>    if (first_ai)</div><div>        evutil_freeaddrinfo(first_ai);</div><div>}</div><div><br/></div><div><br/></div><div><font color="#4F009A">static void evdns_server_callback(struct evdns_server_request *req, void *data)</font></div><div>{<font color="#4F009A">/*一个DNS服务回调函数*/</font></div><div>    int i, r;</div><div>    (void)data;</div><div>    <font color="#A8A8A8">/* dummy; give 192.168.11.11 as an answer for all A questions,</font></div><div><font color="#A8A8A8">     *    give foo.bar.example.com as an answer for all PTR questions. */</font></div><div>   <font color="#4F009A"> for (i = 0; i &lt; req-&gt;nquestions; ++i) {//解析用户发起的DNS请求</font></div><div>       <font color="#4F009A"> u32 ans = htonl(0xc0a80b0bUL);//将ip地址192.168.11.11解析为网络字节序</font></div><div>        if (req-&gt;questions[i]-&gt;type == <font color="#4F009A">EVDNS_TYPE_A</font> &amp;&amp;</div><div>            req-&gt;questions[i]-&gt;dns_question_class == EVDNS_CLASS_INET) {</div><div>            printf(&quot; -- replying for %s (A)\n&quot;, req-&gt;questions[i]-&gt;name);</div><div>           <font style="color: rgb(79, 0, 154);"> r = evdns_server_request_add_a_reply(req, req-&gt;questions[i]-&gt;name,</font></div><div><font color="#4F009A">                                          1, &amp;ans, 10);//对于A记录，调用此函数，解析IPV4地址</font></div><div>            if (r&lt;0)</div><div>                printf(&quot;eeep, didn't work.\n&quot;);</div><div>        } else if (req-&gt;questions[i]-&gt;type == <font color="#4F009A">EVDNS_TYPE_PTR</font> &amp;&amp;</div><div>            req-&gt;questions[i]-&gt;dns_question_class == EVDNS_CLASS_INET) {</div><div>            printf(&quot; -- replying for %s (PTR)\n&quot;, req-&gt;questions[i]-&gt;name);</div><div>            <font color="#4F009A">r = evdns_server_request_add_ptr_reply(req, NULL, req-&gt;questions[i]-&gt;name,</font></div><div><font color="#4F009A">                                            &quot;foo.bar.example.com&quot;, 10);//对于PTR记录，调用此函数，解析处对应PTR字符串</font></div><div>            if (r&lt;0)</div><div>                printf(&quot;ugh, no luck&quot;);</div><div>        } else {</div><div>            printf(&quot; -- skipping %s [%d %d]\n&quot;, req-&gt;questions[i]-&gt;name,</div><div>                   req-&gt;questions[i]-&gt;type, req-&gt;questions[i]-&gt;dns_question_class);</div><div>        }</div><div>    }</div><div><br/></div><div><br/></div><div><font color="#4F009A">    r = evdns_server_request_respond(req, 0);</font></div><div>    if (r&lt;0)</div><div>        printf(&quot;eeek, couldn't send reply.\n&quot;);</div><div>}</div><div><br/></div><div><br/></div><div>static int verbose = 0;</div><div><br/></div><div><br/></div><div>static void logfn(int is_warn, const char *msg) {</div><div>    if (!is_warn &amp;&amp; !verbose)</div><div>        return;</div><div>    fprintf(stderr, &quot;%s: %s\n&quot;, is_warn?&quot;WARN&quot;:&quot;INFO&quot;, msg);</div><div>}</div><div><br/></div><div><br/></div><div>int main(int c, char **v) {</div><div>    struct options {</div><div>        int reverse;</div><div>        int use_getaddrinfo;</div><div>        int servertest;</div><div>        const char *resolv_conf;</div><div>        const char *ns;</div><div>    };</div><div>    struct options o;</div><div>    int opt;</div><div>    struct event_base *event_base = NULL;</div><div>    struct evdns_base *evdns_base = NULL;</div><div><br/></div><div><br/></div><div>    memset(&amp;o, 0, sizeof(o));</div><div><br/></div><div><br/></div><div>    if (c &lt; 2) {</div><div>        fprintf(stderr, &quot;syntax: %s [-x] [-v] [-c resolv.conf] [-s ns] hostname\n&quot;, v[0]);</div><div>        fprintf(stderr, &quot;syntax: %s [-T]\n&quot;, v[0]);</div><div>        return 1;</div><div>    }</div><div><br/></div><div><br/></div><div>    while ((opt = getopt(c, v, &quot;xvc:Ts:g&quot;)) != -1) {</div><div>        switch (opt) {</div><div>            case 'x': o.reverse = 1; break;</div><div>            case 'v': ++verbose; break;</div><div>            case 'g': o.use_getaddrinfo = 1; break;</div><div>            case 'T': o.servertest = 1; break;</div><div>            case 'c': o.resolv_conf = optarg; break;</div><div>            case 's': o.ns = optarg; break;</div><div>            default : fprintf(stderr, &quot;Unknown option %c\n&quot;, opt); break;</div><div>        }</div><div>    }</div><div><br/></div><div><br/></div><div>#ifdef _WIN32</div><div>    {</div><div>        WSADATA WSAData;</div><div>        WSAStartup(0x101, &amp;WSAData);</div><div>    }</div><div>#endif</div><div><br/></div><div><br/></div><div>    <font color="#FF0000">event_base = event_base_new();//创建一个event_base</font></div><div>   <font color="#FF0000"> evdns_base = evdns_base_new(event_base, EVDNS_BASE_DISABLE_WHEN_INACTIVE);//创建一个evdns_base</font></div><div>    evdns_set_log_fn(logfn);</div><div><br/></div><div><br/></div><div>   <font color="#41007D"> if (o.servertest) {//命令行选项-T如果被设置</font></div><div>        evutil_socket_t sock;</div><div>        struct sockaddr_in my_addr;</div><div>       <font color="#4F009A"> sock = socket(PF_INET, SOCK_DGRAM, 0);//创建udp套接字</font></div><div>        if (sock == -1) {</div><div>            perror(&quot;socket&quot;);</div><div>            exit(1);</div><div>        }</div><div>       <font color="#4F009A"> evutil_make_socket_nonblocking(sock);//设置非阻塞</font></div><div>        my_addr.sin_family = AF_INET;</div><div>        my_addr.sin_port = htons(10053);</div><div>        my_addr.sin_addr.s_addr = INADDR_ANY;</div><div>        if (<font color="#4F009A">bind(sock, (struct sockaddr*)&amp;my_addr, sizeof(my_addr))&lt;0</font>) {</div><div>            perror(&quot;bind&quot;);</div><div>            exit(1);</div><div>        }</div><div>        <font style="color: rgb(79, 0, 154);">evdns_add_server_port_with_base(event_base, sock, 0, evdns_server_callback, NULL);</font></div><div><font style="color: rgb(79, 0, 154);"><span>    </span><span>    /*创建一个DNS服务器，开始监听DNS请求，访问此服务器的任何一个ip的10053号端口，都会被认为请求DNS服务，收到一个DNS查询，会调用evdns_server_callback回调函数，传入NULL作为回调参数*/</span><br/></font></div><div>    }</div><div>    if (optind &lt; c) {</div><div>        int res;</div><div>#ifdef _WIN32</div><div>        if (o.resolv_conf == NULL &amp;&amp; !o.ns)</div><div>            res = evdns_base_config_windows_nameservers(evdns_base);</div><div>        else</div><div>#endif</div><div>       <font color="#328712"> if (o.ns)//命令行设置-s选项</font></div><div>            <font style="color: rgb(50, 135, 18);">res = evdns_base_nameserver_ip_add(evdns_base, o.ns);//加入ns字符串(应为某域名服务器地址）到evdns_base</font></div><div>    <font color="#328712">    else//如果不设置-s选项，则扫描配置文件进行解析</font></div><div>           <font style="color: rgb(50, 135, 18);"> res = evdns_base_resolv_conf_parse(evdns_base,</font></div><div><font color="#328712">                DNS_OPTION_NAMESERVERS, o.resolv_conf);</font></div><div><br/></div><div><br/></div><div>        if (res &lt; 0) {</div><div>            fprintf(stderr, &quot;Couldn't configure nameservers&quot;);</div><div>            return 1;</div><div>        }</div><div>    }</div><div><br/></div><div><br/></div><div>    printf(&quot;EVUTIL_AI_CANONNAME in example = %d\n&quot;, EVUTIL_AI_CANONNAME);</div><div>    for (; optind &lt; c; ++optind) {</div><div>       <font color="#328712"> if (o.reverse) {//命令行选项-x被选择</font></div><div>            struct in_addr addr;</div><div>           <font color="#328712"> if (evutil_inet_pton(AF_INET, v[optind], &amp;addr)!=1) {//传入需要解析的ip地址</font></div><div>                fprintf(stderr, &quot;Skipping non-IP %s\n&quot;, v[optind]);</div><div>                continue;</div><div>            }</div><div>            fprintf(stderr, &quot;resolving %s...\n&quot;,v[optind]);</div><div>            <font color="#328712">evdns_base_resolve_reverse(evdns_base, &amp;addr, 0, main_callback, v[optind]);//将传入的ip地址解析为域名</font></div><div>        } <font color="#AD0000">else if (o.use_getaddrinfo) {//命令行设置-g选项</font></div><div>            struct evutil_addrinfo hints;</div><div>            memset(&amp;hints, 0, sizeof(hints));</div><div>            hints.ai_family = PF_UNSPEC;</div><div>            hints.ai_protocol = IPPROTO_TCP;</div><div>            hints.ai_flags = EVUTIL_AI_CANONNAME;</div><div>            fprintf(stderr, &quot;resolving (fwd) %s...\n&quot;,v[optind]);</div><div>          <font color="#7B003D"> </font><font color="#AD0000"> evdns_getaddrinfo(evdns_base, v[optind], NULL, &amp;hints,</font></div><div><font color="#AD0000">                gai_callback, v[optind]);//将传入的域名解析为ip地址</font></div><div>        } <font color="#328712">else {//如果两项都不选个，则默认将传如的域名解析为ipv4地址</font></div><div><font color="#328712">          </font>  fprintf(stderr, &quot;resolving (fwd) %s...\n&quot;,v[optind]);</div><div>           <font color="#328712"> evdns_base_resolve_ipv4(evdns_base, v[optind], 0, main_callback, v[optind]);</font></div><div>        }</div><div>    }</div><div>    fflush(stdout);</div><div>    event_base_dispatch(event_base);</div><div>    evdns_base_free(evdns_base, 1);</div><div>    event_base_free(event_base);</div><div>    return 0;</div><div>}</div></div><div><br/></div><div><br/></div><div>所以这个程序大致分为三块：</div><div><br/></div><div>第一块对应命令行参数&quot;T&quot;，如果选择了此参数，将会创建一个DNS服务器，由于该服务器并没有建立域名和IP地址的映射，这一采用两个简单的对应来模仿一个真正的DNS服务器，用户发送DNS请求到此服务器，回调函数会被调用，函数对域名进行解析成对应ip，并将解析结果送回给用户。</div><div><br/></div><div>第二块与命令行参数&quot;s&quot;和&quot;c&quot;对应，如果选择参数s，就不要选c，s后紧跟域名服务器地址，c后则指定一个DNS的配置文件。</div><div><br/></div><div>第三块是接着第二块的，选择命令行参数x，将其后命令行参数中的ip转换成对应的域名，命令行参数g,将其后命令行参数中的域名转换成对应ip地址。</div><div>如果这两个参数都不选，而直接跟需要解析的域名，则直接将域名解析为ipv4地址。</div><div><br/></div><div>接下来是一系列的测试：</div><div><br/></div><div>域名服务器：4.2.2.2，需要解析的ip地址：127.0.0.1</div><div><img src="8.dns-example.c_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>域名服务器：4.2.2.2,需要解析的域名：<a href="http://www.baidu.com/">www.baidu.com</a> <a href="http://www.sohu.com/">www.sohu.com</a> <a href="http://www.tencent.com/">www.tencent.com</a></div><div><img src="8.dns-example.c_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>域名服务器：114.114.114.114，需要解析的域名：<a href="http://www.baidu.com/">www.baidu.com</a> <a href="http://www.sohu.com/">www.sohu.com</a> <a href="http://www.tencent.com/">www.tencent.com</a></div><div><img src="8.dns-example.c_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>配置文件/etc/resolv.conf</div><div><img src="8.dns-example.c_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>同上解析：</div><div><img src="8.dns-example.c_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><img src="8.dns-example.c_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>最后不跟s和g参数：</div><div><img src="8.dns-example.c_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div>默认只解析为ipv4，没有ipv6地址</div></span>
</div></body></html> 